!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).firebase,t.firebase.INTERNAL.modularAPIs)}(this,function(Yd,Xd){"use strict";try{!(function(){function t(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var e=t(Yd);function n(e){const n=[];let r=0;for(let s=0;s<e.length;s++){let t=e.charCodeAt(s);t<128?n[r++]=t:(t<2048?n[r++]=t>>6|192:(55296==(64512&t)&&s+1<e.length&&56320==(64512&e.charCodeAt(s+1))?(t=65536+((1023&t)<<10)+(1023&e.charCodeAt(++s)),n[r++]=t>>18|240,n[r++]=t>>12&63|128):n[r++]=t>>12|224,n[r++]=t>>6&63|128),n[r++]=63&t|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,t){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=t?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let u=0;u<n.length;u+=3){var i=n[u],o=u+1<n.length,a=o?n[u+1]:0,h=u+2<n.length,c=h?n[u+2]:0;let t=(15&a)<<2|c>>6,e=63&c;h||(e=64,o||(t=64)),s.push(r[i>>2],r[(3&i)<<4|a>>4],r[t],r[e])}return s.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(n(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,r=0;for(;n<t.length;){var s,i,o=t[n++];o<128?e[r++]=String.fromCharCode(o):191<o&&o<224?(s=t[n++],e[r++]=String.fromCharCode((31&o)<<6|63&s)):239<o&&o<365?(i=((7&o)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536,e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))):(s=t[n++],i=t[n++],e[r++]=String.fromCharCode((15&o)<<12|(63&s)<<6|63&i))}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let h=0;h<t.length;){var s=n[t.charAt(h++)],i=h<t.length?n[t.charAt(h)]:0;++h;var o=h<t.length?n[t.charAt(h)]:64;++h;var a=h<t.length?n[t.charAt(h)]:64;if(++h,null==s||null==i||null==o||null==a)throw Error();r.push(s<<2|i>>4),64!==o&&(r.push(i<<4&240|o>>2),64!==a&&r.push(o<<6&192|a))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},o=function(t){return t=t,e=n(t),r.encodeByteArray(e,!0).replace(/\./g,"");var e};function d(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function m(t){return t&&t._delegate?t._delegate:t}var l,i=(a.prototype.setInstantiationMode=function(t){return this.instantiationMode=t,this},a.prototype.setMultipleInstances=function(t){return this.multipleInstances=t,this},a.prototype.setServiceProps=function(t){return this.serviceProps=t,this},a.prototype.setInstanceCreatedCallback=function(t){return this.onInstanceCreated=t,this},a);function a(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}(el=l=l||{})[el.DEBUG=0]="DEBUG",el[el.VERBOSE=1]="VERBOSE",el[el.INFO=2]="INFO",el[el.WARN=3]="WARN",el[el.ERROR=4]="ERROR",el[el.SILENT=5]="SILENT";const h={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},c=l.INFO,u={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},f=(t,e,...n)=>{if(!(e<t.logLevel)){var r=(new Date).toISOString(),s=u[e];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[s](`[${r}]  ${t.name}:`,...n)}};var g,p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},y={},v=p||self;function w(){}function b(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function E(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var T="closure_uid_"+(1e9*Math.random()>>>0),I=0;function _(t,e,n){return t.call.apply(t.bind,arguments)}function S(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function N(t,e,n){return(N=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?_:S).apply(null,arguments)}function A(e){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function D(t,i){function e(){}e.prototype=i.prototype,t.Z=i.prototype,t.prototype=new e,(t.prototype.constructor=t).Vb=function(t,e,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[e].apply(t,r)}}function C(){this.s=this.s,this.o=this.o}var x={};C.prototype.s=!1,C.prototype.na=function(){var t,e;!this.s&&(this.s=!0,this.M(),0)&&(e=this,t=Object.prototype.hasOwnProperty.call(e,T)&&e[T]||(e[T]=++I),delete x[t])},C.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const k=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},R=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){var r=t.length,s="string"==typeof t?t.split(""):t;for(let i=0;i<r;i++)i in s&&e.call(n,s[i],i,t)};function L(){return Array.prototype.concat.apply([],arguments)}function O(e){var n=e.length;if(0<n){const r=Array(n);for(let t=0;t<n;t++)r[t]=e[t];return r}return[]}function M(t){return/^[\s\xa0]*$/.test(t)}var F,P=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function V(t,e){return-1!=t.indexOf(e)}function U(t,e){return t<e?-1:e<t?1:0}t:{var q=v.navigator;if(q){q=q.userAgent;if(q){F=q;break t}}F=""}function B(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function j(t){const e={};for(const n in t)e[n]=t[n];return e}var K="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function $(e){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])e[n]=r[n];for(let t=0;t<K.length;t++)n=K[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function G(t){return G[" "](t),t}G[" "]=w;var H,z=V(F,"Opera"),Q=V(F,"Trident")||V(F,"MSIE"),W=V(F,"Edge"),Y=W||Q,X=V(F,"Gecko")&&!(V(F.toLowerCase(),"webkit")&&!V(F,"Edge"))&&!(V(F,"Trident")||V(F,"MSIE"))&&!V(F,"Edge"),J=V(F.toLowerCase(),"webkit")&&!V(F,"Edge");function Z(){var t=v.document;return t?t.documentMode:void 0}t:{var tt="",et=(et=F,X?/rv:([^\);]+)(\)|;)/.exec(et):W?/Edge\/([\d\.]+)/.exec(et):Q?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(et):J?/WebKit\/(\S+)/.exec(et):z?/(?:Version)[ \/]?(\S+)/.exec(et):void 0);if(et&&(tt=et?et[1]:""),Q){et=Z();if(null!=et&&et>parseFloat(tt)){H=String(et);break t}}H=tt}var nt={};function rt(){return t=function(){let t=0;var e=P(String(H)).split("."),n=P("9").split("."),r=Math.max(e.length,n.length);for(let o=0;0==t&&o<r;o++)for(var s=e[o]||"",i=n[o]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(t=U(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||U(0==s[2].length,0==i[2].length)||U(s[2],i[2]),s=s[3],i=i[3],0==t););return 0<=t},e=nt,Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9);var t,e}var st=v.document&&Q&&(Z()||parseInt(H,10))||void 0,it=function(){if(!v.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{v.addEventListener("test",w,e),v.removeEventListener("test",w,e)}catch(t){}return t}();function ot(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function at(t,e){if(ot.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(X){t:{try{G(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:ht[t.pointerType]||"",this.state=t.state,(this.i=t).defaultPrevented&&at.Z.h.call(this)}}ot.prototype.h=function(){this.defaultPrevented=!0},D(at,ot);var ht={2:"touch",3:"pen",4:"mouse"};at.prototype.h=function(){at.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ct="closure_listenable_"+(1e6*Math.random()|0),ut=0;function lt(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ia=s,this.key=++ut,this.ca=this.fa=!1}function dt(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ft(t){this.src=t,this.g={},this.h=0}function gt(t,e){var n,r,s,i=e.type;i in t.g&&(n=t.g[i],(s=0<=(r=k(n,e)))&&Array.prototype.splice.call(n,r,1),s&&(dt(e),0==t.g[i].length&&(delete t.g[i],t.h--)))}function mt(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==r)return s}return-1}ft.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=mt(t,e,r,s);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new lt(e,this.src,i,!!r,s)).fa=n,t.push(e)),e};var pt="closure_lm_"+(1e6*Math.random()|0),yt={};function vt(t,e,n,r,s){if(r&&r.once)return function t(e,n,r,s,i){if(Array.isArray(n)){for(var o=0;o<n.length;o++)t(e,n[o],r,s,i);return null}r=St(r);return e&&e[ct]?e.O(n,r,E(s)?!!s.capture:!!s,i):wt(e,n,r,!0,s,i)}(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)vt(t,e[i],n,r,s);return null}return n=St(n),t&&t[ct]?t.N(e,n,E(r)?!!r.capture:!!r,s):wt(t,e,n,!1,r,s)}function wt(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o,a=E(s)?!!s.capture:!!s,h=It(t);if(h||(t[pt]=h=new ft(t)),(n=h.add(e,n,r,a,i)).proxy)return n;if(o=Tt,r=function t(e){return o.call(t.src,t.listener,e)},(n.proxy=r).src=t,r.listener=n,t.addEventListener)void 0===(s=!it?a:s)&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(Et(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function bt(t){var e,n,r;"number"!=typeof t&&t&&!t.ca&&((e=t.src)&&e[ct]?gt(e.i,t):(n=t.type,r=t.proxy,e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Et(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=It(e))?(gt(n,t),0==n.h&&(n.src=null,e[pt]=null)):dt(t)))}function Et(t){return t in yt?yt[t]:yt[t]="on"+t}function Tt(t,e){var n,r;return t=!!t.ca||(e=new at(e,this),n=t.listener,r=t.ia||t.src,t.fa&&bt(t),n.call(r,e))}function It(t){return(t=t[pt])instanceof ft?t:null}var _t="__closure_events_fn_"+(1e9*Math.random()>>>0);function St(e){return"function"==typeof e?e:(e[_t]||(e[_t]=function(t){return e.handleEvent(t)}),e[_t])}function Nt(){C.call(this),this.i=new ft(this),(this.P=this).I=null}function At(t,e){var n,r=t.I;if(r)for(n=[];r;r=r.I)n.push(r);if(t=t.P,r=e.type||e,"string"==typeof e?e=new ot(e,t):e instanceof ot?e.target=e.target||t:(o=e,$(e=new ot(r,t),o)),o=!0,n)for(var s=n.length-1;0<=s;s--)var i=e.g=n[s],o=Dt(i,r,!0,e)&&o;if(o=Dt(i=e.g=t,r,!0,e)&&o,o=Dt(i,r,!1,e)&&o,n)for(s=0;s<n.length;s++)o=Dt(i=e.g=n[s],r,!1,e)&&o}function Dt(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o,a,h=e[i];h&&!h.ca&&h.capture==n&&(o=h.listener,a=h.ia||h.src,h.fa&&gt(t.i,h),s=!1!==o.call(a,r)&&s)}return s&&!r.defaultPrevented}D(Nt,C),Nt.prototype[ct]=!0,Nt.prototype.removeEventListener=function(t,e,n,r){!function t(e,n,r,s,i){if(Array.isArray(n))for(var o=0;o<n.length;o++)t(e,n[o],r,s,i);else s=E(s)?!!s.capture:!!s,r=St(r),e&&e[ct]?(e=e.i,(n=String(n).toString())in e.g&&-1<(r=mt(o=e.g[n],r,s,i))&&(dt(o[r]),Array.prototype.splice.call(o,r,1),0==o.length&&(delete e.g[n],e.h--))):(e=e&&It(e))&&(n=e.g[n.toString()],(r=(e=-1)<(e=n?mt(n,r,s,i):e)?n[e]:null)&&bt(r))}(this,t,e,n,r)},Nt.prototype.M=function(){if(Nt.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)dt(n[r]);delete e.g[t],e.h--}}this.I=null},Nt.prototype.N=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},Nt.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var Ct=v.JSON.stringify;var xt,kt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}(()=>new Rt,t=>t.reset());class Rt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Lt(t,e){var n;xt||(n=v.Promise.resolve(void 0),xt=function(){n.then(Ft)}),Ot||(xt(),Ot=!0),Mt.add(t,e)}var Ot=!1,Mt=new class{constructor(){this.h=this.g=null}add(t,e){const n=kt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ft(){for(var t;t=function(){var t=Mt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}();){try{t.h.call(t.g)}catch(t){!function(t){v.setTimeout(()=>{throw t},0)}(t)}var e=kt;e.j(t),e.h<100&&(e.h++,t.next=e.g,e.g=t)}Ot=!1}function Pt(t,e){Nt.call(this),this.h=t||1,this.g=e||v,this.j=N(this.kb,this),this.l=Date.now()}function Vt(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Ut(t,e,n){if("function"==typeof t)n&&(t=N(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=N(t.handleEvent,t)}return 2147483647<Number(e)?-1:v.setTimeout(t,e||0)}D(Pt,Nt),(g=Pt.prototype).da=!1,g.S=null,g.kb=function(){var t;this.da&&(0<(t=Date.now()-this.l)&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),At(this,"tick"),this.da&&(Vt(this),this.start())))},g.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},g.M=function(){Pt.Z.M.call(this),Vt(this),delete this.g};class qt extends C{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:function t(e){e.g=Ut(()=>{e.g=null,e.i&&(e.i=!1,t(e))},e.j);var n=e.h;e.h=null,e.m.apply(null,n)}(this)}M(){super.M(),this.g&&(v.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Bt(t){C.call(this),this.h=t,this.g={}}D(Bt,C);var jt=[];function Kt(t,e,n,r){Array.isArray(n)||(n&&(jt[0]=n.toString()),n=jt);for(var s=0;s<n.length;s++){var i=vt(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function $t(t){B(t.g,function(t,e){this.g.hasOwnProperty(e)&&bt(t)},t),t.g={}}function Gt(){this.g=!0}function Ht(t,e,n,r){t.info(function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return Ct(n)}catch(t){return e}}(t,n)+(r?" "+r:"")})}Bt.prototype.M=function(){Bt.Z.M.call(this),$t(this)},Bt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Gt.prototype.Aa=function(){this.g=!1},Gt.prototype.info=function(){};var zt={},Qt=null;function Wt(){return Qt=Qt||new Nt}function Yt(t){ot.call(this,zt.Ma,t)}function Xt(){var t=Wt();At(t,new Yt(t))}function Jt(t,e){ot.call(this,zt.STAT_EVENT,t),this.stat=e}function Zt(t){var e=Wt();At(e,new Jt(e,t))}function te(t,e){ot.call(this,zt.Na,t),this.size=e}function ee(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return v.setTimeout(function(){t()},e)}zt.Ma="serverreachability",D(Yt,ot),zt.STAT_EVENT="statevent",D(Jt,ot),zt.Na="timingevent",D(te,ot);var ne={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},re={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function se(){}function ie(t){return t.h||(t.h=t.i())}function oe(){}se.prototype.h=null;p={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ae(){ot.call(this,"d")}function he(){ot.call(this,"c")}function ce(){}function ue(t,e,n,r){this.l=t,this.j=e,this.m=n,this.X=r||1,this.V=new Bt(this),this.P=fe,this.W=new Pt(t=Y?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new le}function le(){this.i=null,this.g="",this.h=!1}D(ae,ot),D(he,ot),D(ce,se),ce.prototype.g=function(){return new XMLHttpRequest},ce.prototype.i=function(){return{}};var de=new ce,fe=45e3,ge={},me={};function pe(t,e,n){t.K=1,t.v=Ve(Re(e)),t.s=n,t.U=!0,ye(t,null)}function ye(t,e){t.F=Date.now(),be(t),t.A=Re(t.v);var o,a,h,c,u,l,n=t.A,r=t.X;Array.isArray(r)||(r=[String(r)]),Xe(n.h,"t",r),t.C=0,n=t.l.H,t.h=new le,t.g=Jn(t.l,n?e:null,!t.s),0<t.O&&(t.L=new qt(N(t.Ia,t,t.g),t.O)),Kt(t.V,t.g,"readystatechange",t.gb),e=t.H?j(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Xt(),o=t.j,a=t.u,h=t.A,c=t.m,u=t.X,l=t.s,o.info(function(){if(o.g)if(l)for(var t="",e=l.split("&"),n=0;n<e.length;n++){var r,s,i=e[n].split("=");1<i.length&&(r=i[0],i=i[1],t=2<=(s=r.split("_")).length&&"type"==s[1]?t+(r+"=")+i+"&":t+(r+"=redacted&"))}else t=null;else t=l;return"XMLHTTP REQ ("+c+") [attempt "+u+"]: "+a+"\n"+h+"\n"+t})}function ve(t){return t.g&&("GET"==t.u&&2!=t.K&&t.l.Ba)}function we(t,e,n){let r=!0,s;for(;!t.I&&t.C<n.length;){if(s=(o=n,h=a=void 0,a=(i=t).C,-1==(h=o.indexOf("\n",a))?me:(a=Number(o.substring(a,h)),isNaN(a)?ge:(h+=1)+a>o.length?me:(o=o.substr(h,a),i.C=h+a,o))),s==me){4==e&&(t.o=4,Zt(14),r=!1),Ht(t.j,t.m,null,"[Incomplete Response]");break}if(s==ge){t.o=4,Zt(15),Ht(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Ht(t.j,t.m,s,null),Se(t,s)}var i,o,a,h;ve(t)&&s!=me&&s!=ge&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,Zt(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),$n(e),e.L=!0,Zt(11))):(Ht(t.j,t.m,n,"[Invalid Chunked Response]"),_e(t),Ie(t))}function be(t){t.Y=Date.now()+t.P,Ee(t,t.P)}function Ee(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=ee(N(t.eb,t),e)}function Te(t){t.B&&(v.clearTimeout(t.B),t.B=null)}function Ie(t){0==t.l.G||t.I||zn(t.l,t)}function _e(t){Te(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Vt(t.W),$t(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Se(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||sn(n.i,t)))if(n.I=t.N,!t.J&&sn(n.i,t)&&3==n.G){try{var r=n.Ca.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Hn(n),Mn(n)}Kn(n),Zt(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=ee(N(n.ab,n),6e3));if(rn(n.i)<=1&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Wn(n,11)}else if(!t.J&&n.g!=t||Hn(n),!M(e))for(s=n.Ca.g.parse(e),e=0;e<s.length;e++){var i=s[e];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var o=i[3];null!=o&&(n.ma=o,n.h.info("VER="+n.ma));var a=i[4];null!=a&&(n.za=a,n.h.info("SVER="+n.za));var h,c,u,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=t.g;m&&(!(h=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(c=r.i).g&&(V(h,"spdy")||V(h,"quic")||V(h,"h2"))&&(c.j=c.l,c.g=new Set,c.h&&(on(c,c.h),c.h=null)),!r.D||(u=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=u,Pe(r.F,r.D,u))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=t;(r=n).oa=Xn(r,r.H?r.la:null,r.W),g.J?(an(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(Te(d),be(d)),r.g=g):jn(r),0<n.l.length&&Vn(n)}else"stop"!=i[0]&&"close"!=i[0]||Wn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Wn(n,7):On(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Xt()}catch(t){}}function Ne(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(b(t)||"string"==typeof t)R(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(b(t)||"string"==typeof t)for(var n=[],r=t.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,t)n[r++]=s;for(var s=(r=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(b(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}}function Ae(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Ae)for(n=t.T(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function De(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var r=t.g[e];Ce(t.h,r)&&(t.g[n++]=r),e++}t.g.length=n}if(t.i!=t.g.length){for(var s={},n=e=0;e<t.g.length;)Ce(s,r=t.g[e])||(s[t.g[n++]=r]=1),e++;t.g.length=n}}function Ce(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(g=ue.prototype).setTimeout=function(t){this.P=t},g.gb=function(t){t=t.target;const e=this.L;e&&3==Cn(t)?e.l():this.Ia(t)},g.Ia=function(t){try{if(t==this.g)t:{var e=Cn(this.g),n=this.g.Da();this.g.ba();if(!(e<3)&&(3!=e||Y||this.g&&(this.h.h||this.g.ga()||xn(this.g)))){this.I||4!=e||7==n||Xt(),Te(this);var r=this.g.ba();this.N=r;e:if(ve(this)){var s=xn(this.g);t="";var i=s.length,o=4==Cn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){_e(this),Ie(this);var a="";break e}this.h.i=new v.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,t+=this.h.i.decode(s[n],{stream:o&&n==i-1});s.splice(0,i),this.h.g+=t,this.C=0,a=this.h.g}else a=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=e,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){e:{if(this.g){var h,c=this.g;if((h=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!M(h)){var u=h;break e}}u=null}if(!(r=u)){this.i=!1,this.o=3,Zt(12),_e(this),Ie(this);break t}Ht(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Se(this,r)}this.U?(we(this,e,a),Y&&this.i&&3==e&&(Kt(this.V,this.W,"tick",this.fb),this.W.start())):(Ht(this.j,this.m,a,null),Se(this,a)),4==e&&_e(this),this.i&&!this.I&&(4==e?zn(this.l,this):(this.i=!1,be(this)))}else 400==r&&0<a.indexOf("Unknown SID")?(this.o=3,Zt(12)):(this.o=0,Zt(13)),_e(this),Ie(this)}}}catch(t){}var l,d,f,g,m,p,y},g.fb=function(){var t,e;this.g&&(t=Cn(this.g),e=this.g.ga(),this.C<e.length&&(Te(this),we(this,t,e),this.i&&4!=t&&be(this)))},g.cancel=function(){this.I=!0,_e(this)},g.eb=function(){this.B=null;var t,e,n=Date.now();0<=n-this.Y?(t=this.j,e=this.A,t.info(function(){return"TIMEOUT: "+e}),2!=this.K&&(Xt(),Zt(17)),_e(this),this.o=2,Ie(this)):Ee(this,this.Y-n)},(g=Ae.prototype).R=function(){De(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},g.T=function(){return De(this),this.g.concat()},g.get=function(t,e){return Ce(this.h,t)?this.h[t]:e},g.set=function(t,e){Ce(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},g.forEach=function(t,e){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);t.call(e,i,s,this)}};var xe=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function ke(t,e){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof ke?(this.g=void 0!==e?e:t.g,Le(this,t.j),this.s=t.s,Oe(this,t.i),Me(this,t.m),this.l=t.l,e=t.h,(n=new ze).i=e.i,e.g&&(n.g=new Ae(e.g),n.h=e.h),Fe(this,n),this.o=t.o):t&&(n=String(t).match(xe))?(this.g=!!e,Le(this,n[1]||"",!0),this.s=Ue(n[2]||""),Oe(this,n[3]||"",!0),Me(this,n[4]),this.l=Ue(n[5]||"",!0),Fe(this,n[6]||"",!0),this.o=Ue(n[7]||"")):(this.g=!!e,this.h=new ze(null,this.g))}function Re(t){return new ke(t)}function Le(t,e,n){t.j=n?Ue(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Oe(t,e,n){t.i=n?Ue(e,!0):e}function Me(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Fe(t,e,n){var r,s;e instanceof ze?(t.h=e,r=t.h,(s=t.g)&&!r.j&&(Qe(r),r.i=null,r.g.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(We(this,e),Xe(this,n,t))},r)),r.j=s):(n||(e=qe(e,Ge)),t.h=new ze(e,t.g))}function Pe(t,e,n){t.h.set(e,n)}function Ve(t){return Pe(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Ue(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function qe(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,Be),t=n?t.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):t):null}function Be(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}ke.prototype.toString=function(){var t=[],e=this.j;e&&t.push(qe(e,je,!0),":");var n=this.i;return!n&&"file"!=e||(t.push("//"),(e=this.s)&&t.push(qe(e,je,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(qe(n,"/"==n.charAt(0)?$e:Ke,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",qe(n,He)),t.join("")};var je=/[#\/\?@]/g,Ke=/[#\?:]/g,$e=/[#\?]/g,Ge=/[#\?@]/g,He=/#/g;function ze(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Qe(n){n.g||(n.g=new Ae,n.h=0,n.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],e(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}function We(t,e){Qe(t),e=Je(t,e),Ce(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Ce((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&De(t)))}function Ye(t,e){return Qe(t),e=Je(t,e),Ce(t.g.h,e)}function Xe(t,e,n){We(t,e),0<n.length&&(t.i=null,t.g.set(Je(t,e),O(n)),t.h+=n.length)}function Je(t,e){return e=String(e),e=t.j?e.toLowerCase():e}(g=ze.prototype).add=function(t,e){Qe(this),this.i=null,t=Je(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},g.forEach=function(n,r){Qe(this),this.g.forEach(function(t,e){R(t,function(t){n.call(r,t,e,this)},this)},this)},g.T=function(){Qe(this);for(var t=this.g.R(),e=this.g.T(),n=[],r=0;r<e.length;r++)for(var s=t[r],i=0;i<s.length;i++)n.push(e[r]);return n},g.R=function(t){Qe(this);var e=[];if("string"==typeof t)Ye(this,t)&&(e=L(e,this.g.get(Je(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=L(e,t[n])}return e},g.set=function(t,e){return Qe(this),this.i=null,Ye(this,t=Je(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},g.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},g.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++)for(var r=e[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var o=s;""!==r[i]&&(o+="="+encodeURIComponent(String(r[i]))),t.push(o)}return this.i=t.join("&")};var Ze=class{constructor(t,e){this.h=t,this.g=e}};function tn(t){this.l=t||10,t=v.PerformanceNavigationTiming?0<(t=v.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(v.g&&v.g.Ea&&v.g.Ea()&&v.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var en;function nn(t){return t.h||t.g&&t.g.size>=t.j}function rn(t){return t.h?1:t.g?t.g.size:0}function sn(t,e){return t.h?t.h==e:t.g&&t.g.has(e)}function on(t,e){t.g?t.g.add(e):t.h=e}function an(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function hn(e){if(null!=e.h)return e.i.concat(e.h.D);if(null==e.g||0===e.g.size)return O(e.i);{let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}}function cn(){}function un(){this.g=new cn}function ln(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function dn(t){this.l=t.$b||null,this.j=t.ib||!1}function fn(t,e){Nt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=gn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}tn.prototype.cancel=function(){if(this.i=hn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},cn.prototype.stringify=function(t){return v.JSON.stringify(t,void 0)},cn.prototype.parse=function(t){return v.JSON.parse(t,void 0)},D(dn,se),dn.prototype.g=function(){return new fn(this.l,this.j)},dn.prototype.i=(en={},function(){return en}),D(fn,Nt);var gn=0;function mn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function pn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,yn(t)}function yn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(g=fn.prototype).open=function(t,e){if(this.readyState!=gn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,yn(this)},g.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||v).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},g.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,pn(this)),this.readyState=gn},g.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,yn(this)),this.g&&(this.readyState=3,yn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==v.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;mn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},g.Sa=function(t){var e;this.g&&(this.u&&t.value?this.response.push(t.value):this.u||(e=t.value||new Uint8Array(0),(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)),(t.done?pn:yn)(this),3==this.readyState&&mn(this))},g.Ua=function(t){this.g&&(this.response=this.responseText=t,pn(this))},g.Ta=function(t){this.g&&(this.response=t,pn(this))},g.ha=function(){this.g&&pn(this)},g.setRequestHeader=function(t,e){this.v.append(t,e)},g.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},g.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(fn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var vn=v.JSON.parse;function wn(t){Nt.call(this),this.headers=new Ae,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=bn,this.K=this.L=!1}D(wn,Nt);var bn="",En=/^https?$/i,Tn=["POST","PUT"];function In(t){return"content-type"==t.toLowerCase()}function _n(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Sn(t),An(t)}function Sn(t){t.D||(t.D=!0,At(t,"complete"),At(t,"error"))}function Nn(t){if(t.h&&void 0!==y&&(!t.C[1]||4!=Cn(t)||2!=t.ba()))if(t.v&&4==Cn(t))Ut(t.Fa,0,t);else if(At(t,"readystatechange"),4==Cn(t)){t.h=!1;try{var e,n,r,s,i=t.ba();t:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break t;default:o=!1}if((e=o)||((n=0===i)&&(!(s=String(t.H).match(xe)[1]||null)&&v.self&&v.self.location&&(s=(r=v.self.location.protocol).substr(0,r.length-1)),n=!En.test(s?s.toLowerCase():"")),e=n),e)At(t,"complete"),At(t,"success");else{t.m=6;try{var a=2<Cn(t)?t.g.statusText:""}catch(t){a=""}t.j=a+" ["+t.ba()+"]",Sn(t)}}finally{An(t)}}}function An(t,e){if(t.g){Dn(t);const n=t.g,r=t.C[0]?w:null;t.g=null,t.C=null,e||At(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function Dn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(v.clearTimeout(t.A),t.A=null)}function Cn(t){return t.g?t.g.readyState:0}function xn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case bn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function kn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=function(t){let n="";return B(t,function(t,e){n+=e,n+=":",n+=t,n+="\r\n"}),n}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Pe(t,e,n))}function Rn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Ln(t){this.za=0,this.l=[],this.h=new Gt,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Rn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Rn("baseRetryDelayMs",5e3,t),this.$a=Rn("retryDelaySeedMs",1e4,t),this.Ya=Rn("forwardChannelMaxRetries",2,t),this.ra=Rn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new tn(t&&t.concurrentRequestLimit),this.Ca=new un,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function On(t){var e,n;Fn(t),3==t.G&&(e=t.V++,Pe(n=Re(t.F),"SID",t.J),Pe(n,"RID",e),Pe(n,"TYPE","terminate"),qn(t,n),(e=new ue(t,t.h,e,void 0)).K=2,e.v=Ve(Re(n)),n=!1,!(n=v.navigator&&v.navigator.sendBeacon?v.navigator.sendBeacon(e.v.toString(),""):n)&&v.Image&&((new Image).src=e.v,n=!0),n||(e.g=Jn(e.l,null),e.g.ea(e.v)),e.F=Date.now(),be(e)),Yn(t)}function Mn(t){t.g&&($n(t),t.g.cancel(),t.g=null)}function Fn(t){Mn(t),t.u&&(v.clearTimeout(t.u),t.u=null),Hn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&v.clearTimeout(t.m),t.m=null)}function Pn(t,e){t.l.push(new Ze(t.Za++,e)),3==t.G&&Vn(t)}function Vn(t){nn(t.i)||t.m||(t.m=!0,Lt(t.Ha,t),t.C=0)}function Un(t,e){var n=e?e.m:t.V++,r=Re(t.F);Pe(r,"SID",t.J),Pe(r,"RID",n),Pe(r,"AID",t.U),qn(t,r),t.o&&t.s&&kn(r,t.o,t.s),n=new ue(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=Bn(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),on(t.i,n),pe(n,r,e)}function qn(t,n){t.j&&Ne({},function(t,e){Pe(n,e,t)})}function Bn(t,e,r){r=Math.min(t.l.length,r);var s=t.j?N(t.j.Oa,t.j,t):null;t:{var i=t.l;let n=-1;for(;;){const h=["count="+r];-1==n?0<r?(n=i[0].h,h.push("ofs="+n)):n=0:h.push("ofs="+n);let t=!0;for(let e=0;e<r;e++){var o=i[e].h,a=i[e].g;if((o-=n)<0)n=Math.max(0,i[e].h-100),t=!1;else try{!function(t,r,e){const s=e||"";try{Ne(t,function(t,e){let n=t;E(t)&&(n=Ct(t)),r.push(s+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(s+"type="+encodeURIComponent("_badmap")),t}}(a,h,"req"+o+"_")}catch(t){s&&s(a)}}if(t){s=h.join("&");break t}}}return t=t.l.splice(0,r),e.D=t,s}function jn(t){t.g||t.u||(t.Y=1,Lt(t.Ga,t),t.A=0)}function Kn(t){return!(t.g||t.u||3<=t.A)&&(t.Y++,t.u=ee(N(t.Ga,t),Qn(t,t.A)),t.A++,1)}function $n(t){null!=t.B&&(v.clearTimeout(t.B),t.B=null)}function Gn(t){t.g=new ue(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Re(t.oa);Pe(e,"RID","rpc"),Pe(e,"SID",t.J),Pe(e,"CI",t.N?"0":"1"),Pe(e,"AID",t.U),qn(t,e),Pe(e,"TYPE","xmlhttp"),t.o&&t.s&&kn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Ve(Re(e)),n.s=null,n.U=!0,ye(n,t)}function Hn(t){null!=t.v&&(v.clearTimeout(t.v),t.v=null)}function zn(t,e){var n,r,s,i=null;if(t.g==e){Hn(t),$n(t),t.g=null;var o=2}else{if(!sn(t.i,e))return;i=e.D,an(t.i,e),o=1}if(t.I=e.N,0!=t.G)if(e.i)1==o?(i=e.s?e.s.length:0,e=Date.now()-e.F,n=t.C,At(o=Wt(),new te(o,i)),Vn(t)):jn(t);else if(3==(n=e.o)||0==n&&0<t.I||(1!=o||(s=e,rn((r=t).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=ee(N(r.Ha,r,s),Qn(r,r.C)),r.C++,0))))&&(2!=o||!Kn(t)))switch(i&&0<i.length&&(e=t.i,e.i=e.i.concat(i)),n){case 1:Wn(t,5);break;case 4:Wn(t,10);break;case 3:Wn(t,6);break;default:Wn(t,2)}}function Qn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Wn(t,e){var n,r;t.h.info("Error code "+e),2==e?(n=null,t.j&&(n=null),r=N(t.jb,t),n||(n=new ke("//www.google.com/images/cleardot.gif"),v.location&&"http"==v.location.protocol||Le(n,"https"),Ve(n)),function(t,e){var n=new Gt;if(v.Image){const r=new Image;r.onload=A(ln,n,r,"TestLoadImage: loaded",!0,e),r.onerror=A(ln,n,r,"TestLoadImage: error",!1,e),r.onabort=A(ln,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=A(ln,n,r,"TestLoadImage: timeout",!1,e),v.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)):Zt(2),t.G=0,t.j&&t.j.va(e),Yn(t),Fn(t)}function Yn(t){t.G=0,t.I=-1,t.j&&(0==hn(t.i).length&&0==t.l.length||(t.i.i.length=0,O(t.l),t.l.length=0),t.j.ua())}function Xn(t,e,n){let r=(a=n)instanceof ke?Re(a):new ke(a,void 0);var s,i,o,a,h;return""!=r.i?(e&&Oe(r,e+"."+r.i),Me(r,r.m)):(h=v.location,r=(s=h.protocol,i=e?e+"."+h.hostname:h.hostname,o=+h.port,a=n,h=new ke(null,void 0),s&&Le(h,s),i&&Oe(h,i),o&&Me(h,o),a&&(h.l=a),h)),t.aa&&B(t.aa,function(t,e){Pe(r,e,t)}),e=t.D,n=t.sa,e&&n&&Pe(r,e,n),Pe(r,"VER",t.ma),qn(t,r),r}function Jn(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new wn(new dn({ib:!0})):new wn(t.qa)).L=t.H,e}function Zn(){}function tr(){if(Q&&!(10<=Number(st)))throw Error("Environmental error: no available transport.")}function er(t,e){Nt.call(this),this.g=new Ln(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!M(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!M(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new sr(this)}function nr(t){ae.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function rr(){he.call(this),this.status=1}function sr(t){this.g=t}(g=wn.prototype).ea=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||de).g(),this.C=this.u?ie(this.u):ie(de),this.g.onreadystatechange=N(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void _n(this,t)}t=n||"";const s=new Ae(this.headers);r&&Ne(r,function(t,e){s.set(e,t)}),r=function(e){t:{var n=In,r=e.length,s="string"==typeof e?e.split(""):e;for(let t=0;t<r;t++)if(t in s&&n.call(void 0,s[t],t,e)){n=t;break t}n=-1}return n<0?null:"string"==typeof e?e.charAt(n):e[n]}(s.T()),n=v.FormData&&t instanceof v.FormData,0<=k(Tn,e)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(t,e){this.g.setRequestHeader(e,t)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Dn(this),0<this.B&&((this.K=(i=this.g,Q&&rt()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=N(this.pa,this)):this.A=Ut(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){_n(this,t)}var i},g.pa=function(){void 0!==y&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,At(this,"timeout"),this.abort(8))},g.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,At(this,"complete"),At(this,"abort"),An(this))},g.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),An(this,!0)),wn.Z.M.call(this)},g.Fa=function(){this.s||(this.F||this.v||this.l?Nn(this):this.cb())},g.cb=function(){Nn(this)},g.ba=function(){try{return 2<Cn(this)?this.g.status:-1}catch(t){return-1}},g.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},g.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),vn(e)}},g.Da=function(){return this.m},g.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(g=Ln.prototype).ma=8,g.G=1,g.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},g.Ha=function(e){if(this.m)if(this.m=null,1==this.G){if(!e){this.V=Math.floor(1e5*Math.random()),e=this.V++;const i=new ue(this,this.h,e,void 0);let t=this.s;if(this.P&&(t?(t=j(t),$(t,this.P)):t=this.P),null===this.o&&(i.H=t),this.ja)t:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break t}if(4096===n||r===this.l.length-1){n=r+1;break t}}n=1e3}else n=1e3;n=Bn(this,i,n),Pe(r=Re(this.F),"RID",e),Pe(r,"CVER",22),this.D&&Pe(r,"X-HTTP-Session-Id",this.D),qn(this,r),this.o&&t&&kn(r,this.o,t),on(this.i,i),this.Ra&&Pe(r,"TYPE","init"),this.ja?(Pe(r,"$req",n),Pe(r,"SID","null"),i.$=!0,pe(i,r,null)):pe(i,r,n),this.G=2}}else 3==this.G&&(e?Un(this,e):0==this.l.length||nn(this.i)||Un(this))},g.Ga=function(){var t;this.u=null,Gn(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(t=2*this.O,this.h.info("BP detection timer enabled: "+t),this.B=ee(N(this.bb,this),t))},g.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,Zt(10),Mn(this),Gn(this))},g.ab=function(){null!=this.v&&(this.v=null,Mn(this),Kn(this),Zt(19))},g.jb=function(t){t?(this.h.info("Successfully pinged google.com"),Zt(2)):(this.h.info("Failed to ping google.com"),Zt(1))},(g=Zn.prototype).xa=function(){},g.wa=function(){},g.va=function(){},g.ua=function(){},g.Oa=function(){},tr.prototype.g=function(t,e){return new er(t,e)},D(er,Nt),er.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Lt(N(t.hb,t,e))),Zt(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=Xn(t,null,t.W),Vn(t)},er.prototype.close=function(){On(this.g)},er.prototype.u=function(t){var e;"string"==typeof t?((e={}).__data__=t,Pn(this.g,e)):this.v?((e={}).__data__=Ct(t),Pn(this.g,e)):Pn(this.g,t)},er.prototype.M=function(){this.g.j=null,delete this.j,On(this.g),delete this.g,er.Z.M.call(this)},D(nr,ae),D(rr,he),D(sr,Zn),sr.prototype.xa=function(){At(this.g,"a")},sr.prototype.wa=function(t){At(this.g,new nr(t))},sr.prototype.va=function(t){At(this.g,new rr)},sr.prototype.ua=function(){At(this.g,"b")},tr.prototype.createWebChannel=tr.prototype.g,er.prototype.send=er.prototype.u,er.prototype.open=er.prototype.m,ne.NO_ERROR=0,ne.TIMEOUT=8,ne.HTTP_ERROR=6,re.COMPLETE="complete",(oe.EventType=p).OPEN="a",p.CLOSE="b",p.ERROR="c",p.MESSAGE="d",Nt.prototype.listen=Nt.prototype.N,wn.prototype.listenOnce=wn.prototype.O,wn.prototype.getLastError=wn.prototype.La,wn.prototype.getLastErrorCode=wn.prototype.Da,wn.prototype.getStatus=wn.prototype.ba,wn.prototype.getResponseJson=wn.prototype.Qa,wn.prototype.getResponseText=wn.prototype.ga,wn.prototype.send=wn.prototype.ea;var ir,or=Wt,ar=ne,hr=re,cr=zt,ur=10,lr=11,dr=dn,fr=oe,gr=wn;const mr="@firebase/firestore";class pr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}pr.UNAUTHENTICATED=new pr(null),pr.GOOGLE_CREDENTIALS=new pr("google-credentials-uid"),pr.FIRST_PARTY=new pr("first-party-uid"),pr.MOCK_USER=new pr("mock-user");let yr="9.2.0";const vr=new class{constructor(t){this.name=t,this._logLevel=c,this._logHandler=f,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in l))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?h[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...t),this._logHandler(this,l.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...t),this._logHandler(this,l.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,l.INFO,...t),this._logHandler(this,l.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,l.WARN,...t),this._logHandler(this,l.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...t),this._logHandler(this,l.ERROR,...t)}}("@firebase/firestore");function wr(){return vr.logLevel}function br(t,...e){var n;vr.logLevel<=l.DEBUG&&(n=e.map(Ir),vr.debug(`Firestore (${yr}): ${t}`,...n))}function Er(t,...e){var n;vr.logLevel<=l.ERROR&&(n=e.map(Ir),vr.error(`Firestore (${yr}): ${t}`,...n))}function Tr(t,...e){var n;vr.logLevel<=l.WARN&&(n=e.map(Ir),vr.warn(`Firestore (${yr}): ${t}`,...n))}function Ir(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function _r(t="Unexpected state"){var e=`FIRESTORE (${yr}) INTERNAL ASSERTION FAILED: `+t;throw Er(e),new Error(e)}function Sr(t){t||_r()}const Nr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ar extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Dr{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}class Cr{constructor(t,e){this.user=e,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization=`Bearer ${t}`}}class xr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(pr.UNAUTHENTICATED))}shutdown(){}}class kr{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class Rr{constructor(t){this.t=t,this.currentUser=pr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,n){let r=this.i;const s=t=>this.i!==r?(r=this.i,n(t)):Promise.resolve();let i=new Dr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Dr,e.enqueueRetryable(()=>s(this.currentUser))};const o=()=>{const t=i;e.enqueueRetryable(async()=>{await t.promise,await s(this.currentUser)})},a=t=>{br("FirebaseCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(t=>a(t)),setTimeout(()=>{var t;this.auth||((t=this.t.getImmediate({optional:!0}))?a(t):(br("FirebaseCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Dr))},0),o()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(br("FirebaseCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(Sr("string"==typeof t.accessToken),new Cr(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var t=this.auth&&this.auth.getUid();return Sr(null===t||"string"==typeof t),new pr(t)}}class Lr{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=pr.FIRST_PARTY}get authHeaders(){const t={"X-Goog-AuthUser":this.l},e=this.h.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),this.m&&(t["X-Goog-Iam-Authorization-Token"]=this.m),t}}class Or{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Lr(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable(()=>e(pr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Mr{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.g(t),this.p=t=>e.writeSequenceNumber(t))}g(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){var t=++this.previousValue;return this.p&&this.p(t),t}}Mr.T=-1;class Fr{static I(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/e.length)*e.length;let r="";for(;r.length<20;){var s=function(e){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(e);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let t=0;t<e;t++)r[t]=Math.floor(256*Math.random());return r}(40);for(let t=0;t<s.length;++t)r.length<20&&s[t]<n&&(r+=e.charAt(s[t]%e.length))}return r}}function Pr(t,e){return t<e?-1:e<t?1:0}function Vr(t,n,r){return t.length===n.length&&t.every((t,e)=>r(t,n[e]))}function Ur(t){return t+"\0"}class qr{constructor(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Ar(Nr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Ar(Nr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Ar(Nr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Ar(Nr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return qr.fromMillis(Date.now())}static fromDate(t){return qr.fromMillis(t.getTime())}static fromMillis(t){var e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new qr(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Pr(this.nanoseconds,t.nanoseconds):Pr(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Br{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Br(t)}static min(){return new Br(new qr(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function jr(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function Kr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function $r(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class Gr{constructor(t,e,n){void 0===e?e=0:e>t.length&&_r(),void 0===n?n=t.length-e:n>t.length-e&&_r(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===Gr.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Gr?t.forEach(t=>{e.push(t)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return this.construct(this.segments,this.offset+(t=void 0===t?1:t),this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class Hr extends Gr{construct(t,e,n){return new Hr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(0<=n.indexOf("//"))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(t=>0<t.length))}return new Hr(e)}static emptyPath(){return new Hr([])}}const zr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Qr extends Gr{construct(t,e,n){return new Qr(t,e,n)}static isValidIdentifier(t){return zr.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),t=!Qr.isValidIdentifier(t)?"`"+t+"`":t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Qr(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Ar(Nr.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new Ar(Nr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Ar(Nr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?i=!i:"."!==e||i?n+=e:s(),r++}if(s(),i)throw new Ar(Nr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Qr(e)}static emptyPath(){return new Qr([])}}class Wr{constructor(t){(this.fields=t).sort(Qr.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Vr(this.fields,t.fields,(t,e)=>t.isEqual(e))}}class Yr{constructor(t){this.binaryString=t}static fromBase64String(t){var e=atob(t);return new Yr(e)}static fromUint8Array(t){var e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Yr(e)}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Pr(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Yr.EMPTY_BYTE_STRING=new Yr("");const Xr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Jr(e){if(Sr(!!e),"string"!=typeof e)return{seconds:Zr(e.seconds),nanos:Zr(e.nanos)};{let t=0;var n=Xr.exec(e);Sr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),t=Number(n));const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}}function Zr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function ts(t){return"string"==typeof t?Yr.fromBase64String(t):Yr.fromUint8Array(t)}function es(t){var e;return"server_timestamp"===(null===(e=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===e?void 0:e.stringValue)}function ns(t){var e=Jr(t.mapValue.fields.__local_write_time__.timestampValue);return new qr(e.seconds,e.nanos)}function rs(t){return null==t}function ss(t){return 0===t&&1/t==-1/0}function is(t){return"number"==typeof t&&Number.isInteger(t)&&!ss(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class os{constructor(t){this.path=t}static fromPath(t){return new os(Hr.fromString(t))}static fromName(t){return new os(Hr.fromString(t).popFirst(5))}hasCollectionId(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===Hr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Hr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new os(new Hr(t.slice()))}}function as(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?es(t)?4:10:_r()}function hs(r,s){var t,e,n=as(r);if(n!==as(s))return!1;switch(n){case 0:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return ns(r).isEqual(ns(s));case 3:return function(t){if("string"==typeof r.timestampValue&&"string"==typeof t.timestampValue&&r.timestampValue.length===t.timestampValue.length)return r.timestampValue===t.timestampValue;var e=Jr(r.timestampValue),n=Jr(t.timestampValue);return e.seconds===n.seconds&&e.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return e=s,ts(r.bytesValue).isEqual(ts(e.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return t=s,Zr((e=r).geoPointValue.latitude)===Zr(t.geoPointValue.latitude)&&Zr(e.geoPointValue.longitude)===Zr(t.geoPointValue.longitude);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Zr(t.integerValue)===Zr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){var n=Zr(t.doubleValue),r=Zr(e.doubleValue);return n===r?ss(n)===ss(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return Vr(r.arrayValue.values||[],s.arrayValue.values||[],hs);case 10:return function(t){const e=t.mapValue.fields||{},n=s.mapValue.fields||{};if(jr(e)!==jr(n))return!1;for(const t in e)if(e.hasOwnProperty(t)&&(void 0===n[t]||!hs(e[t],n[t])))return!1;return!0}(r);default:return _r()}}function cs(t,e){return void 0!==(t.values||[]).find(t=>hs(t,e))}function us(t,e){var n,r,s,i,o=as(t),a=as(e);if(o!==a)return Pr(o,a);switch(o){case 0:return 0;case 1:return Pr(t.booleanValue,e.booleanValue);case 2:return r=e,s=Zr(t.integerValue||t.doubleValue),i=Zr(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return ls(t.timestampValue,e.timestampValue);case 4:return ls(ns(t),ns(e));case 5:return Pr(t.stringValue,e.stringValue);case 6:return function(t,e){const n=ts(t),r=ts(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){var n=t.split("/"),r=e.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=Pr(n[s],r[s]);if(0!==e)return e}return Pr(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return n=t.geoPointValue,r=e.geoPointValue,0!==(i=Pr(Zr(n.latitude),Zr(r.latitude)))?i:Pr(Zr(n.longitude),Zr(r.longitude));case 9:return function(t,e){var n=t.values||[],r=e.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=us(n[s],r[s]);if(e)return e}return Pr(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let a=0;a<r.length&&a<i.length;++a){const e=Pr(r[a],i[a]);if(0!==e)return e;var o=us(n[r[a]],s[i[a]]);if(0!==o)return o}return Pr(r.length,i.length)}(t.mapValue,e.mapValue);default:throw _r()}}function ls(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Pr(t,e);var n=Jr(t),r=Jr(e),s=Pr(n.seconds,r.seconds);return 0!==s?s:Pr(n.nanos,r.nanos)}function ds(t){return function i(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Jr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?ts(t.bytesValue).toBase64():"referenceValue"in t?(e=t.referenceValue,os.fromName(e).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=i(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${i(t.fields[s])}`;return n+"}"}(t.mapValue):_r();var e}(t)}function fs(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function gs(t){return t&&"integerValue"in t}function ms(t){return!!t&&"arrayValue"in t}function ps(t){return t&&"nullValue"in t}function ys(t){return t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function vs(t){return t&&"mapValue"in t}function ws(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const n={mapValue:{fields:{}}};return Kr(e.mapValue.fields,(t,e)=>n.mapValue.fields[t]=ws(e)),n}if(e.arrayValue){const r={arrayValue:{values:[]}};for(let t=0;t<(e.arrayValue.values||[]).length;++t)r.arrayValue.values[t]=ws(e.arrayValue.values[t]);return r}return Object.assign({},e)}class bs{constructor(t){this.value=t}static empty(){return new bs({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(t=(t.mapValue.fields||{})[n.get(e)],!vs(t))return null;return t=(t.mapValue.fields||{})[n.lastSegment()],t||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=ws(e)}setAll(t){let n=Qr.emptyPath(),r={},s=[];t.forEach((t,e)=>{if(!n.isImmediateParentOf(e)){const t=this.getFieldsMap(n);this.applyChanges(t,r,s),r={},s=[],n=e.popLast()}t?r[e.lastSegment()]=ws(t):s.push(e.lastSegment())});var e=this.getFieldsMap(n);this.applyChanges(e,r,s)}delete(t){const e=this.field(t.popLast());vs(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return hs(this.value,t.value)}getFieldsMap(e){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<e.length;++r){let t=n.mapValue.fields[e.get(r)];vs(t)&&t.mapValue.fields||(t={mapValue:{fields:{}}},n.mapValue.fields[e.get(r)]=t),n=t}return n.mapValue.fields}applyChanges(n,t,e){Kr(t,(t,e)=>n[t]=e);for(const t of e)delete n[t]}clone(){return new bs(ws(this.value))}}class Es{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new Es(t,0,Br.min(),bs.empty(),0)}static newFoundDocument(t,e,n){return new Es(t,1,e,n,0)}static newNoDocument(t,e){return new Es(t,2,e,bs.empty(),0)}static newUnknownDocument(t,e){return new Es(t,3,e,bs.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=bs.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=bs.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Es&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}clone(){return new Es(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ts{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.A=null}}function Is(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Ts(t,e,n,r,s,i,o)}function _s(t){const e=t;if(null===e.A){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(t=>function(t){return t.field.canonicalString()+t.op.toString()+ds(t.value)}(t)).join(","),t+="|ob:",t+=e.orderBy.map(t=>function(t){return t.field.canonicalString()+t.dir}(t)).join(","),rs(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Ps(e.startAt)),e.endAt&&(t+="|ub:",t+=Ps(e.endAt)),e.A=t}return e.A}function Ss(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let o=0;o<t.orderBy.length;o++)if(n=t.orderBy[o],r=e.orderBy[o],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r,s,i;if(t.filters.length!==e.filters.length)return!1;for(let a=0;a<t.filters.length;a++)if(s=t.filters[a],i=e.filters[a],s.op!==i.op||!s.field.isEqual(i.field)||!hs(s.value,i.value))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!qs(t.startAt,e.startAt)&&qs(t.endAt,e.endAt)}function Ns(t){return os.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class As extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.R(t,e,n):new Ds(t,e,n):"array-contains"===e?new Rs(t,n):"in"===e?new Ls(t,n):"not-in"===e?new Os(t,n):"array-contains-any"===e?new Ms(t,n):new As(t,e,n)}static R(t,e,n){return new("in"===e?Cs:xs)(t,n)}matches(t){var e=t.data.field(this.field);return"!="===this.op?null!==e&&this.P(us(e,this.value)):null!==e&&as(this.value)===as(e)&&this.P(us(e,this.value))}P(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return 0<t;case">=":return 0<=t;default:return _r()}}v(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class Ds extends As{constructor(t,e,n){super(t,e,n),this.key=os.fromName(n.referenceValue)}matches(t){var e=os.comparator(t.key,this.key);return this.P(e)}}class Cs extends As{constructor(t,e){super(t,"in",e),this.keys=ks(0,e)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class xs extends As{constructor(t,e){super(t,"not-in",e),this.keys=ks(0,e)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function ks(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map(t=>os.fromName(t.referenceValue))}class Rs extends As{constructor(t,e){super(t,"array-contains",e)}matches(t){var e=t.data.field(this.field);return ms(e)&&cs(e.arrayValue,this.value)}}class Ls extends As{constructor(t,e){super(t,"in",e)}matches(t){var e=t.data.field(this.field);return null!==e&&cs(this.value.arrayValue,e)}}class Os extends As{constructor(t,e){super(t,"not-in",e)}matches(t){if(cs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var e=t.data.field(this.field);return null!==e&&!cs(this.value.arrayValue,e)}}class Ms extends As{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!ms(e)||!e.arrayValue.values)&&e.arrayValue.values.some(t=>cs(this.value.arrayValue,t))}}class Fs{constructor(t,e){this.position=t,this.before=e}}function Ps(t){return`${t.before?"b":"a"}:${t.position.map(t=>ds(t)).join(",")}`}class Vs{constructor(t,e="asc"){this.field=t,this.dir=e}}function Us(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?os.comparator(os.fromName(o.referenceValue),n.key):us(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function qs(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!hs(t.position[n],e.position[n]))return!1;return!0}class Bs{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.V=null,this.S=null,this.startAt,this.endAt}}function js(t,e,n,r,s,i,o,a){return new Bs(t,e,n,r,s,i,o,a)}function Ks(t){return new Bs(t)}function $s(t){return!rs(t.limit)&&"F"===t.limitType}function Gs(t){return!rs(t.limit)&&"L"===t.limitType}function Hs(t){return 0<t.explicitOrderBy.length?t.explicitOrderBy[0].field:null}function zs(t){for(const e of t.filters)if(e.v())return e.field;return null}function Qs(t){return null!==t.collectionGroup}function Ws(e){const n=e;if(null===n.V){n.V=[];const e=zs(n),t=Hs(n);if(null!==e&&null===t)e.isKeyField()||n.V.push(new Vs(e)),n.V.push(new Vs(Qr.keyField(),"asc"));else{let t=!1;for(const r of n.explicitOrderBy)n.V.push(r),r.field.isKeyField()&&(t=!0);if(!t){const e=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.V.push(new Vs(Qr.keyField(),e))}}}return n.V}function Ys(t){const e=t;if(!e.S)if("F"===e.limitType)e.S=Is(e.path,e.collectionGroup,Ws(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const s of Ws(e)){const e="desc"===s.dir?"asc":"desc";t.push(new Vs(s.field,e))}var n=e.endAt?new Fs(e.endAt.position,!e.endAt.before):null,r=e.startAt?new Fs(e.startAt.position,!e.startAt.before):null;e.S=Is(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.S}function Xs(t,e,n){return new Bs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Js(t,e){return Ss(Ys(t),Ys(e))&&t.limitType===e.limitType}function Zs(t){return`${_s(Ys(t))}|lt:${t.limitType}`}function ti(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),0<t.filters.length&&(e+=`, filters: [${t.filters.map(t=>{return`${(e=t).field.canonicalString()} ${e.op} ${ds(e.value)}`;var e}).join(", ")}]`),rs(t.limit)||(e+=", limit: "+t.limit),0<t.orderBy.length&&(e+=`, orderBy: [${t.orderBy.map(t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t)).join(", ")}]`),t.startAt&&(e+=", startAt: "+Ps(t.startAt)),t.endAt&&(e+=", endAt: "+Ps(t.endAt)),`Target(${e})`}(Ys(t))}; limitType=${t.limitType})`}function ei(n,t){return t.isFoundDocument()&&(e=n,s=(r=t).key.path,null!==e.collectionGroup?r.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(s):os.isDocumentKey(e.path)?e.path.isEqual(s):e.path.isImmediateParentOf(s))&&function(t){for(const e of n.explicitOrderBy)if(!e.field.isKeyField()&&null===t.data.field(e.field))return;return 1}(t)&&function(t){for(const e of n.filters)if(!e.matches(t))return;return 1}(t)&&(e=t,(!(t=n).startAt||Us(t.startAt,Ws(t),e))&&(!t.endAt||!Us(t.endAt,Ws(t),e)));var e,r,s}function ni(s){return(t,e)=>{let n=!1;for(const r of Ws(s)){const s=function(t,s,e){var n=t.field.isKeyField()?os.comparator(s.key,e.key):function(t,e){var n=s.data.field(t),r=e.data.field(t);return null!==n&&null!==r?us(n,r):_r()}(t.field,e);switch(t.dir){case"asc":return n;case"desc":return-1*n;default:return _r()}}(r,t,e);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function ri(t,e){if(t.D){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ss(e)?"-0":e}}function si(t){return{integerValue:""+t}}function ii(t,e){return is(e)?si(e):ri(t,e)}class oi{constructor(){this._=void 0}}function ai(t,e){return t instanceof fi?gs(n=e)||n&&"doubleValue"in n?e:{integerValue:0}:null;var n}class hi extends oi{}class ci extends oi{constructor(t){super(),this.elements=t}}function ui(t,e){const n=mi(e);for(const e of t.elements)n.some(t=>hs(t,e))||n.push(e);return{arrayValue:{values:n}}}class li extends oi{constructor(t){super(),this.elements=t}}function di(t,e){let n=mi(e);for(const e of t.elements)n=n.filter(t=>!hs(t,e));return{arrayValue:{values:n}}}class fi extends oi{constructor(t,e){super(),this.N=t,this.C=e}}function gi(t){return Zr(t.integerValue||t.doubleValue)}function mi(t){return ms(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class pi{constructor(t,e){this.field=t,this.transform=e}}class yi{constructor(t,e){this.version=t,this.transformResults=e}}class vi{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new vi}static exists(t){return new vi(void 0,t)}static updateTime(t){return new vi(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function wi(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class bi{}function Ei(t,e,n){t instanceof Si?function(t,e,n){const r=t.value.clone(),s=Di(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Ni?function(t,e,n){if(!wi(t.precondition,e))return e.convertToUnknownDocument(n.version);const r=Di(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Ai(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):e.convertToNoDocument(n.version).setHasCommittedMutations()}function Ti(t,e,n){t instanceof Si?function(t,e,n){if(wi(t.precondition,e)){const r=t.value.clone(),s=Ci(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(_i(e),r).setHasLocalMutations()}}(t,e,n):t instanceof Ni?function(t,e,n){if(wi(t.precondition,e)){const r=Ci(t.fieldTransforms,n,e),s=e.data;s.setAll(Ai(t)),s.setAll(r),e.convertToFoundDocument(_i(e),s).setHasLocalMutations()}}(t,e,n):(e=e,wi(t.precondition,e)&&e.convertToNoDocument(Br.min()))}function Ii(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&(n=t.fieldTransforms,r=e.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Vr(n,r,(t,e)=>function(t,e){return t.field.isEqual(e.field)&&(t=t.transform,e=e.transform,t instanceof ci&&e instanceof ci||t instanceof li&&e instanceof li?Vr(t.elements,e.elements,hs):t instanceof fi&&e instanceof fi?hs(t.C,e.C):t instanceof hi&&e instanceof hi)}(t,e)))&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask)));var n,r}function _i(t){return t.isFoundDocument()?t.version:Br.min()}class Si extends bi{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Ni extends bi{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Ai(n){const r=new Map;return n.fieldMask.fields.forEach(t=>{var e;t.isEmpty()||(e=n.data.field(t),r.set(t,e))}),r}function Di(t,e,n){const r=new Map;Sr(t.length===n.length);for(let u=0;u<n.length;u++){var s=t[u],i=s.transform,o=e.data.field(s.field);r.set(s.field,(a=i,h=o,c=n[u],a instanceof ci?ui(a,h):a instanceof li?di(a,h):c))}var a,h,c;return r}function Ci(t,e,n){const r=new Map;for(const c of t){const t=c.transform,u=n.data.field(c.field);r.set(c.field,(s=t,i=u,o=e,h=a=void 0,s instanceof hi?function(){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:o.seconds,nanos:o.nanoseconds}}}};return i&&(t.fields.__previous_value__=i),{mapValue:t}}():s instanceof ci?ui(s,i):s instanceof li?di(s,i):(a=ai(s=s,i),h=gi(a)+gi(s.C),gs(a)&&gs(s.C)?si(h):ri(s.N,h))))}var s,i,o,a,h;return r}class xi extends bi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class ki extends bi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class Ri{constructor(t){this.count=t}}function Li(t){switch(t){default:return _r(),0;case Nr.CANCELLED:case Nr.UNKNOWN:case Nr.DEADLINE_EXCEEDED:case Nr.RESOURCE_EXHAUSTED:case Nr.INTERNAL:case Nr.UNAVAILABLE:case Nr.UNAUTHENTICATED:return;case Nr.INVALID_ARGUMENT:case Nr.NOT_FOUND:case Nr.ALREADY_EXISTS:case Nr.PERMISSION_DENIED:case Nr.FAILED_PRECONDITION:case Nr.ABORTED:case Nr.OUT_OF_RANGE:case Nr.UNIMPLEMENTED:case Nr.DATA_LOSS:return 1}}function Oi(t){if(void 0===t)return Er("GRPC error has no .code"),Nr.UNKNOWN;switch(t){case ir.OK:return Nr.OK;case ir.CANCELLED:return Nr.CANCELLED;case ir.UNKNOWN:return Nr.UNKNOWN;case ir.DEADLINE_EXCEEDED:return Nr.DEADLINE_EXCEEDED;case ir.RESOURCE_EXHAUSTED:return Nr.RESOURCE_EXHAUSTED;case ir.INTERNAL:return Nr.INTERNAL;case ir.UNAVAILABLE:return Nr.UNAVAILABLE;case ir.UNAUTHENTICATED:return Nr.UNAUTHENTICATED;case ir.INVALID_ARGUMENT:return Nr.INVALID_ARGUMENT;case ir.NOT_FOUND:return Nr.NOT_FOUND;case ir.ALREADY_EXISTS:return Nr.ALREADY_EXISTS;case ir.PERMISSION_DENIED:return Nr.PERMISSION_DENIED;case ir.FAILED_PRECONDITION:return Nr.FAILED_PRECONDITION;case ir.ABORTED:return Nr.ABORTED;case ir.OUT_OF_RANGE:return Nr.OUT_OF_RANGE;case ir.UNIMPLEMENTED:return Nr.UNIMPLEMENTED;case ir.DATA_LOSS:return Nr.DATA_LOSS;default:return _r()}}(re=ir=ir||{})[re.OK=0]="OK",re[re.CANCELLED=1]="CANCELLED",re[re.UNKNOWN=2]="UNKNOWN",re[re.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",re[re.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",re[re.NOT_FOUND=5]="NOT_FOUND",re[re.ALREADY_EXISTS=6]="ALREADY_EXISTS",re[re.PERMISSION_DENIED=7]="PERMISSION_DENIED",re[re.UNAUTHENTICATED=16]="UNAUTHENTICATED",re[re.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",re[re.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",re[re.ABORTED=10]="ABORTED",re[re.OUT_OF_RANGE=11]="OUT_OF_RANGE",re[re.UNIMPLEMENTED=12]="UNIMPLEMENTED",re[re.INTERNAL=13]="INTERNAL",re[re.UNAVAILABLE=14]="UNAVAILABLE",re[re.DATA_LOSS=15]="DATA_LOSS";class Mi{constructor(t,e){this.comparator=t,this.root=e||Pi.EMPTY}insert(t,e){return new Mi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Pi.BLACK,null,null))}remove(t){return new Mi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Pi.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(n){this.inorderTraversal((t,e)=>(n(t,e),!1))}toString(){const n=[];return this.inorderTraversal((t,e)=>(n.push(`${t}:${e}`),!1)),`{${n.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Fi(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Fi(this.root,t,this.comparator,!1)}getReverseIterator(){return new Fi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Fi(this.root,t,this.comparator,!0)}}class Fi{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();var e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Pi{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Pi.RED,this.left=null!=r?r:Pi.EMPTY,this.right=null!=s?s:Pi.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Pi(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;var s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Pi.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Pi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){var t=this.copy(null,null,Pi.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){var t=this.copy(null,null,Pi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){var t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw _r();if(this.right.isRed())throw _r();var t=this.left.check();if(t!==this.right.check())throw _r();return t+(this.isRed()?0:1)}}Pi.EMPTY=null,Pi.RED=!0,Pi.BLACK=!1,Pi.EMPTY=new class{constructor(){this.size=0}get key(){throw _r()}get value(){throw _r()}get color(){throw _r()}get left(){throw _r()}get right(){throw _r()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Pi(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Vi{constructor(t){this.comparator=t,this.data=new Mi(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(n){this.data.inorderTraversal((t,e)=>(n(t),!1))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Ui(this.data.getIterator())}getIteratorFrom(t){return new Ui(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(t=>{e=e.add(t)}),e}isEqual(t){if(!(t instanceof Vi))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(t){const e=new Vi(this.comparator);return e.data=t,e}}class Ui{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const qi=new Mi(os.comparator);const Bi=new Mi(os.comparator);const ji=new Mi(os.comparator);const Ki=new Vi(os.comparator);function $i(...t){let e=Ki;for(const n of t)e=e.add(n);return e}const Gi=new Vi(Pr);class Hi{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,zi.createSynthesizedTargetChangeForCurrentChange(t,e)),new Hi(Br.min(),n,Gi,qi,$i())}}class zi{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new zi(Yr.EMPTY_BYTE_STRING,e,$i(),$i(),$i())}}class Qi{constructor(t,e,n,r){this.k=t,this.removedTargetIds=e,this.key=n,this.$=r}}class Wi{constructor(t,e){this.targetId=t,this.O=e}}class Yi{constructor(t,e,n=Yr.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class Xi{constructor(){this.F=0,this.M=to(),this.L=Yr.EMPTY_BYTE_STRING,this.B=!1,this.U=!0}get current(){return this.B}get resumeToken(){return this.L}get q(){return 0!==this.F}get K(){return this.U}j(t){0<t.approximateByteSize()&&(this.U=!0,this.L=t)}W(){let n=$i(),r=$i(),s=$i();return this.M.forEach((t,e)=>{switch(e){case 0:n=n.add(t);break;case 2:r=r.add(t);break;case 1:s=s.add(t);break;default:_r()}}),new zi(this.L,this.B,n,r,s)}G(){this.U=!1,this.M=to()}H(t,e){this.U=!0,this.M=this.M.insert(t,e)}J(t){this.U=!0,this.M=this.M.remove(t)}Y(){this.F+=1}X(){--this.F}Z(){this.U=!0,this.B=!0}}class Ji{constructor(t){this.tt=t,this.et=new Map,this.nt=qi,this.st=Zi(),this.it=new Vi(Pr)}rt(t){for(const e of t.k)t.$&&t.$.isFoundDocument()?this.ot(e,t.$):this.ct(e,t.key,t.$);for(const n of t.removedTargetIds)this.ct(n,t.key,t.$)}at(n){this.forEachTarget(n,t=>{const e=this.ut(t);switch(n.state){case 0:this.ht(t)&&e.j(n.resumeToken);break;case 1:e.X(),e.q||e.G(),e.j(n.resumeToken);break;case 2:e.X(),e.q||this.removeTarget(t);break;case 3:this.ht(t)&&(e.Z(),e.j(n.resumeToken));break;case 4:this.ht(t)&&(this.lt(t),e.j(n.resumeToken));break;default:_r()}})}forEachTarget(t,n){0<t.targetIds.length?t.targetIds.forEach(n):this.et.forEach((t,e)=>{this.ht(e)&&n(e)})}ft(t){const e=t.targetId,n=t.O.count,r=this.dt(e);if(r){const t=r.target;if(Ns(t))if(0===n){const n=new os(t.path);this.ct(e,n,Es.newNoDocument(n,Br.min()))}else Sr(1===n);else this.wt(e)!==n&&(this.lt(e),this.it=this.it.add(e))}}_t(r){const s=new Map;this.et.forEach((t,e)=>{var n=this.dt(e);if(n){if(t.current&&Ns(n.target)){const s=new os(n.target.path);null!==this.nt.get(s)||this.gt(e,s)||this.ct(e,s,Es.newNoDocument(s,r))}t.K&&(s.set(e,t.W()),t.G())}});let i=$i();this.st.forEach((t,e)=>{let n=!0;e.forEachWhile(t=>{var e=this.dt(t);return!e||2===e.purpose||(n=!1)}),n&&(i=i.add(t))});var t=new Hi(r,s,this.it,this.nt,i);return this.nt=qi,this.st=Zi(),this.it=new Vi(Pr),t}ot(t,e){var n;this.ht(t)&&(n=this.gt(t,e.key)?2:0,this.ut(t).H(e.key,n),this.nt=this.nt.insert(e.key,e),this.st=this.st.insert(e.key,this.yt(e.key).add(t)))}ct(t,e,n){if(this.ht(t)){const r=this.ut(t);this.gt(t,e)?r.H(e,1):r.J(e),this.st=this.st.insert(e,this.yt(e).delete(t)),n&&(this.nt=this.nt.insert(e,n))}}removeTarget(t){this.et.delete(t)}wt(t){var e=this.ut(t).W();return this.tt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Y(t){this.ut(t).Y()}ut(t){let e=this.et.get(t);return e||(e=new Xi,this.et.set(t,e)),e}yt(t){let e=this.st.get(t);return e||(e=new Vi(Pr),this.st=this.st.insert(t,e)),e}ht(t){var e=null!==this.dt(t);return e||br("WatchChangeAggregator","Detected inactive target",t),e}dt(t){var e=this.et.get(t);return e&&e.q?null:this.tt.Tt(t)}lt(e){this.et.set(e,new Xi),this.tt.getRemoteKeysForTarget(e).forEach(t=>{this.ct(e,t,null)})}gt(t,e){return this.tt.getRemoteKeysForTarget(t).has(e)}}function Zi(){return new Mi(os.comparator)}function to(){return new Mi(os.comparator)}const eo={asc:"ASCENDING",desc:"DESCENDING"},no={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class ro{constructor(t,e){this.databaseId=t,this.D=e}}function so(t,e){return t.D?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function io(t,e){return t.D?e.toBase64():e.toUint8Array()}function oo(t){return Sr(!!t),Br.fromTimestamp((e=Jr(t),new qr(e.seconds,e.nanos)));var e}function ao(t,e){return t=t,new Hr(["projects",t.projectId,"databases",t.database]).child("documents").child(e).canonicalString()}function ho(t){var e=Hr.fromString(t);return Sr(Co(e)),e}function co(t,e){return ao(t.databaseId,e.path)}function uo(t,e){const n=ho(e);if(n.get(1)!==t.databaseId.projectId)throw new Ar(Nr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Ar(Nr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new os(mo(n))}function lo(t,e){return ao(t.databaseId,e)}function fo(t){var e=ho(t);return 4===e.length?Hr.emptyPath():mo(e)}function go(t){return new Hr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function mo(t){return Sr(4<t.length&&"documents"===t.get(4)),t.popFirst(5)}function po(t,e,n){return{name:co(t,e),fields:n.value.mapValue.fields}}function yo(t,e,n){const r=uo(t,e.name),s=oo(e.updateTime),i=new bs({mapValue:{fields:e.fields}}),o=Es.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function vo(t,e){let n;if(e instanceof Si)n={update:po(t,e.key,e.value)};else if(e instanceof xi)n={delete:co(t,e.key)};else if(e instanceof Ni)n={update:po(t,e.key,e.data),updateMask:function(t){const e=[];return t.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}(e.fieldMask)};else{if(!(e instanceof ki))return _r();n={verify:co(t,e.key)}}return 0<e.fieldTransforms.length&&(n.updateTransforms=e.fieldTransforms.map(t=>function(t){var e=t.transform;if(e instanceof hi)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(e instanceof ci)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:e.elements}};if(e instanceof li)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:e.elements}};if(e instanceof fi)return{fieldPath:t.field.canonicalString(),increment:e.C};throw _r()}(t))),e.precondition.isNone||(n.currentDocument=void 0!==(r=e.precondition).updateTime?{updateTime:(e=r.updateTime,so(t,e.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:_r()),n;var r}function wo(e,n){const t=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?vi.updateTime(oo(s.updateTime)):void 0!==s.exists?vi.exists(s.exists):vi.none():vi.none(),r=n.updateTransforms?n.updateTransforms.map(t=>function(t,e){let n=null;if("setToServerValue"in e)Sr("REQUEST_TIME"===e.setToServerValue),n=new hi;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new ci(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new li(t)}else"increment"in e?n=new fi(t,e.increment):_r();var r=Qr.fromServerFormat(e.fieldPath);return new pi(r,n)}(e,t)):[];var s;if(n.update){n.update.name;var i=uo(e,n.update.name),o=new bs({mapValue:{fields:n.update.fields}});if(n.updateMask){const e=function(){const t=n.updateMask.fieldPaths||[];return new Wr(t.map(t=>Qr.fromServerFormat(t)))}();return new Ni(i,o,e,t,r)}return new Si(i,o,t,r)}if(n.delete){const r=uo(e,n.delete);return new xi(r,t)}if(n.verify){const r=uo(e,n.verify);return new ki(r,t)}return _r()}function bo(t,e){return{documents:[lo(t,e.path)]}}function Eo(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=lo(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=lo(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(t){if(0!==t.length){var e=t.map(t=>function(t){if("=="===t.op){if(ys(t.value))return{unaryFilter:{field:So(t.field),op:"IS_NAN"}};if(ps(t.value))return{unaryFilter:{field:So(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(ys(t.value))return{unaryFilter:{field:So(t.field),op:"IS_NOT_NAN"}};if(ps(t.value))return{unaryFilter:{field:So(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:So(t.field),op:(e=t.op,no[e]),value:t.value}};var e}(t));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}}(e.filters);s&&(n.structuredQuery.where=s);s=function(t){if(0!==t.length)return t.map(t=>function(t){return{field:So(t.field),direction:(t=t.dir,eo[t])}}(t))}(e.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=e.limit,t.D||rs(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),e.startAt&&(n.structuredQuery.startAt=Io(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Io(e.endAt)),n}function To(t){let e=fo(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){Sr(1===r);const l=n.from[0];l.allDescendants?s=l.collectionId:e=e.child(l.collectionId)}let i=[];n.where&&(i=function e(t){return t?void 0!==t.unaryFilter?[Do(t)]:void 0!==t.fieldFilter?[Ao(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(t=>e(t)).reduce((t,e)=>t.concat(e)):_r():[]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map(t=>function(t){return new Vs(No(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(t)));let a=null;var h;n.limit&&(a=(t=n.limit,rs(h="object"==typeof t?t.value:t)?null:h));let c=null;n.startAt&&(c=_o(n.startAt));let u=null;return n.endAt&&(u=_o(n.endAt)),js(e,s,o,i,a,"F",c,u)}function Io(t){return{before:t.before,values:t.position}}function _o(t){var e=!!t.before,n=t.values||[];return new Fs(n,e)}function So(t){return{fieldPath:t.canonicalString()}}function No(t){return Qr.fromServerFormat(t.fieldPath)}function Ao(t){return As.create(No(t.fieldFilter.field),function(){switch(t.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return _r()}}(),t.fieldFilter.value)}function Do(t){switch(t.unaryFilter.op){case"IS_NAN":var e=No(t.unaryFilter.field);return As.create(e,"==",{doubleValue:NaN});case"IS_NULL":e=No(t.unaryFilter.field);return As.create(e,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=No(t.unaryFilter.field);return As.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=No(t.unaryFilter.field);return As.create(n,"!=",{nullValue:"NULL_VALUE"});default:return _r()}}function Co(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)}function xo(t){let e="";for(let n=0;n<t.length;n++)0<e.length&&(e=ko(e)),e=function(t,e){let n=e;const r=t.length;for(let s=0;s<r;s++){const r=t.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(n),e);return ko(e)}function ko(t){return t+""}function Ro(e){const n=e.length;if(Sr(2<=n),2===n)return Sr(""===e.charAt(0)&&""===e.charAt(1)),Hr.emptyPath();const r=n-2,s=[];let i="";for(let o=0;o<n;){const n=e.indexOf("",o);switch((n<0||n>r)&&_r(),e.charAt(n+1)){case"":const r=e.substring(o,n);let t;0===i.length?t=r:(i+=r,t=i,i=""),s.push(t);break;case"":i+=e.substring(o,n),i+="\0";break;case"":i+=e.substring(o,n+1);break;default:_r()}o=n+2}return new Hr(s)}class Lo{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class Oo{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}Oo.store="owner",Oo.key="owner";class Mo{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}Mo.store="mutationQueues",Mo.keyPath="userId";class Fo{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}Fo.store="mutations",Fo.keyPath="batchId",Fo.userMutationsIndex="userMutationsIndex",Fo.userMutationsKeyPath=["userId","batchId"];class Po{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,xo(e)]}static key(t,e,n){return[t,xo(e),n]}}Po.store="documentMutations",Po.PLACEHOLDER=new Po;class Vo{constructor(t,e){this.path=t,this.readTime=e}}class Uo{constructor(t,e){this.path=t,this.version=e}}class qo{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}qo.store="remoteDocuments",qo.readTimeIndex="readTimeIndex",qo.readTimeIndexPath="readTime",qo.collectionReadTimeIndex="collectionReadTimeIndex",qo.collectionReadTimeIndexPath=["parentPath","readTime"];class Bo{constructor(t){this.byteSize=t}}Bo.store="remoteDocumentGlobal",Bo.key="remoteDocumentGlobalKey";class jo{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}jo.store="targets",jo.keyPath="targetId",jo.queryTargetsIndexName="queryTargetsIndex",jo.queryTargetsKeyPath=["canonicalId","targetId"];class Ko{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}Ko.store="targetDocuments",Ko.keyPath=["targetId","path"],Ko.documentTargetsIndex="documentTargetsIndex",Ko.documentTargetsKeyPath=["path","targetId"];class $o{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}$o.key="targetGlobalKey",$o.store="targetGlobal";class Go{constructor(t,e){this.collectionId=t,this.parent=e}}Go.store="collectionParents",Go.keyPath=["collectionId","parent"];class Ho{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}Ho.store="clientMetadata",Ho.keyPath="clientId";class zo{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}zo.store="bundles",zo.keyPath="bundleId";class Qo{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}Qo.store="namedQueries",Qo.keyPath="name";const Wo=[Mo.store,Fo.store,Po.store,qo.store,jo.store,Oo.store,$o.store,Ko.store,Ho.store,Bo.store,Go.store,zo.store,Qo.store],Yo="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Xo{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}class Jo{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(t){return this.next(void 0,t)}next(r,s){return this.callbackAttached&&_r(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new Jo((e,n)=>{this.nextCallback=t=>{this.wrapSuccess(r,t).next(e,n)},this.catchCallback=t=>{this.wrapFailure(s,t).next(e,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{var e=t();return e instanceof Jo?e:Jo.resolve(e)}catch(t){return Jo.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):Jo.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):Jo.reject(e)}static resolve(n){return new Jo((t,e)=>{t(n)})}static reject(n){return new Jo((t,e)=>{e(n)})}static waitFor(t){return new Jo((e,n)=>{let r=0,s=0,i=!1;t.forEach(t=>{++r,t.next(()=>{++s,i&&s===r&&e()},t=>n(t))}),i=!0,s===r&&e()})}static or(t){let e=Jo.resolve(!1);for(const n of t)e=e.next(t=>t?Jo.resolve(t):n());return e}static forEach(t,n){const r=[];return t.forEach((t,e)=>{r.push(n.call(this,t,e))}),this.waitFor(r)}}class Zo{constructor(n,t){this.action=n,this.transaction=t,this.aborted=!1,this.Et=new Dr,this.transaction.oncomplete=()=>{this.Et.resolve()},this.transaction.onabort=()=>{t.error?this.Et.reject(new na(n,t.error)):this.Et.resolve()},this.transaction.onerror=t=>{var e=aa(t.target.error);this.Et.reject(new na(n,e))}}static open(t,e,n,r){try{return new Zo(e,t.transaction(r,n))}catch(t){throw new na(e,t)}}get It(){return this.Et.promise}abort(t){t&&this.Et.reject(t),this.aborted||(br("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){var e=this.transaction.objectStore(t);return new sa(e)}}class ta{constructor(t,e,n){this.name=t,this.version=e,this.At=n,12.2===ta.Rt(d())&&Er("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return br("SimpleDb","Removing database:",t),ia(window.indexedDB.deleteDatabase(t)).toPromise()}static bt(){if("object"!=typeof indexedDB)return!1;if(ta.Pt())return!0;const t=d(),e=ta.Rt(t),n=0<e&&e<10,r=ta.vt(t),s=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||s)}static Pt(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.Vt)}static St(t,e){return t.store(e)}static Rt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Dt(i){return this.db||(br("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{var e=t.target.result;n(e)},s.onblocked=()=>{r(new na(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=t=>{var e=t.target.error;"VersionError"===e.name?r(new Ar(Nr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?r(new Ar(Nr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):r(new na(i,e))},s.onupgradeneeded=t=>{br("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);var e=t.target.result;this.At.Ct(e,s.transaction,t.oldVersion,this.version).next(()=>{br("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.Nt&&(this.db.onversionchange=t=>this.Nt(t)),this.db}xt(e){this.Nt=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(t,e,n,r){var s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Dt(t);const e=Zo.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch(t=>(e.abort(t),Jo.reject(t))).toPromise();return i.catch(()=>{}),await e.It,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(br("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ea{constructor(t){this.kt=t,this.$t=!1,this.Ot=null}get isDone(){return this.$t}get Ft(){return this.Ot}set cursor(t){this.kt=t}done(){this.$t=!0}Mt(t){this.Ot=t}delete(){return ia(this.kt.delete())}}class na extends Ar{constructor(t,e){super(Nr.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function ra(t){return"IndexedDbTransactionError"===t.name}class sa{constructor(t){this.store=t}put(t,e){let n;return n=void 0!==e?(br("SimpleDb","PUT",this.store.name,t,e),this.store.put(e,t)):(br("SimpleDb","PUT",this.store.name,"<auto-key>",t),this.store.put(t)),ia(n)}add(t){return br("SimpleDb","ADD",this.store.name,t,t),ia(this.store.add(t))}get(e){return ia(this.store.get(e)).next(t=>(br("SimpleDb","GET",this.store.name,e,t=void 0===t?null:t),t))}delete(t){return br("SimpleDb","DELETE",this.store.name,t),ia(this.store.delete(t))}count(){return br("SimpleDb","COUNT",this.store.name),ia(this.store.count())}Lt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Bt(n,(t,e)=>{r.push(e)}).next(()=>r)}Ut(t,e){br("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.qt=!1;var r=this.cursor(n);return this.Bt(r,(t,e,n)=>n.delete())}Kt(t,e){let n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.Bt(r,e)}jt(s){const t=this.cursor({});return new Jo((n,r)=>{t.onerror=t=>{var e=aa(t.target.error);r(e)},t.onsuccess=t=>{const e=t.target.result;e?s(e.primaryKey,e.value).next(t=>{t?e.continue():n()}):n()}})}Bt(t,i){const o=[];return new Jo((s,e)=>{t.onerror=t=>{e(t.target.error)},t.onsuccess=t=>{const e=t.target.result;if(e){const n=new ea(e),r=i(e.primaryKey,e.value,n);if(r instanceof Jo){const t=r.catch(t=>(n.done(),Jo.reject(t)));o.push(t)}n.isDone?s():null===n.Ft?e.continue():e.continue(n.Ft)}else s()}}).next(()=>Jo.waitFor(o))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.qt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function ia(t){return new Jo((n,r)=>{t.onsuccess=t=>{var e=t.target.result;n(e)},t.onerror=t=>{var e=aa(t.target.error);r(e)}})}let oa=!1;function aa(t){const e=ta.Rt(d());if(12.2<=e&&e<13){const e="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(e)){const t=new Ar("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return oa||(oa=!0,setTimeout(()=>{throw t},0)),t}}return t}class ha extends Xo{constructor(t,e){super(),this.Qt=t,this.currentSequenceNumber=e}}function ca(t,e){var n=t;return ta.St(n.Qt,e)}class ua{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n=e.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(t.key)&&Ei(s,t,n[r])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Ti(e,t,this.localWriteTime);for(const n of this.mutations)n.key.isEqual(t.key)&&Ti(n,t,this.localWriteTime)}applyToLocalDocumentSet(r){this.mutations.forEach(t=>{const e=r.get(t.key),n=e;this.applyToLocalView(n),e.isValidDocument()||n.convertToNoDocument(Br.min())})}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),$i())}isEqual(t){return this.batchId===t.batchId&&Vr(this.mutations,t.mutations,(t,e)=>Ii(t,e))&&Vr(this.baseMutations,t.baseMutations,(t,e)=>Ii(t,e))}}class la{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){Sr(t.mutations.length===n.length);let r=ji;var s=t.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new la(t,e,n,r)}}class da{constructor(t,e,n,r,s=Br.min(),i=Br.min(),o=Yr.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new da(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new da(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new da(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class fa{constructor(t){this.Wt=t}}function ga(t,e){if(e.document)return yo(t.Wt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=os.fromSegments(e.noDocument.path),n=wa(e.noDocument.readTime),r=Es.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=os.fromSegments(e.unknownDocument.path),s=wa(e.unknownDocument.version);return Es.newUnknownDocument(t,s)}return _r()}function ma(t,e,n){var r=pa(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const i={name:co(n=t.Wt,(t=e).key),fields:t.data.value.mapValue.fields,updateTime:so(n,t.version.toTimestamp())},o=e.hasCommittedMutations;return new qo(null,null,i,o,r,s)}if(e.isNoDocument()){const a=e.key.path.toArray(),i=va(e.version),h=e.hasCommittedMutations;return new qo(null,new Vo(a,i),null,h,r,s)}if(e.isUnknownDocument()){const a=e.key.path.toArray(),i=va(e.version);return new qo(new Uo(a,i),null,null,!0,r,s)}return _r()}function pa(t){var e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function ya(t){var e=new qr(t[0],t[1]);return Br.fromTimestamp(e)}function va(t){var e=t.toTimestamp();return new Lo(e.seconds,e.nanoseconds)}function wa(t){var e=new qr(t.seconds,t.nanoseconds);return Br.fromTimestamp(e)}function ba(e,t){const n=(t.baseMutations||[]).map(t=>wo(e.Wt,t));for(let i=0;i<t.mutations.length-1;++i){const n=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const r=t.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map(t=>wo(e.Wt,t)),s=qr.fromMillis(t.localWriteTimeMs);return new ua(t.batchId,s,n,r)}function Ea(t){var e,n=wa(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?wa(t.lastLimboFreeSnapshotVersion):Br.min();let s;return s=void 0!==t.query.documents?(Sr(1===(e=t.query).documents.length),Ys(Ks(fo(e.documents[0])))):Ys(To(t.query)),new da(s,t.targetId,0,t.lastListenSequenceNumber,n,r,Yr.fromBase64String(t.resumeToken))}function Ta(t,e){var n=va(e.snapshotVersion),r=va(e.lastLimboFreeSnapshotVersion),s=(Ns(e.target)?bo:Eo)(t.Wt,e.target),i=e.resumeToken.toBase64();return new jo(e.targetId,_s(e.target),n,i,e.sequenceNumber,r,s)}function Ia(t){var e=To({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Xs(e,e.limit,"L"):e}class _a{getBundleMetadata(t,e){return Sa(t).get(e).next(t=>{if(t)return{id:(e=t).bundleId,createTime:wa(e.createTime),version:e.version};var e})}saveBundleMetadata(t,e){return Sa(t).put({bundleId:(n=e).id,createTime:va(oo(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Na(t).get(e).next(t=>{if(t)return{name:(e=t).name,query:Ia(e.bundledQuery),readTime:wa(e.readTime)};var e})}saveNamedQuery(t,e){return Na(t).put({name:(e=e).name,readTime:va(oo(e.readTime)),bundledQuery:e.bundledQuery})}}function Sa(t){return ca(t,zo.store)}function Na(t){return ca(t,Qo.store)}class Aa{constructor(){this.Gt=new Da}addToCollectionParentIndex(t,e){return this.Gt.add(e),Jo.resolve()}getCollectionParents(t,e){return Jo.resolve(this.Gt.getEntries(e))}}class Da{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Vi(Hr.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Vi(Hr.comparator)).toArray()}}class Ca{constructor(){this.zt=new Da}addToCollectionParentIndex(t,e){if(this.zt.has(e))return Jo.resolve();var n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener(()=>{this.zt.add(e)});r={collectionId:n,parent:xo(r)};return xa(t).put(r)}getCollectionParents(t,n){const r=[],e=IDBKeyRange.bound([n,""],[Ur(n),""],!1,!0);return xa(t).Lt(e).next(t=>{for(const e of t){if(e.collectionId!==n)break;r.push(Ro(e.parent))}return r})}}function xa(t){return ca(t,Go.store)}const ka={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ra{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Ra(t,Ra.DEFAULT_COLLECTION_PERCENTILE,Ra.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function La(t,e,n){const r=t.store(Fo.store),s=t.store(Po.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const h=r.Kt({range:o},(t,e,n)=>(a++,n.delete()));i.push(h.next(()=>{Sr(1===a)}));const c=[];for(const t of n.mutations){const r=Po.key(e,t.key.path,n.batchId);i.push(s.delete(r)),c.push(t.key)}return Jo.waitFor(i).next(()=>c)}function Oa(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw _r();e=t.noDocument}return JSON.stringify(e).length}Ra.DEFAULT_COLLECTION_PERCENTILE=10,Ra.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ra.DEFAULT=new Ra(41943040,Ra.DEFAULT_COLLECTION_PERCENTILE,Ra.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ra.DISABLED=new Ra(-1,0,0);class Ma{constructor(t,e,n,r){this.userId=t,this.N=e,this.Ht=n,this.referenceDelegate=r,this.Jt={}}static Yt(t,e,n,r){Sr(""!==t.uid);var s=t.isAuthenticated()?t.uid:"";return new Ma(s,e,n,r)}checkEmpty(t){let r=!0;var e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Pa(t).Kt({index:Fo.userMutationsIndex,range:e},(t,e,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(u,l,d,f){const g=Va(u),m=Pa(u);return m.add({}).next(t=>{Sr("number"==typeof t);const e=new ua(t,l,d,f),n=(s=this.N,i=this.userId,o=e,a=o.baseMutations.map(t=>vo(s.Wt,t)),h=o.mutations.map(t=>vo(s.Wt,t)),new Fo(i,o.batchId,o.localWriteTime.toMillis(),a,h)),r=[];var s,i,o,a,h;let c=new Vi((t,e)=>Pr(t.canonicalString(),e.canonicalString()));for(const u of f){const l=Po.key(this.userId,u.key.path,t);c=c.add(u.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Po.PLACEHOLDER))}return c.forEach(t=>{r.push(this.Ht.addToCollectionParentIndex(u,t))}),u.addOnCommittedListener(()=>{this.Jt[t]=e.keys()}),Jo.waitFor(r).next(()=>e)})}lookupMutationBatch(t,e){return Pa(t).get(e).next(t=>t?(Sr(t.userId===this.userId),ba(this.N,t)):null)}Xt(t,n){return this.Jt[n]?Jo.resolve(this.Jt[n]):this.lookupMutationBatch(t,n).next(t=>{if(t){var e=t.keys();return this.Jt[n]=e}return null})}getNextMutationBatchAfterBatchId(t,e){const r=e+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Pa(t).Kt({index:Fo.userMutationsIndex,range:n},(t,e,n)=>{e.userId===this.userId&&(Sr(e.batchId>=r),s=ba(this.N,e)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Pa(t).Kt({index:Fo.userMutationsIndex,range:e,reverse:!0},(t,e,n)=>{r=e.batchId,n.done()}).next(()=>r)}getAllMutationBatches(t){var e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Pa(t).Lt(Fo.userMutationsIndex,e).next(t=>t.map(t=>ba(this.N,t)))}getAllMutationBatchesAffectingDocumentKey(o,a){const t=Po.prefixForPath(this.userId,a.path),e=IDBKeyRange.lowerBound(t),h=[];return Va(o).Kt({range:e},(t,e,n)=>{var[r,s,i]=t,s=Ro(s);if(r===this.userId&&a.path.isEqual(s))return Pa(o).get(i).next(t=>{if(!t)throw _r();Sr(t.userId===this.userId),h.push(ba(this.N,t))});n.done()}).next(()=>h)}getAllMutationBatchesAffectingDocumentKeys(e,t){let a=new Vi(Pr);const n=[];return t.forEach(o=>{var t=Po.prefixForPath(this.userId,o.path),t=IDBKeyRange.lowerBound(t),t=Va(e).Kt({range:t},(t,e,n)=>{var[r,s,i]=t,s=Ro(s);r===this.userId&&o.path.isEqual(s)?a=a.add(i):n.done()});n.push(t)}),Jo.waitFor(n).next(()=>this.Zt(e,a))}getAllMutationBatchesAffectingQuery(t,e){const o=e.path,a=o.length+1,n=Po.prefixForPath(this.userId,o),r=IDBKeyRange.lowerBound(n);let h=new Vi(Pr);return Va(t).Kt({range:r},(t,e,n)=>{var[r,s,i]=t,s=Ro(s);r===this.userId&&o.isPrefixOf(s)?s.length===a&&(h=h.add(i)):n.done()}).next(()=>this.Zt(t,h))}Zt(e,t){const n=[],r=[];return t.forEach(t=>{r.push(Pa(e).get(t).next(t=>{if(null===t)throw _r();Sr(t.userId===this.userId),n.push(ba(this.N,t))}))}),Jo.waitFor(r).next(()=>n)}removeMutationBatch(e,n){return La(e.Qt,this.userId,n).next(t=>(e.addOnCommittedListener(()=>{this.te(n.batchId)}),Jo.forEach(t,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}te(t){delete this.Jt[t]}performConsistencyCheck(n){return this.checkEmpty(n).next(t=>{if(!t)return Jo.resolve();const e=IDBKeyRange.lowerBound(Po.prefixForUser(this.userId)),r=[];return Va(n).Kt({range:e},(t,e,n)=>{if(t[0]===this.userId){const e=Ro(t[1]);r.push(e)}else n.done()}).next(()=>{Sr(0===r.length)})})}containsKey(t,e){return Fa(t,this.userId,e)}ee(t){return Ua(t).get(this.userId).next(t=>t||new Mo(this.userId,-1,""))}}function Fa(t,i,e){const n=Po.prefixForPath(i,e.path),o=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return Va(t).Kt({range:r,qt:!0},(t,e,n)=>{var[r,s]=t;r===i&&s===o&&(a=!0),n.done()}).next(()=>a)}function Pa(t){return ca(t,Fo.store)}function Va(t){return ca(t,Po.store)}function Ua(t){return ca(t,Mo.store)}class qa{constructor(t){this.ne=t}next(){return this.ne+=2,this.ne}static se(){return new qa(0)}static ie(){return new qa(-1)}}class Ba{constructor(t,e){this.referenceDelegate=t,this.N=e}allocateTargetId(n){return this.re(n).next(t=>{const e=new qa(t.highestTargetId);return t.highestTargetId=e.next(),this.oe(n,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.re(t).next(t=>Br.fromTimestamp(new qr(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.re(t).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,n,r){return this.re(e).next(t=>(t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),this.oe(e,t)))}addTargetData(e,n){return this.ce(e,n).next(()=>this.re(e).next(t=>(t.targetCount+=1,this.ae(n,t),this.oe(e,t))))}updateTargetData(t,e){return this.ce(t,e)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>ja(e).delete(t.targetId)).next(()=>this.re(e)).next(t=>(Sr(0<t.targetCount),--t.targetCount,this.oe(e,t)))}removeTargets(r,s,i){let o=0;const a=[];return ja(r).Kt((t,e)=>{var n=Ea(e);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(o++,a.push(this.removeTargetData(r,n)))}).next(()=>Jo.waitFor(a)).next(()=>o)}forEachTarget(t,r){return ja(t).Kt((t,e)=>{var n=Ea(e);r(n)})}re(t){return Ka(t).get($o.key).next(t=>(Sr(null!==t),t))}oe(t,e){return Ka(t).put($o.key,e)}ce(t,e){return ja(t).put(Ta(this.N,e))}ae(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.re(t).next(t=>t.targetCount)}getTargetData(t,s){var e=_s(s),e=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]);let i=null;return ja(t).Kt({range:e,index:jo.queryTargetsIndexName},(t,e,n)=>{var r=Ea(e);Ss(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,t,r){const s=[],i=$a(n);return t.forEach(t=>{var e=xo(t.path);s.push(i.put(new Ko(r,e))),s.push(this.referenceDelegate.addReference(n,r,t))}),Jo.waitFor(s)}removeMatchingKeys(n,t,r){const s=$a(n);return Jo.forEach(t,t=>{var e=xo(t.path);return Jo.waitFor([s.delete([r,e]),this.referenceDelegate.removeReference(n,r,t)])})}removeMatchingKeysForTargetId(t,e){const n=$a(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=$a(t);let s=$i();return r.Kt({range:n,qt:!0},(t,e,n)=>{var r=Ro(t[1]),r=new os(r);s=s.add(r)}).next(()=>s)}containsKey(t,e){var n=xo(e.path),n=IDBKeyRange.bound([n],[Ur(n)],!1,!0);let r=0;return $a(t).Kt({index:Ko.documentTargetsIndex,qt:!0,range:n},([t],e,n)=>{0!==t&&(r++,n.done())}).next(()=>0<r)}Tt(t,e){return ja(t).get(e).next(t=>t?Ea(t):null)}}function ja(t){return ca(t,jo.store)}function Ka(t){return ca(t,$o.store)}function $a(t){return ca(t,Ko.store)}async function Ga(t){if(t.code!==Nr.FAILED_PRECONDITION||t.message!==Yo)throw t;br("LocalStore","Unexpectedly lost primary lease")}function Ha([t,e],[n,r]){var s=Pr(t,n);return 0===s?Pr(e,r):s}class za{constructor(t){this.ue=t,this.buffer=new Vi(Ha),this.he=0}le(){return++this.he}fe(t){var e=[t,this.le()];if(this.buffer.size<this.ue)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Ha(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Qa{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.de=!1,this.we=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this._e(t)}stop(){this.we&&(this.we.cancel(),this.we=null)}get started(){return null!==this.we}_e(t){var e=this.de?3e5:6e4;br("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.we=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.we=null,this.de=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){ra(t)?br("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Ga(t)}await this._e(t)})}}class Wa{constructor(t,e){this.me=t,this.params=e}calculateTargetCount(t,e){return this.me.ge(t).next(t=>Math.floor(e/100*t))}nthSequenceNumber(t,e){if(0===e)return Jo.resolve(Mr.T);const n=new za(e);return this.me.forEachTarget(t,t=>n.fe(t.sequenceNumber)).next(()=>this.me.ye(t,t=>n.fe(t))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.me.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.me.removeOrphanedDocuments(t,e)}collect(e,n){return-1===this.params.cacheSizeCollectionThreshold?(br("LruGarbageCollector","Garbage collection skipped; disabled"),Jo.resolve(ka)):this.getCacheSize(e).next(t=>t<this.params.cacheSizeCollectionThreshold?(br("LruGarbageCollector",`Garbage collection skipped; Cache size ${t} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ka):this.pe(e,n))}getCacheSize(t){return this.me.getCacheSize(t)}pe(e,n){let r,s,i,o,a,h,c;const u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(s=t>this.params.maximumSequenceNumbersToCollect?(br("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),this.params.maximumSequenceNumbersToCollect):t,o=Date.now(),this.nthSequenceNumber(e,s))).next(t=>(r=t,a=Date.now(),this.removeTargets(e,r,n))).next(t=>(i=t,h=Date.now(),this.removeOrphanedDocuments(e,r))).next(t=>(c=Date.now(),wr()<=l.DEBUG&&br("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-u}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${i} targets in `+(h-a)+"ms\n"+`\tRemoved ${t} documents in `+(c-h)+"ms\n"+`Total Duration: ${c-u}ms`),Jo.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:t})))}}class Ya{constructor(t,e){this.db=t,this.garbageCollector=(t=this,e=e,new Wa(t,e))}ge(t){const n=this.Te(t);return this.db.getTargetCache().getTargetCount(t).next(e=>n.next(t=>e+t))}Te(t){let e=0;return this.ye(t,t=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ye(t,n){return this.Ee(t,(t,e)=>n(e))}addReference(t,e,n){return Xa(t,n)}removeReference(t,e,n){return Xa(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Xa(t,e)}Ie(e,n){let r=!1;return Ua(e).jt(t=>Fa(e,t,n).next(t=>(t&&(r=!0),Jo.resolve(!t)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let o=0;return this.Ee(n,(e,t)=>{if(t<=r){const r=this.Ie(n,e).next(t=>{if(!t)return o++,s.getEntry(n,e).next(()=>(s.removeEntry(e),$a(n).delete([0,xo(e.path)])))});i.push(r)}}).next(()=>Jo.waitFor(i)).next(()=>s.apply(n)).next(()=>o)}removeTarget(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Xa(t,e)}Ee(t,r){const e=$a(t);let s,i=Mr.T;return e.Kt({index:Ko.documentTargetsIndex},([t],{path:e,sequenceNumber:n})=>{0===t?(i!==Mr.T&&r(new os(Ro(s)),i),i=n,s=e):i=Mr.T}).next(()=>{i!==Mr.T&&r(new os(Ro(s)),i)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Xa(t,e){return $a(t).put((e=e,t=t.currentSequenceNumber,new Ko(0,xo(e.path),t)))}class Ja{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(e,n){const t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let t=0;t<r.length;t++)if(this.equalsFn(r[t][0],e))return void(r[t]=[e,n]);r.push([e,n])}else this.inner[t]=[[e,n]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1}forEach(r){Kr(this.inner,(t,e)=>{for(const[t,n]of e)r(t,n)})}isEmpty(){return $r(this.inner)}}class Za{constructor(){this.changes=new Ja(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}getReadTime(t){var e=this.changes.get(t);return e?e.readTime:Br.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:Es.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?Jo.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class th{constructor(t,e){this.N=t,this.Ht=e}addEntry(t,e,n){return rh(t).put(sh(e),n)}removeEntry(t,e){const n=rh(t),r=sh(e);return n.delete(r)}updateMetadata(e,n){return this.getMetadata(e).next(t=>(t.byteSize+=n,this.Ae(e,t)))}getEntry(t,e){return rh(t).get(sh(e)).next(t=>this.Re(e,t))}be(t,e){return rh(t).get(sh(e)).next(t=>({document:this.Re(e,t),size:Oa(t)}))}getEntries(t,e){let r=qi;return this.Pe(t,e,(t,e)=>{var n=this.Re(t,e);r=r.insert(t,n)}).next(()=>r)}ve(t,e){let r=qi,s=new Mi(os.comparator);return this.Pe(t,e,(t,e)=>{var n=this.Re(t,e);r=r.insert(t,n),s=s.insert(t,Oa(e))}).next(()=>({documents:r,Ve:s}))}Pe(t,e,s){if(e.isEmpty())return Jo.resolve();const n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator();let o=i.getNext();return rh(t).Kt({range:n},(t,e,n)=>{for(var r=os.fromSegments(t);o&&os.comparator(o,r)<0;)s(o,null),o=i.getNext();o&&o.isEqual(r)&&(s(o,e),o=i.hasNext()?i.getNext():null),o?n.Mt(o.path.toArray()):n.done()}).next(()=>{for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(t,s,e){let i=qi;const o=s.path.length+1,n={};if(e.isEqual(Br.min())){const t=s.path.toArray();n.range=IDBKeyRange.lowerBound(t)}else{const t=s.path.toArray(),i=pa(e);n.range=IDBKeyRange.lowerBound([t,i],!0),n.index=qo.collectionReadTimeIndex}return rh(t).Kt(n,(t,e,n)=>{var r;t.length===o&&(r=ga(this.N,e),s.path.isPrefixOf(r.key.path)?ei(s,r)&&(i=i.insert(r.key,r)):n.done())}).next(()=>i)}newChangeBuffer(t){return new eh(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(t=>t.byteSize)}getMetadata(t){return nh(t).get(Bo.key).next(t=>(Sr(!!t),t))}Ae(t,e){return nh(t).put(Bo.key,e)}Re(t,e){if(e){const t=ga(this.N,e);if(!t.isNoDocument()||!t.version.isEqual(Br.min()))return t}return Es.newInvalidDocument(t)}}class eh extends Za{constructor(t,e){super(),this.Se=t,this.trackRemovals=e,this.De=new Ja(t=>t.toString(),(t,e)=>t.isEqual(e))}applyChanges(i){const o=[];let a=0,h=new Vi((t,e)=>Pr(t.canonicalString(),e.canonicalString()));return this.changes.forEach((t,e)=>{var n=this.De.get(t);if(e.document.isValidDocument()){var r=ma(this.Se.N,e.document,this.getReadTime(t));h=h.add(t.path.popLast());var s=Oa(r);a+=s-n,o.push(this.Se.addEntry(i,t,r))}else if(a-=n,this.trackRemovals){const a=ma(this.Se.N,Es.newNoDocument(t,Br.min()),this.getReadTime(t));o.push(this.Se.addEntry(i,t,a))}else o.push(this.Se.removeEntry(i,t))}),h.forEach(t=>{o.push(this.Se.Ht.addToCollectionParentIndex(i,t))}),o.push(this.Se.updateMetadata(i,a)),Jo.waitFor(o)}getFromCache(t,e){return this.Se.be(t,e).next(t=>(this.De.set(e,t.size),t.document))}getAllFromCache(t,e){return this.Se.ve(t,e).next(({documents:t,Ve:e})=>(e.forEach((t,e)=>{this.De.set(t,e)}),t))}}function nh(t){return ca(t,Bo.store)}function rh(t){return ca(t,qo.store)}function sh(t){return t.path.toArray()}class ih{constructor(t){this.N=t}Ct(e,n,t,r){Sr(t<r&&0<=t&&r<=11);const s=new Zo("createOrUpgrade",n);var i;t<1&&1<=r&&(e.createObjectStore(Oo.store),(i=e).createObjectStore(Mo.store,{keyPath:Mo.keyPath}),i.createObjectStore(Fo.store,{keyPath:Fo.keyPath,autoIncrement:!0}).createIndex(Fo.userMutationsIndex,Fo.userMutationsKeyPath,{unique:!0}),i.createObjectStore(Po.store),oh(e),e.createObjectStore(qo.store));let o=Jo.resolve();return t<3&&3<=r&&(0!==t&&((i=e).deleteObjectStore(Ko.store),i.deleteObjectStore(jo.store),i.deleteObjectStore($o.store),oh(e)),o=o.next(()=>function(){const t=s.store($o.store),e=new $o(0,0,Br.min().toTimestamp(),0);return t.put($o.key,e)}())),t<4&&4<=r&&(0!==t&&(o=o.next(()=>function(r,s){return s.store(Fo.store).Lt().next(t=>{r.deleteObjectStore(Fo.store),r.createObjectStore(Fo.store,{keyPath:Fo.keyPath,autoIncrement:!0}).createIndex(Fo.userMutationsIndex,Fo.userMutationsKeyPath,{unique:!0});const e=s.store(Fo.store),n=t.map(t=>e.put(t));return Jo.waitFor(n)})}(e,s))),o=o.next(()=>{e.createObjectStore(Ho.store,{keyPath:Ho.keyPath})})),t<5&&5<=r&&(o=o.next(()=>this.Ce(s))),t<6&&6<=r&&(o=o.next(()=>(e.createObjectStore(Bo.store),this.Ne(s)))),t<7&&7<=r&&(o=o.next(()=>this.xe(s))),t<8&&8<=r&&(o=o.next(()=>this.ke(e,s))),t<9&&9<=r&&(o=o.next(()=>{var t;(t=e).objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges"),function(){const t=n.objectStore(qo.store);t.createIndex(qo.readTimeIndex,qo.readTimeIndexPath,{unique:!1}),t.createIndex(qo.collectionReadTimeIndex,qo.collectionReadTimeIndexPath,{unique:!1})}()})),t<10&&10<=r&&(o=o.next(()=>this.$e(s))),t<11&&11<=r&&(o=o.next(()=>{e.createObjectStore(zo.store,{keyPath:zo.keyPath}),e.createObjectStore(Qo.store,{keyPath:Qo.keyPath})})),o}Ne(e){let n=0;return e.store(qo.store).Kt((t,e)=>{n+=Oa(e)}).next(()=>{var t=new Bo(n);return e.store(Bo.store).put(Bo.key,t)})}Ce(r){const t=r.store(Mo.store),e=r.store(Fo.store);return t.Lt().next(t=>Jo.forEach(t,n=>{var t=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return e.Lt(Fo.userMutationsIndex,t).next(t=>Jo.forEach(t,t=>{Sr(t.userId===n.userId);var e=ba(this.N,t);return La(r,n.userId,e).next(()=>{})}))}))}xe(t){const o=t.store(Ko.store),e=t.store(qo.store);return t.store($o.store).get($o.key).next(s=>{const i=[];return e.Kt((t,e)=>{const n=new Hr(t),r=[0,xo(n)];i.push(o.get(r).next(t=>t?Jo.resolve():(t=>o.put(new Ko(0,xo(t),s.highestListenSequenceNumber)))(n)))}).next(()=>Jo.waitFor(i))})}ke(t,e){t.createObjectStore(Go.store,{keyPath:Go.keyPath});const n=e.store(Go.store),r=new Da,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:xo(r)})}};return e.store(qo.store).Kt({qt:!0},(t,e)=>{const n=new Hr(t);return s(n.popLast())}).next(()=>e.store(Po.store).Kt({qt:!0},([,t],e)=>{const n=Ro(t);return s(n.popLast())}))}$e(t){const r=t.store(jo.store);return r.Kt((t,e)=>{var n=Ea(e),n=Ta(this.N,n);return r.put(n)})}}function oh(t){t.createObjectStore(Ko.store,{keyPath:Ko.keyPath}).createIndex(Ko.documentTargetsIndex,Ko.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(jo.store,{keyPath:jo.keyPath}).createIndex(jo.queryTargetsIndexName,jo.queryTargetsKeyPath,{unique:!0}),t.createObjectStore($o.store)}const ah="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class hh{constructor(t,e,n,r,s,i,o,a,h,c){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Oe=s,this.window=i,this.document=o,this.Fe=h,this.Me=c,this.Le=null,this.Be=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ue=null,this.inForeground=!1,this.qe=null,this.Ke=null,this.je=Number.NEGATIVE_INFINITY,this.Qe=t=>Promise.resolve(),!hh.bt())throw new Ar(Nr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ya(this,r),this.We=e+"main",this.N=new fa(a),this.Ge=new ta(this.We,11,new ih(this.N)),this.ze=new Ba(this.referenceDelegate,this.N),this.Ht=new Ca,this.He=(e=this.N,a=this.Ht,new th(e,a)),this.Je=new _a,this.window&&this.window.localStorage?this.Ye=this.window.localStorage:(this.Ye=null,!1===c&&Er("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Xe().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Ar(Nr.FAILED_PRECONDITION,ah);return this.Ze(),this.tn(),this.en(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.ze.getHighestSequenceNumber(t))}).then(t=>{this.Le=new Mr(t,this.Fe)}).then(()=>{this.Be=!0}).catch(t=>(this.Ge&&this.Ge.close(),Promise.reject(t)))}nn(e){return this.Qe=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ge.xt(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Oe.enqueueAndForget(async()=>{this.started&&await this.Xe()}))}Xe(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>uh(e).put(new Ho(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.sn(e).next(t=>{t||(this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)))})}).next(()=>this.rn(e)).next(t=>this.isPrimary&&!t?this.on(e).next(()=>!1):!!t&&this.cn(e).next(()=>!0))).catch(t=>{if(ra(t))return br("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return br("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.Oe.enqueueRetryable(()=>this.Qe(t)),this.isPrimary=t})}sn(t){return ch(t).get(Oo.key).next(t=>Jo.resolve(this.an(t)))}un(t){return uh(t).delete(this.clientId)}async hn(){if(this.isPrimary&&!this.ln(this.je,18e5)){this.je=Date.now();var t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{const r=ca(t,Ho.store);return r.Lt().next(t=>{const e=this.fn(t,18e5),n=t.filter(t=>-1===e.indexOf(t));return Jo.forEach(n,t=>r.delete(t.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ye)for(const e of t)this.Ye.removeItem(this.dn(e.clientId))}}en(){this.Ke=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Xe().then(()=>this.hn()).then(()=>this.en()))}an(t){return!!t&&t.ownerId===this.clientId}rn(e){return this.Me?Jo.resolve(!0):ch(e).get(Oo.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)){if(this.an(t)&&this.networkEnabled)return!0;if(!this.an(t)){if(!t.allowTabSynchronization)throw new Ar(Nr.FAILED_PRECONDITION,ah);return!1}}return!(!this.networkEnabled||!this.inForeground)||uh(e).Lt().next(t=>void 0===this.fn(t,5e3).find(t=>{if(this.clientId!==t.clientId){var e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))}).next(t=>(this.isPrimary!==t&&br("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}async shutdown(){this.Be=!1,this._n(),this.Ke&&(this.Ke.cancel(),this.Ke=null),this.mn(),this.gn(),await this.Ge.runTransaction("shutdown","readwrite",[Oo.store,Ho.store],t=>{const e=new ha(t,Mr.T);return this.on(e).next(()=>this.un(e))}),this.Ge.close(),this.yn()}fn(t,e){return t.filter(t=>this.ln(t.updateTimeMs,e)&&!this.wn(t.clientId))}pn(){return this.runTransaction("getActiveClients","readonly",t=>uh(t).Lt().next(t=>this.fn(t,18e5).map(t=>t.clientId)))}get started(){return this.Be}getMutationQueue(t){return Ma.Yt(t,this.N,this.Ht,this.referenceDelegate)}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getIndexManager(){return this.Ht}getBundleCache(){return this.Je}runTransaction(e,n,r){br("IndexedDbPersistence","Starting transaction:",e);let s;return this.Ge.runTransaction(e,"readonly"===n?"readonly":"readwrite",Wo,t=>(s=new ha(t,this.Le?this.Le.next():Mr.T),"readwrite-primary"===n?this.sn(s).next(t=>!!t||this.rn(s)).next(t=>{if(!t)throw Er(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)),new Ar(Nr.FAILED_PRECONDITION,Yo);return r(s)}).next(t=>this.cn(s).next(()=>t)):this.Tn(s).next(()=>r(s)))).then(t=>(s.raiseOnCommittedEvent(),t))}Tn(t){return ch(t).get(Oo.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)&&!this.an(t)&&!(this.Me||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Ar(Nr.FAILED_PRECONDITION,ah)})}cn(t){var e=new Oo(this.clientId,this.allowTabSynchronization,Date.now());return ch(t).put(Oo.key,e)}static bt(){return ta.bt()}on(t){const e=ch(t);return e.get(Oo.key).next(t=>this.an(t)?(br("IndexedDbPersistence","Releasing primary lease."),e.delete(Oo.key)):Jo.resolve())}ln(t,e){var n=Date.now();return!(t<n-e||n<t&&(Er(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ze(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.qe=()=>{this.Oe.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Xe()))},this.document.addEventListener("visibilitychange",this.qe),this.inForeground="visible"===this.document.visibilityState)}mn(){this.qe&&(this.document.removeEventListener("visibilitychange",this.qe),this.qe=null)}tn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Ue=()=>{this._n(),s()&&navigator.appVersion.match("Version/14")&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ue))}gn(){this.Ue&&(this.window.removeEventListener("pagehide",this.Ue),this.Ue=null)}wn(t){var e;try{var n=null!==(null===(e=this.Ye)||void 0===e?void 0:e.getItem(this.dn(t)));return br("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Er("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}_n(){if(this.Ye)try{this.Ye.setItem(this.dn(this.clientId),String(Date.now()))}catch(t){Er("Failed to set zombie client id.",t)}}yn(){if(this.Ye)try{this.Ye.removeItem(this.dn(this.clientId))}catch(t){}}dn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function ch(t){return ca(t,Oo.store)}function uh(t){return ca(t,Ho.store)}function lh(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class dh{constructor(t,e){this.progress=t,this.En=e}}class fh{constructor(t,e,n){this.He=t,this.In=e,this.Ht=n}An(e,n){return this.In.getAllMutationBatchesAffectingDocumentKey(e,n).next(t=>this.Rn(e,n,t))}Rn(t,e,n){return this.He.getEntry(t,e).next(t=>{for(const e of n)e.applyToLocalView(t);return t})}bn(t,n){t.forEach((t,e)=>{for(const t of n)t.applyToLocalView(e)})}Pn(e,t){return this.He.getEntries(e,t).next(t=>this.vn(e,t).next(()=>t))}vn(t,e){return this.In.getAllMutationBatchesAffectingDocumentKeys(t,e).next(t=>this.bn(e,t))}getDocumentsMatchingQuery(t,e,n){return r=e,os.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.Vn(t,e.path):Qs(e)?this.Sn(t,e,n):this.Dn(t,e,n);var r}Vn(t,e){return this.An(t,new os(e)).next(t=>{let e=Bi;return t.isFoundDocument()&&(e=e.insert(t.key,t)),e})}Sn(r,s,i){const o=s.collectionGroup;let a=Bi;return this.Ht.getCollectionParents(r,o).next(t=>Jo.forEach(t,t=>{var e,n=(e=s,t=t.child(o),new Bs(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt));return this.Dn(r,n,i).next(t=>{t.forEach((t,e)=>{a=a.insert(t,e)})})}).next(()=>a))}Dn(e,n,t){let s,i;return this.He.getDocumentsMatchingQuery(e,n,t).next(t=>(s=t,this.In.getAllMutationBatchesAffectingQuery(e,n))).next(t=>(i=t,this.Cn(e,i,s).next(e=>{s=e;for(const e of i)for(const r of e.mutations){var n=r.key;let t=s.get(n);null==t&&(t=Es.newInvalidDocument(n),s=s.insert(n,t)),Ti(r,t,e.localWriteTime),t.isFoundDocument()||(s=s.remove(n))}}))).next(()=>(s.forEach((t,e)=>{ei(n,e)||(s=s.remove(t))}),s))}Cn(t,e,n){let r=$i();for(const t of e)for(const e of t.mutations)e instanceof Ni&&null===n.get(e.key)&&(r=r.add(e.key));let s=n;return this.He.getEntries(t,r).next(t=>(t.forEach((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))}),s))}}class gh{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Nn=n,this.xn=r}static kn(t,e){let n=$i(),r=$i();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new gh(t,e.fromCache,n,r)}}class mh{$n(t){this.On=t}getDocumentsMatchingQuery(e,r,s,i){return 0===(t=r).filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())||s.isEqual(Br.min())?this.Fn(e,r):this.On.Pn(e,i).next(t=>{const n=this.Mn(r,t);return($s(r)||Gs(r))&&this.Ln(r.limitType,n,i,s)?this.Fn(e,r):(wr()<=l.DEBUG&&br("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),ti(r)),this.On.getDocumentsMatchingQuery(e,r,s).next(e=>(n.forEach(t=>{e=e.insert(t.key,t)}),e)))});var t}Mn(n,t){let r=new Vi(ni(n));return t.forEach((t,e)=>{ei(n,e)&&(r=r.add(e))}),r}Ln(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Fn(t,e){return wr()<=l.DEBUG&&br("QueryEngine","Using full collection scan to execute query:",ti(e)),this.On.getDocumentsMatchingQuery(t,e,Br.min())}}class ph{constructor(t,e,n,r){this.persistence=t,this.Bn=e,this.N=r,this.Un=new Mi(Pr),this.qn=new Ja(t=>_s(t),Ss),this.Kn=Br.min(),this.In=t.getMutationQueue(n),this.jn=t.getRemoteDocumentCache(),this.ze=t.getTargetCache(),this.Qn=new fh(this.jn,this.In,this.persistence.getIndexManager()),this.Je=t.getBundleCache(),this.Bn.$n(this.Qn)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Un))}}function yh(t,e,n,r){return new ph(t,e,n,r)}async function vh(t,e){const n=t;let r=n.In,o=n.Qn;var s=await n.persistence.runTransaction("Handle user change","readonly",s=>{let i;return n.In.getAllMutationBatches(s).next(t=>(i=t,r=n.persistence.getMutationQueue(e),o=new fh(n.jn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(s))).next(t=>{const e=[],n=[];let r=$i();for(const s of i){e.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}for(const s of t){n.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}return o.Pn(s,r).next(t=>({Wn:t,removedBatchIds:e,addedBatchIds:n}))})});return n.In=r,n.Qn=o,n.Bn.$n(n.Qn),s}function wh(t){const e=t;return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.ze.getLastRemoteSnapshotVersion(t))}function bh(t,n){const u=t,l=n.snapshotVersion;let d=u.Un;return u.persistence.runTransaction("Apply remote event","readwrite-primary",h=>{const t=u.jn.newChangeBuffer({trackRemovals:!0});d=u.Un;const c=[];n.targetChanges.forEach((t,e)=>{const n=d.get(e);if(n){c.push(u.ze.removeMatchingKeys(h,t.removedDocuments,e).next(()=>u.ze.addMatchingKeys(h,t.addedDocuments,e)));const a=t.resumeToken;var r,s,i,o;0<a.approximateByteSize()&&(r=n.withResumeToken(a,l).withSequenceNumber(h.currentSequenceNumber),d=d.insert(e,r),s=n,o=t,Sr(0<(i=r).resumeToken.approximateByteSize()),0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<o.addedDocuments.size+o.modifiedDocuments.size+o.removedDocuments.size)||c.push(u.ze.updateTargetData(h,r)))}});let e=qi;if(n.documentUpdates.forEach((t,e)=>{n.resolvedLimboDocuments.has(t)&&c.push(u.persistence.referenceDelegate.updateLimboDocument(h,t))}),c.push(Eh(h,t,n.documentUpdates,l,void 0).next(t=>{e=t})),!l.isEqual(Br.min())){const n=u.ze.getLastRemoteSnapshotVersion(h).next(t=>u.ze.setTargetsMetadata(h,h.currentSequenceNumber,l));c.push(n)}return Jo.waitFor(c).next(()=>t.apply(h)).next(()=>u.Qn.vn(h,e)).next(()=>e)}).then(t=>(u.Un=d,t))}function Eh(t,o,e,a,h){let n=$i();return e.forEach(t=>n=n.add(t)),o.getEntries(t,n).next(s=>{let i=qi;return e.forEach((t,e)=>{const n=s.get(t),r=(null==h?void 0:h.get(t))||a;e.isNoDocument()&&e.version.isEqual(Br.min())?(o.removeEntry(t,r),i=i.insert(t,e)):!n.isValidDocument()||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(o.addEntry(e,r),i=i.insert(t,e)):br("LocalStore","Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version)}),i})}function Th(t,r){const s=t;return s.persistence.runTransaction("Allocate target","readwrite",e=>{let n;return s.ze.getTargetData(e,r).next(t=>t?(n=t,Jo.resolve(n)):s.ze.allocateTargetId(e).next(t=>(n=new da(r,t,0,e.currentSequenceNumber),s.ze.addTargetData(e,n).next(()=>n))))}).then(t=>{var e=s.Un.get(t.targetId);return(null===e||0<t.snapshotVersion.compareTo(e.snapshotVersion))&&(s.Un=s.Un.insert(t.targetId,t),s.qn.set(r,t.targetId)),t})}async function Ih(t,e,n){const r=t,s=r.Un.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,t=>r.persistence.referenceDelegate.removeTarget(t,s))}catch(t){if(!ra(t))throw t;br("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Un=r.Un.remove(e),r.qn.delete(s.target)}function _h(t,n,r){const s=t;let i=Br.min(),o=$i();return s.persistence.runTransaction("Execute query","readonly",e=>function(t,e,n){const r=t,s=r.qn.get(n);return void 0!==s?Jo.resolve(r.Un.get(s)):r.ze.getTargetData(e,n)}(s,e,Ys(n)).next(t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,s.ze.getMatchingKeysForTargetId(e,t.targetId).next(t=>{o=t})}).next(()=>s.Bn.getDocumentsMatchingQuery(e,n,r?i:Br.min(),r?o:$i())).next(t=>({documents:t,Gn:o})))}function Sh(t,e){const n=t,r=n.ze,s=n.Un.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",t=>r.Tt(t,e).next(t=>t?t.target:null))}function Nh(t){const n=t;return n.persistence.runTransaction("Get new document changes","readonly",t=>function(t,e,n){const r=t;let s=qi,i=pa(n);const o=rh(e),a=IDBKeyRange.lowerBound(i,!0);return o.Kt({index:qo.readTimeIndex,range:a},(t,e)=>{var n=ga(r.N,e);s=s.insert(n.key,n),i=e.readTime}).next(()=>({En:s,readTime:ya(i)}))}(n.jn,t,n.Kn)).then(({En:t,readTime:e})=>(n.Kn=e,t))}class Ah{constructor(t){this.N=t,this.Yn=new Map,this.Xn=new Map}getBundleMetadata(t,e){return Jo.resolve(this.Yn.get(e))}saveBundleMetadata(t,e){return this.Yn.set(e.id,{id:e.id,version:e.version,createTime:oo(e.createTime)}),Jo.resolve()}getNamedQuery(t,e){return Jo.resolve(this.Xn.get(e))}saveNamedQuery(t,e){return this.Xn.set(e.name,{name:(e=e).name,query:Ia(e.bundledQuery),readTime:oo(e.readTime)}),Jo.resolve()}}class Dh{constructor(){this.Zn=new Vi(Ch.ts),this.es=new Vi(Ch.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){var n=new Ch(t,e);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(t,e){t.forEach(t=>this.addReference(t,e))}removeReference(t,e){this.rs(new Ch(t,e))}os(t,e){t.forEach(t=>this.removeReference(t,e))}cs(t){const e=new os(new Hr([])),n=new Ch(e,t),r=new Ch(e,t+1),s=[];return this.es.forEachInRange([n,r],t=>{this.rs(t),s.push(t.key)}),s}us(){this.Zn.forEach(t=>this.rs(t))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){var e=new os(new Hr([])),n=new Ch(e,t),e=new Ch(e,t+1);let r=$i();return this.es.forEachInRange([n,e],t=>{r=r.add(t.key)}),r}containsKey(t){var e=new Ch(t,0),e=this.Zn.firstAfterOrEqual(e);return null!==e&&t.isEqual(e.key)}}class Ch{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return os.comparator(t.key,e.key)||Pr(t.ls,e.ls)}static ns(t,e){return Pr(t.ls,e.ls)||os.comparator(t.key,e.key)}}class xh{constructor(t,e){this.Ht=t,this.referenceDelegate=e,this.In=[],this.fs=1,this.ds=new Vi(Ch.ts)}checkEmpty(t){return Jo.resolve(0===this.In.length)}addMutationBatch(t,e,n,r){var s=this.fs;this.fs++,0<this.In.length&&this.In[this.In.length-1];var i=new ua(s,e,n,r);this.In.push(i);for(const e of r)this.ds=this.ds.add(new Ch(e.key,s)),this.Ht.addToCollectionParentIndex(t,e.key.path.popLast());return Jo.resolve(i)}lookupMutationBatch(t,e){return Jo.resolve(this.ws(e))}getNextMutationBatchAfterBatchId(t,e){var n=this._s(e+1),n=n<0?0:n;return Jo.resolve(this.In.length>n?this.In[n]:null)}getHighestUnacknowledgedBatchId(){return Jo.resolve(0===this.In.length?-1:this.fs-1)}getAllMutationBatches(t){return Jo.resolve(this.In.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Ch(e,0),r=new Ch(e,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],t=>{var e=this.ws(t.ls);s.push(e)}),Jo.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let r=new Vi(Pr);return e.forEach(t=>{var e=new Ch(t,0),n=new Ch(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,n],t=>{r=r.add(t.ls)})}),Jo.resolve(this.gs(r))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;os.isDocumentKey(s)||(s=s.child(""));var i=new Ch(new os(s),0);let o=new Vi(Pr);return this.ds.forEachWhile(t=>{var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.ls)),!0)},i),Jo.resolve(this.gs(o))}gs(t){const n=[];return t.forEach(t=>{var e=this.ws(t);null!==e&&n.push(e)}),n}removeMutationBatch(n,r){Sr(0===this.ys(r.batchId,"removed")),this.In.shift();let s=this.ds;return Jo.forEach(r.mutations,t=>{var e=new Ch(t.key,r.batchId);return s=s.delete(e),this.referenceDelegate.markPotentiallyOrphaned(n,t.key)}).next(()=>{this.ds=s})}te(t){}containsKey(t,e){var n=new Ch(e,0),n=this.ds.firstAfterOrEqual(n);return Jo.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.In.length,Jo.resolve()}ys(t,e){return this._s(t)}_s(t){return 0===this.In.length?0:t-this.In[0].batchId}ws(t){var e=this._s(t);return e<0||e>=this.In.length?null:this.In[e]}}class kh{constructor(t,e){this.Ht=t,this.ps=e,this.docs=new Mi(os.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.ps(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:o,readTime:n}),this.size+=o-i,this.Ht.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Jo.resolve(n?n.document.clone():Es.newInvalidDocument(e))}getEntries(t,e){let n=qi;return e.forEach(t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.clone():Es.newInvalidDocument(t))}),Jo.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=qi;const s=new os(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||ei(e,s)&&(r=r.insert(s.key,s.clone()))}return Jo.resolve(r)}Ts(t,e){return Jo.forEach(this.docs,t=>e(t))}newChangeBuffer(t){return new Rh(this)}getSize(t){return Jo.resolve(this.size)}}class Rh extends Za{constructor(t){super(),this.Se=t}applyChanges(n){const r=[];return this.changes.forEach((t,e)=>{e.document.isValidDocument()?r.push(this.Se.addEntry(n,e.document,this.getReadTime(t))):this.Se.removeEntry(t)}),Jo.waitFor(r)}getFromCache(t,e){return this.Se.getEntry(t,e)}getAllFromCache(t,e){return this.Se.getEntries(t,e)}}class Lh{constructor(t){this.persistence=t,this.Es=new Ja(t=>_s(t),Ss),this.lastRemoteSnapshotVersion=Br.min(),this.highestTargetId=0,this.Is=0,this.As=new Dh,this.targetCount=0,this.Rs=qa.se()}forEachTarget(t,n){return this.Es.forEach((t,e)=>n(e)),Jo.resolve()}getLastRemoteSnapshotVersion(t){return Jo.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Jo.resolve(this.Is)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),Jo.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Is&&(this.Is=e),Jo.resolve()}ce(t){this.Es.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.Rs=new qa(e),this.highestTargetId=e),t.sequenceNumber>this.Is&&(this.Is=t.sequenceNumber)}addTargetData(t,e){return this.ce(e),this.targetCount+=1,Jo.resolve()}updateTargetData(t,e){return this.ce(e),Jo.resolve()}removeTargetData(t,e){return this.Es.delete(e.target),this.As.cs(e.targetId),--this.targetCount,Jo.resolve()}removeTargets(n,r,s){let i=0;const o=[];return this.Es.forEach((t,e)=>{e.sequenceNumber<=r&&null===s.get(e.targetId)&&(this.Es.delete(t),o.push(this.removeMatchingKeysForTargetId(n,e.targetId)),i++)}),Jo.waitFor(o).next(()=>i)}getTargetCount(t){return Jo.resolve(this.targetCount)}getTargetData(t,e){var n=this.Es.get(e)||null;return Jo.resolve(n)}addMatchingKeys(t,e,n){return this.As.ss(e,n),Jo.resolve()}removeMatchingKeys(e,t,n){this.As.os(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),Jo.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.As.cs(e),Jo.resolve()}getMatchingKeysForTargetId(t,e){var n=this.As.hs(e);return Jo.resolve(n)}containsKey(t,e){return Jo.resolve(this.As.containsKey(e))}}class Oh{constructor(t,e){var n;this.bs={},this.Le=new Mr(0),this.Be=!1,this.Be=!0,this.referenceDelegate=t(this),this.ze=new Lh(this),this.Ht=new Aa,this.He=(n=this.Ht,t=t=>this.referenceDelegate.Ps(t),new kh(n,t)),this.N=new fa(e),this.Je=new Ah(this.N)}start(){return Promise.resolve()}shutdown(){return this.Be=!1,Promise.resolve()}get started(){return this.Be}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Ht}getMutationQueue(t){let e=this.bs[t.toKey()];return e||(e=new xh(this.Ht,this.referenceDelegate),this.bs[t.toKey()]=e),e}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getBundleCache(){return this.Je}runTransaction(t,e,n){br("MemoryPersistence","Starting transaction:",t);const r=new Mh(this.Le.next());return this.referenceDelegate.vs(),n(r).next(t=>this.referenceDelegate.Vs(r).next(()=>t)).toPromise().then(t=>(r.raiseOnCommittedEvent(),t))}Ss(e,n){return Jo.or(Object.values(this.bs).map(t=>()=>t.containsKey(e,n)))}}class Mh extends Xo{constructor(t){super(),this.currentSequenceNumber=t}}class Fh{constructor(t){this.persistence=t,this.Ds=new Dh,this.Cs=null}static Ns(t){return new Fh(t)}get xs(){if(this.Cs)return this.Cs;throw _r()}addReference(t,e,n){return this.Ds.addReference(n,e),this.xs.delete(n.toString()),Jo.resolve()}removeReference(t,e,n){return this.Ds.removeReference(n,e),this.xs.add(n.toString()),Jo.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),Jo.resolve()}removeTarget(t,e){this.Ds.cs(e.targetId).forEach(t=>this.xs.add(t.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(t=>{t.forEach(t=>this.xs.add(t.toString()))}).next(()=>n.removeTargetData(t,e))}vs(){this.Cs=new Set}Vs(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Jo.forEach(this.xs,t=>{const e=os.fromPath(t);return this.ks(n,e).next(t=>{t||r.removeEntry(e)})}).next(()=>(this.Cs=null,r.apply(n)))}updateLimboDocument(t,e){return this.ks(t,e).next(t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())})}Ps(t){return 0}ks(t,e){return Jo.or([()=>Jo.resolve(this.Ds.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ss(t,e)])}}function Ph(t,e){return`firestore_clients_${t}_${e}`}function Vh(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function Uh(t,e){return`firestore_targets_${t}_${e}`}class qh{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static $s(t,e,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Ar(r.error.code,r.error.message))),i?new qh(t,e,r.state,s):(Er("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Bh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static $s(t,e){var n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Ar(n.error.code,n.error.message))),s?new Bh(t,n.state,r):(Er("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class jh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static $s(t,e){var n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Gi;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=is(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new jh(t,s):(Er("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class Kh{constructor(t,e){this.clientId=t,this.onlineState=e}static $s(t){var e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Kh(e.clientId,e.onlineState):(Er("SharedClientState",`Failed to parse online state: ${t}`),null)}}class $h{constructor(){this.activeTargetIds=Gi}Fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ms(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Os(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Gh{constructor(t,e,n,r,s){this.window=t,this.Oe=e,this.persistenceKey=n,this.Ls=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Bs=this.Us.bind(this),this.qs=new Mi(Pr),this.started=!1,this.Ks=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.js=Ph(this.persistenceKey,this.Ls),this.Qs=`firestore_sequence_number_${this.persistenceKey}`,this.qs=this.qs.insert(this.Ls,new $h),this.Ws=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Gs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.zs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Hs=`firestore_online_state_${this.persistenceKey}`,this.Js=`firestore_bundle_loaded_${this.persistenceKey}`,this.window.addEventListener("storage",this.Bs)}static bt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.pn();for(const n of t)if(n!==this.Ls){const t=this.getItem(Ph(this.persistenceKey,n));var e;!t||(e=jh.$s(n,t))&&(this.qs=this.qs.insert(e.clientId,e))}this.Ys();const n=this.storage.getItem(this.Hs);if(n){const t=this.Xs(n);t&&this.Zs(t)}for(const t of this.Ks)this.Us(t);this.Ks=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(t){this.setItem(this.Qs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ti(this.qs)}isActiveQueryTarget(n){let r=!1;return this.qs.forEach((t,e)=>{e.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(t){this.ei(t,"pending")}updateMutationState(t,e,n){this.ei(t,e,n),this.ni(t)}addLocalQueryTarget(t){let e="not-current";var n;return this.isActiveQueryTarget(t)&&(!(n=this.storage.getItem(Uh(this.persistenceKey,t)))||(n=Bh.$s(t,n))&&(e=n.state)),this.si.Fs(t),this.Ys(),e}removeLocalQueryTarget(t){this.si.Ms(t),this.Ys()}isLocalQueryTarget(t){return this.si.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Uh(this.persistenceKey,t))}updateQueryState(t,e,n){this.ii(t,e,n)}handleUserChange(t,e,n){e.forEach(t=>{this.ni(t)}),this.currentUser=t,n.forEach(t=>{this.addPendingMutation(t)})}setOnlineState(t){this.ri(t)}notifyBundleLoaded(){this.oi()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Bs),this.removeItem(this.js),this.started=!1)}getItem(t){var e=this.storage.getItem(t);return br("SharedClientState","READ",t,e),e}setItem(t,e){br("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){br("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Us(t){const r=t;r.storageArea===this.storage&&(br("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.js?this.Oe.enqueueRetryable(async()=>{if(this.started){if(null!==r.key)if(this.Ws.test(r.key)){if(null==r.newValue){var t=this.ci(r.key);return this.ai(t,null)}t=this.ui(r.key,r.newValue);if(t)return this.ai(t.clientId,t)}else if(this.Gs.test(r.key)){if(null!==r.newValue){var e=this.hi(r.key,r.newValue);if(e)return this.li(e)}}else if(this.zs.test(r.key)){if(null!==r.newValue){e=this.fi(r.key,r.newValue);if(e)return this.di(e)}}else if(r.key===this.Hs){if(null!==r.newValue){var n=this.Xs(r.newValue);if(n)return this.Zs(n)}}else if(r.key===this.Qs){n=function(t){let e=Mr.T;if(null!=t)try{var n=JSON.parse(t);Sr("number"==typeof n),e=n}catch(t){Er("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(r.newValue);n!==Mr.T&&this.sequenceNumberHandler(n)}else if(r.key===this.Js)return this.syncEngine.wi()}else this.Ks.push(r)}):Er("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get si(){return this.qs.get(this.Ls)}Ys(){this.setItem(this.js,this.si.Os())}ei(t,e,n){const r=new qh(this.currentUser,t,e,n),s=Vh(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Os())}ni(t){var e=Vh(this.persistenceKey,this.currentUser,t);this.removeItem(e)}ri(t){var e={clientId:this.Ls,onlineState:t};this.storage.setItem(this.Hs,JSON.stringify(e))}ii(t,e,n){const r=Uh(this.persistenceKey,t),s=new Bh(t,e,n);this.setItem(r,s.Os())}oi(){this.setItem(this.Js,"value-not-used")}ci(t){var e=this.Ws.exec(t);return e?e[1]:null}ui(t,e){var n=this.ci(t);return jh.$s(n,e)}hi(t,e){var n=this.Gs.exec(t),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return qh.$s(new pr(n),r,e)}fi(t,e){var n=this.zs.exec(t),n=Number(n[1]);return Bh.$s(n,e)}Xs(t){return Kh.$s(t)}async li(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine._i(t.batchId,t.state,t.error);br("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}di(t){return this.syncEngine.mi(t.targetId,t.state,t.error)}ai(t,e){const n=e?this.qs.insert(t,e):this.qs.remove(t),r=this.ti(this.qs),s=this.ti(n),i=[],o=[];return s.forEach(t=>{r.has(t)||i.push(t)}),r.forEach(t=>{s.has(t)||o.push(t)}),this.syncEngine.gi(i,o).then(()=>{this.qs=n})}Zs(t){this.qs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ti(t){let n=Gi;return t.forEach((t,e)=>{n=n.unionWith(e.activeTargetIds)}),n}}class Hh{constructor(){this.yi=new $h,this.pi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.yi.Fs(t),this.pi[t]||"not-current"}updateQueryState(t,e,n){this.pi[t]=e}removeLocalQueryTarget(t){this.yi.Ms(t)}isLocalQueryTarget(t){return this.yi.activeTargetIds.has(t)}clearQueryState(t){delete this.pi[t]}getAllActiveQueryTargets(){return this.yi.activeTargetIds}isActiveQueryTarget(t){return this.yi.activeTargetIds.has(t)}start(){return this.yi=new $h,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class zh{Ti(t){}shutdown(){}}class Qh{constructor(){this.Ei=()=>this.Ii(),this.Ai=()=>this.Ri(),this.bi=[],this.Pi()}Ti(t){this.bi.push(t)}shutdown(){window.removeEventListener("online",this.Ei),window.removeEventListener("offline",this.Ai)}Pi(){window.addEventListener("online",this.Ei),window.addEventListener("offline",this.Ai)}Ii(){br("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.bi)t(0)}Ri(){br("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.bi)t(1)}static bt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Wh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Yh{constructor(t){this.vi=t.vi,this.Vi=t.Vi}Si(t){this.Di=t}Ci(t){this.Ni=t}onMessage(t){this.xi=t}close(){this.Vi()}send(t){this.vi(t)}ki(){this.Di()}$i(t){this.Ni(t)}Oi(t){this.xi(t)}}class Xh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.Fi=e+"://"+t.host,this.Mi="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Li(e,t,n,r){const s=this.Bi(e,t);br("RestConnection","Sending: ",s,n);var i={};return this.Ui(i,r),this.qi(e,s,i,n).then(t=>(br("RestConnection","Received: ",t),t),t=>{throw Tr("RestConnection",`${e} failed with error: `,t,"url: ",s,"request:",n),t})}Ki(t,e,n,r){return this.Li(t,e,n,r)}Ui(t,e){if(t["X-Goog-Api-Client"]="gl-js/ fire/"+yr,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e)for(const n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n])}Bi(t,e){var n=Wh[t];return`${this.Fi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}qi(a,e,n,r){return new Promise((s,i)=>{const o=new gr;o.listenOnce(hr.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case ar.NO_ERROR:var t=o.getResponseJson();br("Connection","XHR received:",JSON.stringify(t)),s(t);break;case ar.TIMEOUT:br("Connection",'RPC "'+a+'" timed out'),i(new Ar(Nr.DEADLINE_EXCEEDED,"Request time out"));break;case ar.HTTP_ERROR:var e,n=o.getStatus();if(br("Connection",'RPC "'+a+'" failed with status:',n,"response text:",o.getResponseText()),0<n){const a=o.getResponseJson().error;a&&a.status&&a.message?(r=a.status.toLowerCase().replace(/_/g,"-"),e=0<=Object.values(Nr).indexOf(r)?r:Nr.UNKNOWN,i(new Ar(e,a.message))):i(new Ar(Nr.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Ar(Nr.UNAVAILABLE,"Connection failed."));break;default:_r()}}finally{br("Connection",'RPC "'+a+'" completed.')}var r});var t=JSON.stringify(r);o.send(e,"POST",t,n,15)})}ji(t,e){const n=[this.Fi,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=new tr,s=or(),i={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(i.xmlHttpFactory=new dr({})),this.Ui(i.initMessageHeaders,e),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(d())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=d().indexOf("Electron/")||function(){const t=d();return 0<=t.indexOf("MSIE ")||0<=t.indexOf("Trident/")}()||0<=d().indexOf("MSAppHost/")||"object"==typeof(o="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==o.id||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");br("Connection","Creating WebChannel: "+o,i);const a=r.createWebChannel(o,i);let h=!1,c=!1;const u=new Yh({vi:t=>{c?br("Connection","Not sending because WebChannel is closed:",t):(h||(br("Connection","Opening WebChannel transport."),a.open(),h=!0),br("Connection","WebChannel sending:",t),a.send(t))},Vi:()=>a.close()}),l=(t,e,n)=>{t.listen(e,t=>{try{n(t)}catch(t){setTimeout(()=>{throw t},0)}})};return l(a,fr.EventType.OPEN,()=>{c||br("Connection","WebChannel transport opened.")}),l(a,fr.EventType.CLOSE,()=>{c||(c=!0,br("Connection","WebChannel transport closed"),u.$i())}),l(a,fr.EventType.ERROR,t=>{c||(c=!0,Tr("Connection","WebChannel transport errored:",t),u.$i(new Ar(Nr.UNAVAILABLE,"The operation could not be completed")))}),l(a,fr.EventType.MESSAGE,n=>{if(!c){var t=n.data[0];Sr(!!t);var r=t.error||(null===(r=t[0])||void 0===r?void 0:r.error);if(r){br("Connection","WebChannel received error:",r);const n=r.status;let t=function(t){var e=ir[t];if(void 0!==e)return Oi(e)}(n),e=r.message;void 0===t&&(t=Nr.INTERNAL,e="Unknown error status: "+n+" with message "+r.message),c=!0,u.$i(new Ar(t,e)),a.close()}else br("Connection","WebChannel received:",t),u.Oi(t)}}),l(s,cr.STAT_EVENT,t=>{t.stat===ur?br("Connection","Detected buffering proxy"):t.stat===lr&&br("Connection","Detected no buffering proxy")}),setTimeout(()=>{u.ki()},0),u}}function Jh(){return"undefined"!=typeof window?window:null}function Zh(){return"undefined"!=typeof document?document:null}function tc(t){return new ro(t,!0)}class ec{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Oe=t,this.timerId=e,this.Qi=n,this.Wi=r,this.Gi=s,this.zi=0,this.Hi=null,this.Ji=Date.now(),this.reset()}reset(){this.zi=0}Yi(){this.zi=this.Gi}Xi(t){this.cancel();var e=Math.floor(this.zi+this.Zi()),n=Math.max(0,Date.now()-this.Ji),r=Math.max(0,e-n);0<r&&br("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.zi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Hi=this.Oe.enqueueAfterDelay(this.timerId,r,()=>(this.Ji=Date.now(),t())),this.zi*=this.Wi,this.zi<this.Qi&&(this.zi=this.Qi),this.zi>this.Gi&&(this.zi=this.Gi)}tr(){null!==this.Hi&&(this.Hi.skipDelay(),this.Hi=null)}cancel(){null!==this.Hi&&(this.Hi.cancel(),this.Hi=null)}Zi(){return(Math.random()-.5)*this.zi}}class nc{constructor(t,e,n,r,s,i,o){this.Oe=t,this.er=n,this.nr=r,this.sr=s,this.credentialsProvider=i,this.listener=o,this.state=0,this.ir=0,this.rr=null,this.cr=null,this.stream=null,this.ar=new ec(t,e)}ur(){return 1===this.state||5===this.state||this.hr()}hr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.lr()}async stop(){this.ur()&&await this.close(0)}dr(){this.state=0,this.ar.reset()}wr(){this.hr()&&null===this.rr&&(this.rr=this.Oe.enqueueAfterDelay(this.er,6e4,()=>this._r()))}mr(t){this.gr(),this.stream.send(t)}async _r(){if(this.hr())return this.close(0)}gr(){this.rr&&(this.rr.cancel(),this.rr=null)}yr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(t,e){this.gr(),this.yr(),this.ar.cancel(),this.ir++,4!==t?this.ar.reset():e&&e.code===Nr.RESOURCE_EXHAUSTED?(Er(e.toString()),Er("Using maximum backoff delay to prevent overloading the backend."),this.ar.Yi()):e&&e.code===Nr.UNAUTHENTICATED&&3!==this.state&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.pr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ci(e)}pr(){}auth(){this.state=1;const t=this.Tr(this.ir),e=this.ir;this.credentialsProvider.getToken().then(t=>{this.ir===e&&this.Er(t)},e=>{t(()=>{var t=new Ar(Nr.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Ir(t)})})}Er(t){const e=this.Tr(this.ir);this.stream=this.Ar(t),this.stream.Si(()=>{e(()=>(this.state=2,this.cr=this.Oe.enqueueAfterDelay(this.nr,1e4,()=>(this.hr()&&(this.state=3),Promise.resolve())),this.listener.Si()))}),this.stream.Ci(t=>{e(()=>this.Ir(t))}),this.stream.onMessage(t=>{e(()=>this.onMessage(t))})}lr(){this.state=5,this.ar.Xi(async()=>{this.state=0,this.start()})}Ir(t){return br("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Tr(e){return t=>{this.Oe.enqueueAndForget(()=>this.ir===e?t():(br("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class rc extends nc{constructor(t,e,n,r,s){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s),this.N=r}Ar(t){return this.sr.ji("Listen",t)}onMessage(t){this.ar.reset();var e=function(t,e){let n;if("targetChange"in e){e.targetChange;var r="NO_CHANGE"===(f=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:_r(),s=e.targetChange.targetIds||[],i=(f=e.targetChange.resumeToken,t.D?(Sr(void 0===f||"string"==typeof f),Yr.fromBase64String(f||"")):(Sr(void 0===f||f instanceof Uint8Array),Yr.fromUint8Array(f||new Uint8Array))),o=e.targetChange.cause,a=o&&(a=void 0===(f=o).code?Nr.UNKNOWN:Oi(f.code),new Ar(a,f.message||""));n=new Yi(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;var h=e.documentChange;h.document,h.document.name,h.document.updateTime;var a=uo(t,h.document.name),c=oo(h.document.updateTime),u=new bs({mapValue:{fields:h.document.fields}}),c=Es.newFoundDocument(a,c,u),u=h.targetIds||[],h=h.removedTargetIds||[];n=new Qi(u,h,c.key,c)}else if("documentDelete"in e){e.documentDelete;u=e.documentDelete;u.document;h=uo(t,u.document),c=u.readTime?oo(u.readTime):Br.min(),c=Es.newNoDocument(h,c),u=u.removedTargetIds||[];n=new Qi([],u,c.key,c)}else if("documentRemove"in e){e.documentRemove;var l=e.documentRemove;l.document;var d=uo(t,l.document),l=l.removedTargetIds||[];n=new Qi([],l,d,null)}else{if(!("filter"in e))return _r();{e.filter;const t=e.filter;t.targetId;l=t.count||0,d=new Ri(l),l=t.targetId;n=new Wi(l,d)}}var a,f;return n}(this.N,t),n=function(t){if(!("targetChange"in t))return Br.min();var e=t.targetChange;return(!e.targetIds||!e.targetIds.length)&&e.readTime?oo(e.readTime):Br.min()}(t);return this.listener.Rr(e,n)}br(t){const e={};e.database=go(this.N),e.addTarget=function(t,e){let n;var r=e.target;return n=Ns(r)?{documents:bo(t,r)}:{query:Eo(t,r)},n.targetId=e.targetId,0<e.resumeToken.approximateByteSize()?n.resumeToken=io(t,e.resumeToken):0<e.snapshotVersion.compareTo(Br.min())&&(n.readTime=so(t,e.snapshotVersion.toTimestamp())),n}(this.N,t);var n,r,r=(this.N,n=t,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return _r()}}())?null:{"goog-listen-tags":r});r&&(e.labels=r),this.mr(e)}Pr(t){const e={};e.database=go(this.N),e.removeTarget=t,this.mr(e)}}class sc extends nc{constructor(t,e,n,r,s){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s),this.N=r,this.vr=!1}get Vr(){return this.vr}start(){this.vr=!1,this.lastStreamToken=void 0,super.start()}pr(){this.vr&&this.Sr([])}Ar(t){return this.sr.ji("Write",t)}onMessage(t){if(Sr(!!t.streamToken),this.lastStreamToken=t.streamToken,this.vr){this.ar.reset();var e=(r=t.writeResults,s=t.commitTime,r&&0<r.length?(Sr(void 0!==s),r.map(t=>function(t,e){let n=t.updateTime?oo(t.updateTime):oo(e);return n.isEqual(Br.min())&&(n=oo(e)),new yi(n,t.transformResults||[])}(t,s))):[]),n=oo(t.commitTime);return this.listener.Dr(n,e)}var r,s;return Sr(!t.writeResults||0===t.writeResults.length),this.vr=!0,this.listener.Cr()}Nr(){const t={};t.database=go(this.N),this.mr(t)}Sr(t){var e={streamToken:this.lastStreamToken,writes:t.map(t=>vo(this.N,t))};this.mr(e)}}class ic extends class{}{constructor(t,e,n){super(),this.credentials=t,this.sr=e,this.N=n,this.kr=!1}$r(){if(this.kr)throw new Ar(Nr.FAILED_PRECONDITION,"The client has already been terminated.")}Li(e,n,r){return this.$r(),this.credentials.getToken().then(t=>this.sr.Li(e,n,r,t)).catch(t=>{throw"FirebaseError"===t.name?(t.code===Nr.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new Ar(Nr.UNKNOWN,t.toString())})}Ki(e,n,r){return this.$r(),this.credentials.getToken().then(t=>this.sr.Ki(e,n,r,t)).catch(t=>{throw"FirebaseError"===t.name?(t.code===Nr.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new Ar(Nr.UNKNOWN,t.toString())})}terminate(){this.kr=!0}}class oc{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Or=0,this.Fr=null,this.Mr=!0}Lr(){0===this.Or&&(this.Br("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.Fr=null,this.Ur("Backend didn't respond within 10 seconds."),this.Br("Offline"),Promise.resolve())))}qr(t){"Online"===this.state?this.Br("Unknown"):(this.Or++,1<=this.Or&&(this.Kr(),this.Ur(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Br("Offline")))}set(t){this.Kr(),this.Or=0,"Online"===t&&(this.Mr=!1),this.Br(t)}Br(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Ur(t){var e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Mr?(Er(e),this.Mr=!1):br("OnlineStateTracker",e)}Kr(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}class ac{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.jr=[],this.Qr=new Map,this.Wr=new Set,this.Gr=[],this.zr=s,this.zr.Ti(t=>{n.enqueueAndForget(async()=>{pc(this)&&(br("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=t;e.Wr.add(4),await cc(e),e.Hr.set("Unknown"),e.Wr.delete(4),await hc(e)}(this))})}),this.Hr=new oc(n,r)}}async function hc(t){if(pc(t))for(const e of t.Gr)await e(!0)}async function cc(t){for(const e of t.Gr)await e(!1)}function uc(t,e){const n=t;n.Qr.has(e.targetId)||(n.Qr.set(e.targetId,e),mc(n)?gc(n):_c(n).hr()&&dc(n,e))}function lc(t,e){const n=t,r=_c(n);n.Qr.delete(e),r.hr()&&fc(n,e),0===n.Qr.size&&(r.hr()?r.wr():pc(n)&&n.Hr.set("Unknown"))}function dc(t,e){t.Jr.Y(e.targetId),_c(t).br(e)}function fc(t,e){t.Jr.Y(e),_c(t).Pr(e)}function gc(e){e.Jr=new Ji({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Tt:t=>e.Qr.get(t)||null}),_c(e).start(),e.Hr.Lr()}function mc(t){return pc(t)&&!_c(t).ur()&&0<t.Qr.size}function pc(t){return 0===t.Wr.size}function yc(t){t.Jr=void 0}async function vc(t,e,n){if(!ra(e))throw e;t.Wr.add(1),await cc(t),t.Hr.set("Offline"),n=n||(()=>wh(t.localStore)),t.asyncQueue.enqueueRetryable(async()=>{br("RemoteStore","Retrying IndexedDB access"),await n(),t.Wr.delete(1),await hc(t)})}function wc(e,n){return n().catch(t=>vc(e,t,n))}async function bc(t){const e=t,n=Sc(e);let r=0<e.jr.length?e.jr[e.jr.length-1].batchId:-1;for(;pc(s=e)&&s.jr.length<10;)try{const t=await function(t,e){const n=t;return n.persistence.runTransaction("Get next mutation batch","readonly",t=>(void 0===e&&(e=-1),n.In.getNextMutationBatchAfterBatchId(t,e)))}(e.localStore,r);if(null===t){0===e.jr.length&&n.wr();break}r=t.batchId,function(t,e){t.jr.push(e);const n=Sc(t);n.hr()&&n.Vr&&n.Sr(e.mutations)}(e,t)}catch(t){await vc(e,t)}var s;Ec(e)&&Tc(e)}function Ec(t){return pc(t)&&!Sc(t).ur()&&0<t.jr.length}function Tc(t){Sc(t).start()}async function Ic(t,e){const n=t;e?(n.Wr.delete(2),await hc(n)):(n.Wr.add(2),await cc(n),n.Hr.set("Unknown"))}function _c(e){return e.Yr||(e.Yr=function(t,e,n){const r=t;return r.$r(),new rc(e,r.sr,r.credentials,r.N,n)}(e.datastore,e.asyncQueue,{Si:(async function(n){n.Qr.forEach((t,e)=>{dc(n,t)})}).bind(null,e),Ci:(async function(t,e){yc(t),mc(t)?(t.Hr.qr(e),gc(t)):t.Hr.set("Unknown")}).bind(null,e),Rr:(async function(t,r,e){if(t.Hr.set("Online"),r instanceof Yi&&2===r.state&&r.cause)try{await async function(t){var e=r.cause;for(const n of r.targetIds)t.Qr.has(n)&&(await t.remoteSyncer.rejectListen(n,e),t.Qr.delete(n),t.Jr.removeTarget(n))}(t)}catch(e){br("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),e),await vc(t,e)}else if(r instanceof Qi?t.Jr.rt(r):r instanceof Wi?t.Jr.ft(r):t.Jr.at(r),!e.isEqual(Br.min()))try{const r=await wh(t.localStore);0<=e.compareTo(r)&&await function(r,s){const t=r.Jr._t(s);return t.targetChanges.forEach((t,e)=>{if(0<t.resumeToken.approximateByteSize()){const n=r.Qr.get(e);n&&r.Qr.set(e,n.withResumeToken(t.resumeToken,s))}}),t.targetMismatches.forEach(t=>{const e=r.Qr.get(t);var n;e&&(r.Qr.set(t,e.withResumeToken(Yr.EMPTY_BYTE_STRING,e.snapshotVersion)),fc(r,t),n=new da(e.target,t,1,e.sequenceNumber),dc(r,n))}),r.remoteSyncer.applyRemoteEvent(t)}(t,e)}catch(r){br("RemoteStore","Failed to raise snapshot:",r),await vc(t,r)}}).bind(null,e)}),e.Gr.push(async t=>{t?(e.Yr.dr(),mc(e)?gc(e):e.Hr.set("Unknown")):(await e.Yr.stop(),yc(e))})),e.Yr}function Sc(e){return e.Xr||(e.Xr=function(t,e,n){const r=t;return r.$r(),new sc(e,r.sr,r.credentials,r.N,n)}(e.datastore,e.asyncQueue,{Si:(async function(t){Sc(t).Nr()}).bind(null,e),Ci:(async function(t,e){e&&Sc(t).Vr&&await async function(t,e){if(Li(n=e.code)&&n!==Nr.ABORTED){const n=t.jr.shift();Sc(t).dr(),await wc(t,()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e)),await bc(t)}var n}(t,e),Ec(t)&&Tc(t)}).bind(null,e),Cr:(async function(t){const e=Sc(t);for(const n of t.jr)e.Sr(n.mutations)}).bind(null,e),Dr:(async function(t,e,n){const r=t.jr.shift(),s=la.from(r,e,n);await wc(t,()=>t.remoteSyncer.applySuccessfulWrite(s)),await bc(t)}).bind(null,e)}),e.Gr.push(async t=>{t?(e.Xr.dr(),await bc(e)):(await e.Xr.stop(),0<e.jr.length&&(br("RemoteStore",`Stopping write stream with ${e.jr.length} pending writes`),e.jr=[]))})),e.Xr}class Nc{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Dr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(t=>{})}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new Nc(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ar(Nr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ac(t,e){if(Er("AsyncQueue",`${e}: ${t}`),ra(t))return new Ar(Nr.UNAVAILABLE,`${e}: ${t}`);throw t}class Dc{constructor(n){this.comparator=n?(t,e)=>n(t,e)||os.comparator(t.key,e.key):(t,e)=>os.comparator(t.key,e.key),this.keyedMap=Bi,this.sortedSet=new Mi(this.comparator)}static emptySet(t){return new Dc(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((t,e)=>(n(t),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Dc))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(t,e){const n=new Dc;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Cc{constructor(){this.Zr=new Mi(os.comparator)}track(t){var e=t.doc.key,n=this.Zr.get(e);!n||0!==t.type&&3===n.type?this.Zr=this.Zr.insert(e,t):3===t.type&&1!==n.type?this.Zr=this.Zr.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Zr=this.Zr.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Zr=this.Zr.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Zr=this.Zr.remove(e):1===t.type&&2===n.type?this.Zr=this.Zr.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Zr=this.Zr.insert(e,{type:2,doc:t.doc}):_r()}eo(){const n=[];return this.Zr.inorderTraversal((t,e)=>{n.push(e)}),n}}class xc{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach(t=>{s.push({type:0,doc:t})}),new xc(t,e,Dc.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Js(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0}}class kc{constructor(){this.no=void 0,this.listeners=[]}}class Rc{constructor(){this.queries=new Ja(t=>Zs(t),Js),this.onlineState="Unknown",this.so=new Set}}async function Lc(t,e){const n=t,r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new kc),s)try{i.no=await n.onListen(r)}catch(t){const n=Ac(t,`Initialization of query '${ti(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.io(n.onlineState),!i.no||e.ro(i.no)&&Mc(n)}async function Oc(t,e){const n=t,r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);0<=t&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Mc(t){t.so.forEach(t=>{t.next()})}class Fc{constructor(t,e,n){this.query=t,this.oo=e,this.co=!1,this.ao=null,this.onlineState="Unknown",this.options=n||{}}ro(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new xc(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.co?this.uo(t)&&(this.oo.next(t),e=!0):this.ho(t,this.onlineState)&&(this.lo(t),e=!0),this.ao=t,e}onError(t){this.oo.error(t)}io(t){this.onlineState=t;let e=!1;return this.ao&&!this.co&&this.ho(this.ao,t)&&(this.lo(this.ao),e=!0),e}ho(t,e){return!t.fromCache||!(this.options.fo&&"Offline"!==e||t.docs.isEmpty()&&"Offline"!==e)}uo(t){if(0<t.docChanges.length)return!0;var e=this.ao&&this.ao.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}lo(t){t=xc.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.co=!0,this.oo.next(t)}}class Pc{constructor(t,e){this.payload=t,this.byteLength=e}wo(){return"metadata"in this.payload}}class Vc{constructor(t){this.N=t}zn(t){return uo(this.N,t)}Hn(t){return t.metadata.exists?yo(this.N,t.document,!1):Es.newNoDocument(this.zn(t.metadata.name),this.Jn(t.metadata.readTime))}Jn(t){return oo(t)}}class Uc{constructor(t,e,n){this._o=t,this.localStore=e,this.N=n,this.queries=[],this.documents=[],this.progress=qc(t)}mo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}yo(t){const e=new Map,n=new Vc(this.N);for(const s of t)if(s.metadata.queries){const t=n.zn(s.metadata.name);for(const n of s.metadata.queries){var r=(e.get(n)||$i()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=t;let i=$i(),o=qi,a=ji;for(const t of n){const n=e.zn(t.metadata.name);t.document&&(i=i.add(n)),o=o.insert(n,e.Hn(t)),a=a.insert(n,e.Jn(t.metadata.readTime))}const h=s.jn.newChangeBuffer({trackRemovals:!0}),c=await Th(s,(r=r,Ys(Ks(Hr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>Eh(e,h,o,Br.min(),a).next(t=>(h.apply(e),t)).next(t=>s.ze.removeMatchingKeysForTargetId(e,c.targetId).next(()=>s.ze.addMatchingKeys(e,i,c.targetId)).next(()=>s.Qn.vn(e,t)).next(()=>t)))}(this.localStore,new Vc(this.N),this.documents,this._o.id),e=this.yo(this.documents);for(const t of this.queries)await async function(t,n,r=$i()){const s=await Th(t,Ys(Ia(n.bundledQuery))),i=t;return i.persistence.runTransaction("Save named query","readwrite",t=>{var e=oo(n.readTime);if(0<=s.snapshotVersion.compareTo(e))return i.Je.saveNamedQuery(t,n);e=s.withResumeToken(Yr.EMPTY_BYTE_STRING,e);return i.Un=i.Un.insert(e.targetId,e),i.ze.updateTargetData(t,e).next(()=>i.ze.removeMatchingKeysForTargetId(t,s.targetId)).next(()=>i.ze.addMatchingKeys(t,r,s.targetId)).next(()=>i.Je.saveNamedQuery(t,n))})}(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new dh(Object.assign({},this.progress),t)}}function qc(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Bc{constructor(t){this.key=t}}class jc{constructor(t){this.key=t}}class Kc{constructor(t,e){this.query=t,this.po=e,this.To=null,this.current=!1,this.Eo=$i(),this.mutatedKeys=$i(),this.Io=ni(t),this.Ao=new Dc(this.Io)}get Ro(){return this.po}bo(t,e){const a=e?e.Po:new Cc,h=(e||this).Ao;let c=(e||this).mutatedKeys,u=h,l=!1;const d=$s(this.query)&&h.size===this.query.limit?h.last():null,f=Gs(this.query)&&h.size===this.query.limit?h.first():null;if(t.inorderTraversal((t,e)=>{const n=h.get(t),r=ei(this.query,e)?e:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let o=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(a.track({type:3,doc:r}),o=!0):this.vo(n,r)||(a.track({type:2,doc:r}),o=!0,(d&&0<this.Io(r,d)||f&&this.Io(r,f)<0)&&(l=!0)):!n&&r?(a.track({type:0,doc:r}),o=!0):n&&!r&&(a.track({type:1,doc:n}),o=!0,(d||f)&&(l=!0)),o&&(c=r?(u=u.add(r),i?c.add(t):c.delete(t)):(u=u.delete(t),c.delete(t)))}),$s(this.query)||Gs(this.query))for(;u.size>this.query.limit;){const t=$s(this.query)?u.last():u.first();u=u.delete(t.key),c=c.delete(t.key),a.track({type:1,doc:t})}return{Ao:u,Po:a,Ln:l,mutatedKeys:c}}vo(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){var r=this.Ao;this.Ao=t.Ao,this.mutatedKeys=t.mutatedKeys;const s=t.Po.eo();s.sort((t,e)=>function(t,e){var n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return _r()}};return n(t)-n(e)}(t.type,e.type)||this.Io(t.doc,e.doc)),this.Vo(n);var i=e?this.So():[],o=0===this.Eo.size&&this.current?1:0,a=o!==this.To;return this.To=o,0!==s.length||a?{snapshot:new xc(this.query,t.Ao,r,s,t.mutatedKeys,0==o,a,!1),Do:i}:{Do:i}}io(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Ao:this.Ao,Po:new Cc,mutatedKeys:this.mutatedKeys,Ln:!1},!1)):{Do:[]}}Co(t){return!this.po.has(t)&&!!this.Ao.has(t)&&!this.Ao.get(t).hasLocalMutations}Vo(t){t&&(t.addedDocuments.forEach(t=>this.po=this.po.add(t)),t.modifiedDocuments.forEach(t=>{}),t.removedDocuments.forEach(t=>this.po=this.po.delete(t)),this.current=t.current)}So(){if(!this.current)return[];const e=this.Eo;this.Eo=$i(),this.Ao.forEach(t=>{this.Co(t.key)&&(this.Eo=this.Eo.add(t.key))});const n=[];return e.forEach(t=>{this.Eo.has(t)||n.push(new jc(t))}),this.Eo.forEach(t=>{e.has(t)||n.push(new Bc(t))}),n}No(t){this.po=t.Gn,this.Eo=$i();var e=this.bo(t.documents);return this.applyChanges(e,!0)}xo(){return xc.fromInitialDocuments(this.query,this.Ao,this.mutatedKeys,0===this.To)}}class $c{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Gc{constructor(t){this.key=t,this.ko=!1}}class Hc{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.$o={},this.Oo=new Ja(t=>Zs(t),Js),this.Fo=new Map,this.Mo=new Set,this.Lo=new Mi(os.comparator),this.Bo=new Map,this.Uo=new Dh,this.qo={},this.Ko=new Map,this.jo=qa.ie(),this.onlineState="Unknown",this.Qo=void 0}get isPrimaryClient(){return!0===this.Qo}}async function zc(n,t,e,r){n.Wo=(t,i,e)=>async function(t,e,n){let r=e.view.bo(i);r.Ln&&(r=await _h(t.localStore,e.query,!1).then(({documents:t})=>e.view.bo(t,r)));var s=n&&n.targetChanges.get(e.targetId),s=e.view.applyChanges(r,t.isPrimaryClient,s);return nu(t,e.targetId,s.Do),s.snapshot}(n,t,e);const s=await _h(n.localStore,t,!0),i=new Kc(t,s.Gn),o=i.bo(s.documents),a=zi.createSynthesizedTargetChangeForCurrentChange(e,r&&"Offline"!==n.onlineState),h=i.applyChanges(o,n.isPrimaryClient,a);nu(n,e,h.Do);var c=new $c(t,e,i);return n.Oo.set(t,c),n.Fo.has(e)?n.Fo.get(e).push(t):n.Fo.set(e,[t]),h.snapshot}async function Qc(t,e,n){const r=cu(t);try{const t=await function(t,r){const s=t,i=qr.now(),e=r.reduce((t,e)=>t.add(e.key),$i());let o;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>s.Qn.Pn(n,e).next(t=>{o=t;const e=[];for(const n of r){const r=function(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=ai(r.transform,t||null);null!=s&&(null==n&&(n=bs.empty()),n.set(r.field,s))}return n||null}(n,o.get(n.key));null!=r&&e.push(new Ni(n.key,r,function r(t){const s=[];return Kr(t.fields,(t,e)=>{const n=new Qr([t]);if(vs(e)){const t=r(e.mapValue).fields;if(0===t.length)s.push(n);else for(const e of t)s.push(n.child(e))}else s.push(n)}),new Wr(s)}(r.value.mapValue),vi.exists(!0)))}return s.In.addMutationBatch(n,i,e,r)})).then(t=>(t.applyToLocalDocumentSet(o),{batchId:t.batchId,changes:o}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.qo[t.currentUser.toKey()];r=r||new Mi(Pr),r=r.insert(e,n),t.qo[t.currentUser.toKey()]=r}(r,t.batchId,n),await su(r,t.changes),await bc(r.remoteStore)}catch(t){const e=Ac(t,"Failed to persist write");n.reject(e)}}async function Wc(t,e){const r=t;try{const t=await bh(r.localStore,e);e.targetChanges.forEach((t,e)=>{const n=r.Bo.get(e);n&&(Sr(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),0<t.addedDocuments.size?n.ko=!0:0<t.modifiedDocuments.size?Sr(n.ko):0<t.removedDocuments.size&&(Sr(n.ko),n.ko=!1))}),await su(r,t,e)}catch(t){await Ga(t)}}function Yc(r,s,t){const e=r;if(e.isPrimaryClient&&0===t||!e.isPrimaryClient&&1===t){const r=[];e.Oo.forEach((t,e)=>{var n=e.view.io(s);n.snapshot&&r.push(n.snapshot)}),function(t,n){const e=t;e.onlineState=n;let r=!1;e.queries.forEach((t,e)=>{for(const t of e.listeners)t.io(n)&&(r=!0)}),r&&Mc(e)}(e.eventManager,s),r.length&&e.$o.Rr(r),e.onlineState=s,e.isPrimaryClient&&e.sharedClientState.setOnlineState(s)}}async function Xc(t,e){const n=t,r=e.batch.batchId;try{const t=await function(t,r){const s=t;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",t=>{const e=r.batch.keys(),n=s.jn.newChangeBuffer({trackRemovals:!0});return function(t,e,r,s){const i=r.batch,n=i.keys();let o=Jo.resolve();return n.forEach(n=>{o=o.next(()=>s.getEntry(e,n)).next(t=>{var e=r.docVersions.get(n);Sr(null!==e),t.version.compareTo(e)<0&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&s.addEntry(t,r.commitVersion))})}),o.next(()=>t.In.removeMutationBatch(e,i))}(s,t,r,n).next(()=>n.apply(t)).next(()=>s.In.performConsistencyCheck(t)).next(()=>s.Qn.Pn(t,e))})}(n.localStore,e);Zc(n,r,null),Jc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await su(n,t)}catch(t){await Ga(t)}}function Jc(t,e){(t.Ko.get(e)||[]).forEach(t=>{t.resolve()}),t.Ko.delete(e)}function Zc(t,e,n){const r=t;let s=r.qo[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.qo[r.currentUser.toKey()]=s}}function tu(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Fo.get(t))e.Oo.delete(r),n&&e.$o.Go(r,n);e.Fo.delete(t),e.isPrimaryClient&&e.Uo.cs(t).forEach(t=>{e.Uo.containsKey(t)||eu(e,t)})}function eu(t,e){t.Mo.delete(e.path.canonicalString());var n=t.Lo.get(e);null!==n&&(lc(t.remoteStore,n),t.Lo=t.Lo.remove(e),t.Bo.delete(n),ru(t))}function nu(t,e,n){for(const r of n)r instanceof Bc?(t.Uo.addReference(r.key,e),function(t,e){const n=e.key,r=n.path.canonicalString();t.Lo.get(n)||t.Mo.has(r)||(br("SyncEngine","New document in limbo: "+n),t.Mo.add(r),ru(t))}(t,r)):r instanceof jc?(br("SyncEngine","Document no longer in limbo: "+r.key),t.Uo.removeReference(r.key,e),t.Uo.containsKey(r.key)||eu(t,r.key)):_r()}function ru(t){for(;0<t.Mo.size&&t.Lo.size<t.maxConcurrentLimboResolutions;){var e=t.Mo.values().next().value;t.Mo.delete(e);var n=new os(Hr.fromString(e)),e=t.jo.next();t.Bo.set(e,new Gc(n)),t.Lo=t.Lo.insert(n,e),uc(t.remoteStore,new da(Ys(Ks(n.path)),e,2,Mr.T))}}async function su(t,e,r){const s=t,i=[],o=[],a=[];s.Oo.isEmpty()||(s.Oo.forEach((t,n)=>{a.push(s.Wo(n,e,r).then(t=>{var e;t&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,t.fromCache?"not-current":"current"),i.push(t),e=gh.kn(n.targetId,t),o.push(e))}))}),await Promise.all(a),s.$o.Rr(i),await async function(t,e){const r=t;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>Jo.forEach(e,e=>Jo.forEach(e.Nn,t=>r.persistence.referenceDelegate.addReference(n,e.targetId,t)).next(()=>Jo.forEach(e.xn,t=>r.persistence.referenceDelegate.removeReference(n,e.targetId,t)))))}catch(t){if(!ra(t))throw t;br("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=r.Un.get(e),n=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(n);r.Un=r.Un.insert(e,s)}}}(s.localStore,o))}async function iu(r,t){const s=r;if(hu(s),cu(s),!0===t&&!0!==s.Qo){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await ou(s,r.toArray());s.Qo=!0,await Ic(s.remoteStore,!0);for(const r of t)uc(s.remoteStore,r)}else if(!1===t&&!1!==s.Qo){const r=[];let n=Promise.resolve();s.Fo.forEach((t,e)=>{s.sharedClientState.isLocalQueryTarget(e)?r.push(e):n=n.then(()=>(tu(s,e),Ih(s.localStore,e,!0))),lc(s.remoteStore,e)}),await n,await ou(s,r),function(){const n=s;n.Bo.forEach((t,e)=>{lc(n.remoteStore,e)}),n.Uo.us(),n.Bo=new Map,n.Lo=new Mi(os.comparator)}(),s.Qo=!1,await Ic(s.remoteStore,!1)}}async function ou(e,n){const r=e,s=[],i=[];for(const e of n){let t;const u=r.Fo.get(e);if(u&&0!==u.length){t=await Th(r.localStore,Ys(u[0]));for(const e of u){const n=r.Oo.get(e),u=(o=r,a=n,c=h=void 0,c=await _h((h=o).localStore,a.query,!0),c=a.view.No(c),h.isPrimaryClient&&nu(h,a.targetId,c.Do),await c);u.snapshot&&i.push(u.snapshot)}}else{const u=await Sh(r.localStore,e);t=await Th(r.localStore,u),await zc(r,au(u),e,!1)}s.push(t)}var o,a,h,c;return r.$o.Rr(i),s}function au(t){return js(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function hu(t){const e=t;return e.remoteStore.remoteSyncer.applyRemoteEvent=Wc.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(t,e){const n=t,r=n.Bo.get(e);if(r&&r.ko)return $i().add(r.key);{let t=$i();const r=n.Fo.get(e);if(!r)return t;for(const e of r){const r=n.Oo.get(e);t=t.unionWith(r.view.Ro)}return t}}).bind(null,e),e.remoteStore.remoteSyncer.rejectListen=(async function(t,e,n){const r=t;r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Bo.get(e),i=s&&s.key;if(i){let t=new Mi(os.comparator);t=t.insert(i,Es.newNoDocument(i,Br.min()));const n=$i().add(i),s=new Hi(Br.min(),new Map,new Vi(Pr),t,n);await Wc(r,s),r.Lo=r.Lo.remove(i),r.Bo.delete(e),ru(r)}else await Ih(r.localStore,e,!1).then(()=>tu(r,e,n)).catch(Ga)}).bind(null,e),e.$o.Rr=(function(t,e){const n=t;let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.listeners)e.ro(t)&&(r=!0);s.no=t}}r&&Mc(n)}).bind(null,e.eventManager),e.$o.Go=(function(t,e,n){const r=t,s=r.queries.get(e);if(s)for(const t of s.listeners)t.onError(n);r.queries.delete(e)}).bind(null,e.eventManager),e}function cu(t){const e=t;return e.remoteStore.remoteSyncer.applySuccessfulWrite=Xc.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=(async function(t,e,n){const r=t;try{const t=await function(t,r){const s=t;return s.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return s.In.lookupMutationBatch(e,r).next(t=>(Sr(null!==t),n=t.keys(),s.In.removeMutationBatch(e,t))).next(()=>s.In.performConsistencyCheck(e)).next(()=>s.Qn.Pn(e,n))})}(r.localStore,e);Zc(r,e,n),Jc(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await su(r,t)}catch(n){await Ga(n)}}).bind(null,e),e}class uu{constructor(){this.synchronizeTabs=!1}async initialize(t){this.N=tc(t.databaseInfo.databaseId),this.sharedClientState=this.Ho(t),this.persistence=this.Jo(t),await this.persistence.start(),this.gcScheduler=this.Yo(t),this.localStore=this.Xo(t)}Yo(t){return null}Xo(t){return yh(this.persistence,new mh,t.initialUser,this.N)}Jo(t){return new Oh(Fh.Ns,this.N)}Ho(t){return new Hh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class lu extends uu{constructor(t,e,n){super(),this.Zo=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=t;return e.persistence.runTransaction("Synchronize last document change read time","readonly",e=>function(){const t=rh(e);let r=Br.min();return t.Kt({index:qo.readTimeIndex,reverse:!0},(t,e,n)=>{e.readTime&&(r=ya(e.readTime)),n.done()}).next(()=>r)}()).then(t=>{e.Kn=t})}(this.localStore),await this.Zo.initialize(this,t),await cu(this.Zo.syncEngine),await bc(this.Zo.remoteStore),await this.persistence.nn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Xo(t){return yh(this.persistence,new mh,t.initialUser,this.N)}Yo(t){var e=this.persistence.referenceDelegate.garbageCollector;return new Qa(e,t.asyncQueue)}Jo(t){var e=lh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ra.withCacheSize(this.cacheSizeBytes):Ra.DEFAULT;return new hh(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Jh(),Zh(),this.N,this.sharedClientState,!!this.forceOwnership)}Ho(t){return new Hh}}class du extends lu{constructor(t,e){super(t,e,!1),this.Zo=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);var e=this.Zo.syncEngine;this.sharedClientState instanceof Gh&&(this.sharedClientState.syncEngine={_i:(async function(t,e,n,r){var s=t,i=await function(t,n){const r=t,s=r.In;return r.persistence.runTransaction("Lookup mutation documents","readonly",e=>s.Xt(e,n).next(t=>t?r.Qn.Pn(e,t):Jo.resolve(null)))}(s.localStore,e);null!==i?("pending"===n?await bc(s.remoteStore):"acknowledged"===n||"rejected"===n?(Zc(s,e,r||null),Jc(s,e),s.localStore.In.te(e)):_r(),await su(s,i)):br("SyncEngine","Cannot apply mutation batch with id: "+e)}).bind(null,e),mi:(async function(t,e,n,r){const s=t;if(s.Qo)br("SyncEngine","Ignoring unexpected query state notification.");else if(s.Fo.has(e))switch(n){case"current":case"not-current":{const t=await Nh(s.localStore),r=Hi.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await su(s,t,r);break}case"rejected":await Ih(s.localStore,e,!0),tu(s,e,r);break;default:_r()}}).bind(null,e),gi:(async function(t,e,n){const r=hu(t);if(r.Qo){for(const t of e)if(r.Fo.has(t))br("SyncEngine","Adding an already active target "+t);else{const e=await Sh(r.localStore,t),n=await Th(r.localStore,e);await zc(r,au(e),n.targetId,!1),uc(r.remoteStore,n)}for(const t of n)r.Fo.has(t)&&await Ih(r.localStore,t,!1).then(()=>{lc(r.remoteStore,t),tu(r,t)}).catch(Ga)}}).bind(null,e),pn:(function(t){return t.localStore.persistence.pn()}).bind(null,e),wi:(async function(t){const e=t;return Nh(e.localStore).then(t=>su(e,t))}).bind(null,e)},await this.sharedClientState.start()),await this.persistence.nn(async t=>{await iu(this.Zo.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())})}Ho(t){var e=Jh();if(!Gh.bt(e))throw new Ar(Nr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=lh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Gh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class fu{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Yc(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(t,e){const n=t;if(!n.currentUser.isEqual(e)){br("SyncEngine","User change. New user:",e.toKey());const r=await vh(n.localStore,e);n.currentUser=e,(t=n).Ko.forEach(t=>{t.forEach(t=>{t.reject(new Ar(Nr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),t.Ko.clear(),n.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),await su(n,r.Wn)}}).bind(null,this.syncEngine),await Ic(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Rc}createDatastore(t){var e,n,r,s=tc(t.databaseInfo.databaseId),e=(e=t.databaseInfo,new Xh(e));return n=t.credentials,r=e,t=s,new ic(n,r,t)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>Yc(this.syncEngine,t,0),i=new(Qh.bt()?Qh:zh),new ac(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Hc(t,e,n,r,s,i);return o&&(a.Qo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=t;br("RemoteStore","RemoteStore shutting down."),e.Wr.add(5),await cc(e),e.zr.shutdown(),e.Hr.set("Unknown")}(this.remoteStore)}}function gu(e,n=10240){let r=0;return{async read(){if(r<e.byteLength){var t={value:e.slice(r,r+n),done:!1};return r+=n,t}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class mu{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.tc(this.observer.next,t)}error(t){this.observer.error?this.tc(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}ec(){this.muted=!0}tc(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}}class pu{constructor(t,e){this.nc=t,this.N=e,this.metadata=new Dr,this.buffer=new Uint8Array,this.sc=new TextDecoder("utf-8"),this.ic().then(t=>{t&&t.wo()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))},t=>this.metadata.reject(t))}close(){return this.nc.cancel()}async getMetadata(){return this.metadata.promise}async zo(){return await this.getMetadata(),this.ic()}async ic(){var t=await this.rc();if(null===t)return null;var e=this.sc.decode(t),n=Number(e);isNaN(n)&&this.oc(`length string (${e}) is not valid number`);e=await this.cc(n);return new Pc(JSON.parse(e),t.length+n)}ac(){return this.buffer.findIndex(t=>t==="{".charCodeAt(0))}async rc(){for(;this.ac()<0&&!await this.uc(););if(0===this.buffer.length)return null;var t=this.ac();t<0&&this.oc("Reached the end of bundle when a length string is expected.");var e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async cc(t){for(;this.buffer.length<t;)await this.uc()&&this.oc("Reached the end of bundle when more is expected.");var e=this.sc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}oc(t){throw this.nc.cancel(),new Error(`Invalid bundle format: ${t}`)}async uc(){var t=await this.nc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class yu{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Ar(Nr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const r=t,n=go(r.N)+"/documents",s={documents:e.map(t=>co(r.N,t))},i=await r.Ki("BatchGetDocuments",n,s),o=new Map;i.forEach(t=>{const e=(n=r.N,"found"in(t=t)?function(t,e){Sr(!!e.found),e.found.name,e.found.updateTime;var n=uo(t,e.found.name),r=oo(e.found.updateTime),s=new bs({mapValue:{fields:e.found.fields}});return Es.newFoundDocument(n,r,s)}(n,t):"missing"in t?function(t,e){Sr(!!e.missing),Sr(!!e.readTime);var n=uo(t,e.missing),r=oo(e.readTime);return Es.newNoDocument(n,r)}(n,t):_r());var n;o.set(e.key.toString(),e)});const a=[];return e.forEach(t=>{var e=o.get(t.toString());Sr(!!e),a.push(e)}),a}(this.datastore,t);return e.forEach(t=>this.recordVersion(t)),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new xi(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,e)=>{var n=os.fromPath(e);this.mutations.push(new ki(n,this.precondition(n)))}),await async function(t,e){const n=t,r=go(n.N)+"/documents",s={writes:e.map(t=>vo(n.N,t))};await n.Li("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw _r();e=Br.min()}var n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Ar(Nr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){var e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?vi.updateTime(e):vi.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(this.writtenDocs.has(t.toString())||!e)return vi.exists(!0);if(e.isEqual(Br.min()))throw new Ar(Nr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return vi.updateTime(e)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class vu{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.hc=5,this.ar=new ec(this.asyncQueue,"transaction_retry")}run(){--this.hc,this.lc()}lc(){this.ar.Xi(async()=>{const e=new yu(this.datastore),t=this.fc(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(t=>{this.dc(t)}))}).catch(t=>{this.dc(t)})})}fc(t){try{var e=this.updateFunction(t);return!rs(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}dc(t){0<this.hc&&this.wc(t)?(--this.hc,this.asyncQueue.enqueueAndForget(()=>(this.lc(),Promise.resolve()))):this.deferred.reject(t)}wc(t){if("FirebaseError"!==t.name)return!1;var e=t.code;return"aborted"===e||"failed-precondition"===e||!Li(e)}}class wu{constructor(t,e,n){this.credentials=t,this.asyncQueue=e,this.databaseInfo=n,this.user=pr.UNAUTHENTICATED,this.clientId=Fr.I(),this.credentialListener=()=>Promise.resolve(),this.credentials.start(e,async t=>{br("FirestoreClient","Received user=",t.uid),await this.credentialListener(t),this.user=t})}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.credentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ar(Nr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Dr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.credentials.shutdown(),n.resolve()}catch(t){var e=Ac(t,"Failed to shutdown persistence");n.reject(e)}}),n.promise}}async function bu(t,e){t.asyncQueue.verifyOperationInProgress(),br("FirestoreClient","Initializing OfflineComponentProvider");var n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener(async t=>{r.isEqual(t)||(await vh(e.localStore,t),r=t)}),e.persistence.setDatabaseDeletedListener(()=>t.terminate()),t.offlineComponents=e}async function Eu(t,e){t.asyncQueue.verifyOperationInProgress();var n=await Tu(t);br("FirestoreClient","Initializing OnlineComponentProvider");var r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener(t=>async function(t,e){const n=t;n.asyncQueue.verifyOperationInProgress(),br("RemoteStore","RemoteStore received new credentials");var r=pc(n);n.Wr.add(3),await cc(n),r&&n.Hr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Wr.delete(3),await hc(n)}(e.remoteStore,t)),t.onlineComponents=e}async function Tu(t){return t.offlineComponents||(br("FirestoreClient","Using default OfflineComponentProvider"),await bu(t,new uu)),t.offlineComponents}async function Iu(t){return t.onlineComponents||(br("FirestoreClient","Using default OnlineComponentProvider"),await Eu(t,new fu)),t.onlineComponents}function _u(t){return Tu(t).then(t=>t.persistence)}function Su(t){return Tu(t).then(t=>t.localStore)}function Nu(t){return Iu(t).then(t=>t.remoteStore)}function Au(t){return Iu(t).then(t=>t.syncEngine)}async function Du(t){const e=await Iu(t),n=e.eventManager;return n.onListen=(async function(t,e){const n=hu(t);let r,s;const i=n.Oo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const t=await Th(n.localStore,Ys(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await zc(n,e,r,"current"===i),n.isPrimaryClient&&uc(n.remoteStore,t)}return s}).bind(null,e.syncEngine),n.onUnlisten=(async function(t,e){const n=t,r=n.Oo.get(e),s=n.Fo.get(r.targetId);if(1<s.length)return n.Fo.set(r.targetId,s.filter(t=>!Js(t,e))),void n.Oo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Ih(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),lc(n.remoteStore,r.targetId),tu(n,r.targetId)}).catch(Ga)):(tu(n,r.targetId),await Ih(n.localStore,r.targetId,!0))}).bind(null,e.syncEngine),n}function Cu(t,e,n={}){const r=new Dr;return t.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,o){const t=new mu({next:t=>{r.enqueueAndForget(()=>Oc(n,a));var e=t.docs.has(s);!e&&t.fromCache?o.reject(new Ar(Nr.UNAVAILABLE,"Failed to get document because the client is offline.")):e&&t.fromCache&&i&&"server"===i.source?o.reject(new Ar(Nr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):o.resolve(t)},error:t=>o.reject(t)}),a=new Fc(Ks(s.path),t,{includeMetadataChanges:!0,fo:!0});return Lc(n,a)}(await Du(t),t.asyncQueue,e,n,r)),r.promise}function xu(t,e,n={}){const r=new Dr;return t.asyncQueue.enqueueAndForget(async()=>function(e,n,t,r,s){const i=new mu({next:t=>{n.enqueueAndForget(()=>Oc(e,o)),t.fromCache&&"server"===r.source?s.reject(new Ar(Nr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(t)},error:t=>s.reject(t)}),o=new Fc(t,i,{includeMetadataChanges:!0,fo:!0});return Lc(e,o)}(await Du(t),t.asyncQueue,e,n,r)),r.promise}function ku(t,e,n,r){const s=(n=n,e=tc(e),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(t){if(t instanceof Uint8Array)return gu(t,void 0);if(t instanceof ArrayBuffer)return gu(new Uint8Array(t),void 0);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),e=e,new pu(n,e));var i;t.asyncQueue.enqueueAndForget(async()=>{!function(t,e,n){const r=t;!async function(e,n,r){try{var s=await n.getMetadata();if(await function(t,e){const n=t,r=oo(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",t=>n.Je.getBundleMetadata(t,e.id)).then(t=>!!t&&0<=t.createTime.compareTo(r))}(e.localStore,s))return await n.close(),void r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes});r._updateProgress(qc(s));const o=new Uc(s,e.localStore,n.N);let t=await n.zo();for(;t;){const e=await o.mo(t);e&&r._updateProgress(e),t=await n.zo()}var i=await o.complete();await su(e,i.En,void 0),await function(t,e){const n=t;return n.persistence.runTransaction("Save bundle","readwrite",t=>n.Je.saveBundleMetadata(t,e))}(e.localStore,s),r._completeWith(i.progress)}catch(e){Tr("SyncEngine",`Loading bundle failed with ${e}`),r._failWith(e)}}(r,e,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}(await Au(t),s,r)})}class Ru{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Lu{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Lu&&t.projectId===this.projectId&&t.database===this.database}}const Ou=new Map;function Mu(t,e,n){if(!n)throw new Ar(Nr.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Fu(t,e,n,r){if(!0===e&&!0===r)throw new Ar(Nr.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Pu(t){if(!os.isDocumentKey(t))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Vu(t){if(os.isDocumentKey(t))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Uu(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":_r();if(t instanceof Array)return"an array";var e=(t=t).constructor?t.constructor.name:null;return e?`a custom ${e} object`:"an object"}function qu(t,e){if((t="_delegate"in t?t._delegate:t)instanceof e)return t;if(e.name===t.constructor.name)throw new Ar(Nr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Uu(t);throw new Ar(Nr.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}function Bu(t,e){if(e<=0)throw new Ar(Nr.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class ju{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Ar(Nr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Ar(Nr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Fu("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Ku{constructor(t,e){this._credentials=e,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new ju({}),this._settingsFrozen=!1,t instanceof Lu?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Ar(Nr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Lu(t.options.projectId)}(t))}get app(){if(!this._app)throw new Ar(Nr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Ar(Nr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new ju(t),void 0!==t.credentials&&(this._credentials=function(t){if(!t)return new xr;switch(t.type){case"gapi":var e=t.client;return Sr(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Or(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Ar(Nr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Ou.get(t);e&&(br("ComponentProvider","Removing Datastore"),Ou.delete(t),e.terminate())}(this),Promise.resolve()}}function $u(n,t,e,r={}){var s;const i=(n=qu(n,Ku))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&Tr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${e}`,ssl:!1})),r.mockUserToken){let t,e;if("string"==typeof r.mockUserToken)t=r.mockUserToken,e=pr.MOCK_USER;else{t=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=e||"demo-project",r=t.iat||0,s=t.sub||t.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},t),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Ar(Nr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");e=new pr(i)}n._credentials=new kr(new Cr(t,e))}}class Gu{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new zu(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Gu(this.firestore,t,this._key)}}class Hu{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Hu(this.firestore,t,this._query)}}class zu extends Hu{constructor(t,e,n){super(t,e,Ks(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Gu(this.firestore,null,new os(t))}withConverter(t){return new zu(this.firestore,t,this._path)}}function Qu(t,e,...n){if(t=m(t),Mu("collection","path",e),t instanceof Ku){var r=Hr.fromString(e,...n);return Vu(r),new zu(t,null,r)}if(!(t instanceof Gu||t instanceof zu))throw new Ar(Nr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=t._path.child(Hr.fromString(e,...n));return Vu(r),new zu(t.firestore,null,r)}function Wu(t,e,...n){if(t=m(t),Mu("doc","path",e=1===arguments.length?Fr.I():e),t instanceof Ku){var r=Hr.fromString(e,...n);return Pu(r),new Gu(t,null,new os(r))}if(!(t instanceof Gu||t instanceof zu))throw new Ar(Nr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=t._path.child(Hr.fromString(e,...n));return Pu(r),new Gu(t.firestore,t instanceof zu?t.converter:null,new os(r))}function Yu(t,e){return t=m(t),e=m(e),(t instanceof Gu||t instanceof zu)&&(e instanceof Gu||e instanceof zu)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Xu(t,e){return t=m(t),e=m(e),t instanceof Hu&&e instanceof Hu&&t.firestore===e.firestore&&Js(t._query,e._query)&&t.converter===e.converter}class Ju{constructor(){this._c=Promise.resolve(),this.mc=[],this.gc=!1,this.yc=[],this.Tc=null,this.Ec=!1,this.Ic=!1,this.Ac=[],this.ar=new ec(this,"async_queue_retry"),this.Rc=()=>{var t=Zh();t&&br("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ar.tr()};const t=Zh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Rc)}get isShuttingDown(){return this.gc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.bc(),this.Pc(t)}enterRestrictedMode(t){if(!this.gc){this.gc=!0,this.Ic=t||!1;const e=Zh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Rc)}}enqueue(t){if(this.bc(),this.gc)return new Promise(()=>{});const e=new Dr;return this.Pc(()=>this.gc&&this.Ic?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.mc.push(t),this.vc()))}async vc(){if(0!==this.mc.length){try{await this.mc[0](),this.mc.shift(),this.ar.reset()}catch(t){if(!ra(t))throw t;br("AsyncQueue","Operation failed with retryable error: "+t)}0<this.mc.length&&this.ar.Xi(()=>this.vc())}}Pc(t){var e=this._c.then(()=>(this.Ec=!0,t().catch(t=>{throw this.Tc=t,this.Ec=!1,Er("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t}).then(t=>(this.Ec=!1,t))));return this._c=e}enqueueAfterDelay(t,e,n){this.bc(),-1<this.Ac.indexOf(t)&&(e=0);var r=Nc.createAndSchedule(this,t,e,n,t=>this.Vc(t));return this.yc.push(r),r}bc(){this.Tc&&_r()}verifyOperationInProgress(){}async Sc(){for(var t;await(t=this._c),t!==this._c;);}Dc(t){for(const e of this.yc)if(e.timerId===t)return!0;return!1}Cc(e){return this.Sc().then(()=>{this.yc.sort((t,e)=>t.targetTimeMs-e.targetTimeMs);for(const t of this.yc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Sc()})}Nc(t){this.Ac.push(t)}Vc(t){var e=this.yc.indexOf(t);this.yc.splice(e,1)}}function Zu(t){return function(t){if("object"==typeof t&&null!==t){var e=t;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return 1}}(t)}class tl{constructor(){this._progressObserver={},this._taskCompletionResolver=new Dr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}var el,nl,rl;class sl extends Ku{constructor(t,e){super(t,e),this.type="firestore",this._queue=new Ju,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||ol(this),this._firestoreClient.terminate()}}function il(t){return t._firestoreClient||ol(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function ol(t){var e,n,r,s,i,o=t._freezeSettings(),o=(n=t._databaseId,r=(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",s=t._persistenceKey,i=o,new Ru(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));t._firestoreClient=new wu(t._credentials,t._queue,o)}function al(t,n,r){const s=new Dr;return t.asyncQueue.enqueue(async()=>{try{await bu(t,r),await Eu(t,n),s.resolve()}catch(t){if(!("FirebaseError"===(e=t).name?e.code===Nr.FAILED_PRECONDITION||e.code===Nr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}var e}).then(()=>s.promise)}function hl(t){return function(t){const e=new Dr;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e){const n=t;pc(n.remoteStore)||br("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(){const e=n.localStore;return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",t=>e.In.getHighestUnacknowledgedBatchId(t))}();if(-1===t)return void e.resolve();const r=n.Ko.get(t)||[];r.push(e),n.Ko.set(t,r)}catch(t){const n=Ac(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Au(t),e)),e.promise}(il(t=qu(t,sl)))}function cl(t){return(n=il(t=qu(t,sl))).asyncQueue.enqueue(async()=>{const t=await _u(n),e=await Nu(n);return t.setNetworkEnabled(!0),function(){const t=e;return t.Wr.delete(0),hc(t)}()});var n}function ul(t){return(n=il(t=qu(t,sl))).asyncQueue.enqueue(async()=>{const t=await _u(n),e=await Nu(n);return t.setNetworkEnabled(!1),async function(){const t=e;t.Wr.add(0),await cc(t),t.Hr.set("Offline")}()});var n}function ll(e,t){return n=il(e=qu(e,sl)),r=t,n.asyncQueue.enqueue(async()=>function(t,e){const n=t;return n.persistence.runTransaction("Get named query","readonly",t=>n.Je.getNamedQuery(t,e))}(await Su(n),r)).then(t=>t?new Hu(e,null,t.query):null);var n,r}function dl(t){if(t._initialized||t._terminated)throw new Ar(Nr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class fl{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Ar(Nr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Qr(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class gl{constructor(t){this._byteString=t}static fromBase64String(t){try{return new gl(Yr.fromBase64String(t))}catch(t){throw new Ar(Nr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new gl(Yr.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class ml{constructor(t){this._methodName=t}}class pl{constructor(t,e){if(!isFinite(t)||t<-90||90<t)throw new Ar(Nr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Ar(Nr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Pr(this._lat,t._lat)||Pr(this._long,t._long)}}const yl=/^__.*__$/;class vl{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Ni(t,this.data,this.fieldMask,e,this.fieldTransforms):new Si(t,this.data,e,this.fieldTransforms)}}class wl{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Ni(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function bl(t){switch(t){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw _r()}}class El{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.N=n,this.ignoreUndefinedProperties=r,void 0===s&&this.xc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get kc(){return this.settings.kc}$c(t){return new El(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.N,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Oc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$c({path:n,Fc:!1});return r.Mc(t),r}Lc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$c({path:n,Fc:!1});return r.xc(),r}Bc(t){return this.$c({path:void 0,Fc:!0})}Uc(t){return Bl(t,this.settings.methodName,this.settings.qc||!1,this.path,this.settings.Kc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}xc(){if(this.path)for(let t=0;t<this.path.length;t++)this.Mc(this.path.get(t))}Mc(t){if(0===t.length)throw this.Uc("Document fields must not be empty");if(bl(this.kc)&&yl.test(t))throw this.Uc('Document fields cannot begin and end with "__"')}}class Tl{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.N=n||tc(t)}jc(t,e,n,r=!1){return new El({kc:t,methodName:e,Kc:n,path:Qr.emptyPath(),Fc:!1,qc:r},this.databaseId,this.N,this.ignoreUndefinedProperties)}}function Il(t){var e=t._freezeSettings(),n=tc(t._databaseId);return new Tl(t._databaseId,!!e.ignoreUndefinedProperties,n)}function _l(t,e,n,r,s,i={}){const o=t.jc(i.merge||i.mergeFields?2:0,e,n,s);Pl("Data must be an object, but it was:",o,r);var a=Ml(r,o);let h,c;if(i.merge)h=new Wr(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Vl(e,r,n);if(!o.contains(s))throw new Ar(Nr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);jl(t,s)||t.push(s)}h=new Wr(t),c=o.fieldTransforms.filter(t=>h.covers(t.field))}else h=null,c=o.fieldTransforms;return new vl(new bs(a),h,c)}class Sl extends ml{_toFieldTransform(t){if(2!==t.kc)throw 1===t.kc?t.Uc(`${this._methodName}() can only appear at the top level of your update data`):t.Uc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Sl}}function Nl(t,e,n){return new El({kc:3,Kc:e.settings.Kc,methodName:t._methodName,Fc:n},e.databaseId,e.N,e.ignoreUndefinedProperties)}class Al extends ml{_toFieldTransform(t){return new pi(t.path,new hi)}isEqual(t){return t instanceof Al}}class Dl extends ml{constructor(t,e){super(t),this.Qc=e}_toFieldTransform(t){const e=Nl(this,t,!0),n=this.Qc.map(t=>Ol(t,e)),r=new ci(n);return new pi(t.path,r)}isEqual(t){return this===t}}class Cl extends ml{constructor(t,e){super(t),this.Qc=e}_toFieldTransform(t){const e=Nl(this,t,!0),n=this.Qc.map(t=>Ol(t,e)),r=new li(n);return new pi(t.path,r)}isEqual(t){return this===t}}class xl extends ml{constructor(t,e){super(t),this.Wc=e}_toFieldTransform(t){var e=new fi(t.N,ii(t.N,this.Wc));return new pi(t.path,e)}isEqual(t){return this===t}}function kl(t,s,i,e){const o=t.jc(1,s,i);Pl("Data must be an object, but it was:",o,e);const a=[],h=bs.empty();Kr(e,(t,e)=>{var n=ql(s,t,i);e=m(e);var r=o.Lc(n);if(e instanceof Sl)a.push(n);else{const t=Ol(e,r);null!=t&&(a.push(n),h.set(n,t))}});var n=new Wr(a);return new wl(h,n,o.fieldTransforms)}function Rl(t,e,n,r,s,i){const o=t.jc(1,e,n),a=[Vl(e,r,n)],h=[s];if(i.length%2!=0)throw new Ar(Nr.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)a.push(Vl(e,i[f])),h.push(i[f+1]);const c=[],u=bs.empty();for(let g=a.length-1;0<=g;--g)if(!jl(c,a[g])){const e=a[g];var l=m(l=h[g]);const r=o.Lc(e);if(l instanceof Sl)c.push(e);else{const t=Ol(l,r);null!=t&&(c.push(e),u.set(e,t))}}var d=new Wr(c);return new wl(u,d,o.fieldTransforms)}function Ll(t,e,n,r=!1){return Ol(n,t.jc(r?4:3,e))}function Ol(i,t){if(Fl(i=m(i)))return Pl("Unsupported field value:",t,i),Ml(i,t);if(i instanceof ml)return function(t,e){if(!bl(e.kc))throw e.Uc(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Uc(`${t._methodName}() is not currently supported inside arrays`);var n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(i,t),null;if(void 0===i&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),i instanceof Array){if(t.settings.Fc&&4!==t.kc)throw t.Uc("Nested arrays are not supported");return function(e){const n=[];let r=0;for(const s of i){let t=Ol(s,e.Bc(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t)}return function(t,e){if(null===(t=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return ii(e.N,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){var n=qr.fromDate(t);return{timestampValue:so(e.N,n)}}if(t instanceof qr){n=new qr(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:so(e.N,n)}}if(t instanceof pl)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof gl)return{bytesValue:io(e.N,t._byteString)};if(t instanceof Gu){const r=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(r))throw e.Uc(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ao(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Uc(`Unsupported field value: ${Uu(t)}`)}(0,t)}function Ml(t,r){const s={};return $r(t)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):Kr(t,(t,e)=>{var n=Ol(e,r.Oc(t));null!=n&&(s[t]=n)}),{mapValue:{fields:s}}}function Fl(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof qr||t instanceof pl||t instanceof gl||t instanceof Gu||t instanceof ml)}function Pl(t,e,n){if(!Fl(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=Uu(n);throw"an object"===r?e.Uc(t+" a custom object"):e.Uc(t+" "+r)}var s}function Vl(t,e,n){if((e=m(e))instanceof fl)return e._internalPath;if("string"==typeof e)return ql(t,e);throw Bl("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const Ul=new RegExp("[~\\*/\\[\\]]");function ql(e,n,r){if(0<=n.search(Ul))throw Bl(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new fl(...n.split("."))._internalPath}catch(t){throw Bl(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function Bl(t,e,n,r,s){var i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let h="";return(i||o)&&(h+=" (found",i&&(h+=` in field ${r}`),o&&(h+=` in document ${s}`),h+=")"),new Ar(Nr.INVALID_ARGUMENT,a+t+h)}function jl(t,e){return t.some(t=>t.isEqual(e))}class Kl{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Gu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var t=new $l(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){var e=this._document.data.field(Gl("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class $l extends Kl{data(){return super.data()}}function Gl(t,e){return"string"==typeof e?ql(t,e):(e instanceof fl?e:e._delegate)._internalPath}class Hl{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class zl extends Kl{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){var e=new Ql(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){var n=this._document.data.field(Gl("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Ql extends zl{data(t={}){return super.data(t)}}class Wl{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Hl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,n){this._snapshot.docs.forEach(t=>{e.call(n,new Ql(this._firestore,this._userDataWriter,t.key,t,new Hl(this._snapshot.mutatedKeys.has(t.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){var e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ar(Nr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,e){if(i._snapshot.oldDocs.isEmpty()){let e=0;return i._snapshot.docChanges.map(t=>({type:"added",doc:new Ql(i._firestore,i._userDataWriter,t.doc.key,t.doc,new Hl(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:e++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(t=>e||3!==t.type).map(t=>{var e=new Ql(i._firestore,i._userDataWriter,t.doc.key,t.doc,new Hl(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==t.type&&(n=s.indexOf(t.doc.key),s=s.delete(t.doc.key)),1!==t.type&&(s=s.add(t.doc),r=s.indexOf(t.doc.key)),{type:function(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return _r()}}(t.type),doc:e,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Yl(t,e){return t instanceof zl&&e instanceof zl?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Wl&&e instanceof Wl&&t._firestore===e._firestore&&Xu(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Xl(t){if(Gs(t)&&0===t.explicitOrderBy.length)throw new Ar(Nr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Jl{}function Zl(t,...e){for(const n of e)t=n._apply(t);return t}class td extends Jl{constructor(t,e,n){super(),this.Gc=t,this.zc=e,this.Hc=n,this.type="where"}_apply(t){var e=Il(t.firestore),e=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Ar(Nr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){ad(o,i);const e=[];for(const n of o)e.push(od(r,t,n));a={arrayValue:{values:e}}}else a=od(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||ad(o,i),a=Ll(n,e,o,"in"===i||"not-in"===i);var h=As.create(s,i,a);return function(t,e){if(e.v()){const r=zs(t);if(null!==r&&!r.isEqual(e.field))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${e.field.toString()}'`);var n=Hs(t);null!==n&&hd(0,e.field,n)}const r=function(t,e){for(const n of t.filters)if(0<=e.indexOf(n.op))return n.op;return null}(t,function(){switch(e.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===e.op?new Ar(Nr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Ar(Nr.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${r.toString()}' filters.`)}(t,h),h}(t._query,"where",e,t.firestore._databaseId,this.Gc,this.zc,this.Hc);return new Hu(t.firestore,t.converter,(t=t._query,e=t.filters.concat([e]),new Bs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),e,t.limit,t.limitType,t.startAt,t.endAt)))}}class ed extends Jl{constructor(t,e){super(),this.Gc=t,this.Jc=e,this.type="orderBy"}_apply(t){var e=function(t,e,n){if(null!==t.startAt)throw new Ar(Nr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Ar(Nr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Vs(e,n);return n=s,null!==Hs(t=t)||null!==(r=zs(t))&&hd(0,r,n.field),s}(t._query,this.Gc,this.Jc);return new Hu(t.firestore,t.converter,(t=t._query,e=t.explicitOrderBy.concat([e]),new Bs(t.path,t.collectionGroup,e,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)))}}class nd extends Jl{constructor(t,e,n){super(),this.type=t,this.Yc=e,this.Xc=n}_apply(t){return new Hu(t.firestore,t.converter,Xs(t._query,this.Yc,this.Xc))}}class rd extends Jl{constructor(t,e,n){super(),this.type=t,this.Zc=e,this.ta=n}_apply(t){var e,n=id(t,this.type,this.Zc,this.ta);return new Hu(t.firestore,t.converter,(e=t._query,t=n,new Bs(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)))}}class sd extends Jl{constructor(t,e,n){super(),this.type=t,this.Zc=e,this.ta=n}_apply(t){var e,n=id(t,this.type,this.Zc,this.ta);return new Hu(t.firestore,t.converter,(e=t._query,t=n,new Bs(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)))}}function id(t,e,n,r){if(n[0]=m(n[0]),n[0]instanceof Kl)return function(t,e,n,r,s){if(!r)throw new Ar(Nr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Ws(t))if(n.field.isKeyField())i.push(fs(e,r.key));else{const t=r.data.field(n.field);if(es(t))throw new Ar(Nr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Fs(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);var s=Il(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new Ar(Nr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let h=0;h<s.length;h++){const c=s[h];if(o[h].field.isKeyField()){if("string"!=typeof c)throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Qs(t)&&-1!==c.indexOf("/"))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(Hr.fromString(c));if(!os.isDocumentKey(n))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new os(n);a.push(fs(e,s))}else{const t=Ll(n,r,c);a.push(t)}}return new Fs(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}function od(t,e,n){if("string"==typeof(n=m(n))){if(""===n)throw new Ar(Nr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!Qs(e)&&-1!==n.indexOf("/"))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=e.path.child(Hr.fromString(n));if(!os.isDocumentKey(r))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return fs(t,new os(r))}if(n instanceof Gu)return fs(t,n._key);throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${Uu(n)}.`)}function ad(t,e){if(!Array.isArray(t)||0===t.length)throw new Ar(Nr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(10<t.length)throw new Ar(Nr.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function hd(t,e,n){if(!n.isEqual(e))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class cd{convertValue(t,e="none"){switch(as(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Zr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(ts(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw _r()}}convertObject(t,n){const r={};return Kr(t.fields,(t,e)=>{r[t]=this.convertValue(e,n)}),r}convertGeoPoint(t){return new pl(Zr(t.latitude),Zr(t.longitude))}convertArray(t,e){return(t.values||[]).map(t=>this.convertValue(t,e))}convertServerTimestamp(t,e){switch(e){case"previous":var n=function t(e){var n=e.mapValue.fields.__previous_value__;return es(n)?t(n):n}(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(ns(t));default:return null}}convertTimestamp(t){var e=Jr(t);return new qr(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=Hr.fromString(t);Sr(Co(n));const r=new Lu(n.get(1),n.get(3)),s=new os(n.popFirst(5));return r.isEqual(e)||Er(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function ud(t,e,n){return t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e}class ld extends cd{constructor(t){super(),this.firestore=t}convertBytes(t){return new gl(t)}convertReference(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gu(this.firestore,null,e)}}class dd{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Il(t)}set(t,e,n){this._verifyNotCommitted();const r=fd(t,this._firestore),s=ud(r.converter,e,n),i=_l(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,vi.none())),this}update(t,e,n,...r){this._verifyNotCommitted();var s=fd(t,this._firestore);let i;return i="string"==typeof(e=m(e))||e instanceof fl?Rl(this._dataReader,"WriteBatch.update",s._key,e,n,r):kl(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,vi.exists(!0))),this}delete(t){this._verifyNotCommitted();var e=fd(t,this._firestore);return this._mutations=this._mutations.concat(new xi(e._key,vi.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ar(Nr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function fd(t,e){if((t=m(t)).firestore!==e)throw new Ar(Nr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class gd extends cd{constructor(t){super(),this.firestore=t}convertBytes(t){return new gl(t)}convertReference(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gu(this.firestore,null,e)}}function md(e){e=qu(e,Gu);const n=qu(e.firestore,sl),t=il(n),r=new gd(n);return function(t,e){const n=new Dr;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const s=await function(e){const n=t;return n.persistence.runTransaction("read document","readonly",t=>n.Qn.An(t,e))}(e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Ar(Nr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){var r=Ac(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await Su(t),e,n)),n.promise}(t,e._key).then(t=>new zl(n,r,e._key,t,new Hl(null!==t&&t.hasLocalMutations,!0),e.converter))}function pd(e){e=qu(e,Hu);const n=qu(e.firestore,sl),t=il(n),r=new gd(n);return function(t,e){const n=new Dr;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const s=await _h(t,e,!0),i=new Kc(e,s.Gn),o=i.bo(s.documents),a=i.applyChanges(o,!1);n.resolve(a.snapshot)}catch(t){var r=Ac(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await Su(t),e,n)),n.promise}(t,e._query).then(t=>new Wl(n,r,e,t))}function yd(t,e,n){t=qu(t,Gu);var r=qu(t.firestore,sl),s=ud(t.converter,e,n);return Ed(r,[_l(Il(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,vi.none())])}function vd(t,e,n,...r){t=qu(t,Gu);var s=qu(t.firestore,sl),i=Il(s);let o;return o="string"==typeof(e=m(e))||e instanceof fl?Rl(i,"updateDoc",t._key,e,n,r):kl(i,"updateDoc",t._key,e),Ed(s,[o.toMutation(t._key,vi.exists(!0))])}function wd(e,...n){var t;e=m(e);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||Zu(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(Zu(n[s])){const e=n[s];n[s]=null===(t=e.next)||void 0===t?void 0:t.bind(e),n[s+1]=null===(t=e.error)||void 0===t?void 0:t.bind(e),n[s+2]=null===(t=e.complete)||void 0===t?void 0:t.bind(e)}let o,a,h;if(e instanceof Gu)a=qu(e.firestore,sl),h=Ks(e._key.path),o={next:t=>{n[s]&&n[s](Td(a,e,t))},error:n[s+1],complete:n[s+2]};else{const c=qu(e,Hu);a=qu(c.firestore,sl),h=c._query;const u=new gd(a);o={next:t=>{n[s]&&n[s](new Wl(a,u,c,t))},error:n[s+1],complete:n[s+2]},Xl(e._query)}return function(t,e,n,r){const s=new mu(r),i=new Fc(e,s,n);return t.asyncQueue.enqueueAndForget(async()=>Lc(await Du(t),i)),()=>{s.ec(),t.asyncQueue.enqueueAndForget(async()=>Oc(await Du(t),i))}}(il(a),h,i,o)}function bd(t,e){return function(t,e){const n=new mu(e);return t.asyncQueue.enqueueAndForget(async()=>function(t,e){t.so.add(e),e.next()}(await Du(t),n)),()=>{n.ec(),t.asyncQueue.enqueueAndForget(async()=>function(t,e){t.so.delete(e)}(await Du(t),n))}}(il(t=qu(t,sl)),Zu(e)?e:{next:e})}function Ed(t,e){return function(t,e){const n=new Dr;return t.asyncQueue.enqueueAndForget(async()=>Qc(await Au(t),e,n)),n.promise}(il(t),e)}function Td(t,e,n){var r=n.docs.get(e._key),s=new gd(t);return new zl(t,s,e._key,r,new Hl(n.hasPendingWrites,n.fromCache),e.converter)}class Id extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Il(t)}get(t){const n=fd(t,this._firestore),r=new ld(this._firestore);return this._transaction.lookup([n._key]).then(t=>{if(!t||1!==t.length)return _r();const e=t[0];if(e.isFoundDocument())return new Kl(this._firestore,r,e.key,e,n.converter);if(e.isNoDocument())return new Kl(this._firestore,r,n._key,null,n.converter);throw _r()})}set(t,e,n){var r=fd(t,this._firestore),s=ud(r.converter,e,n),s=_l(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(t,e,n,...r){var s=fd(t,this._firestore),i="string"==typeof(e=m(e))||e instanceof fl?Rl(this._dataReader,"Transaction.update",s._key,e,n,r):kl(this._dataReader,"Transaction.update",s._key,e);return this._transaction.update(s._key,i),this}delete(t){var e=fd(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=fd(t,this._firestore),n=new gd(this._firestore);return super.get(t).then(t=>new zl(this._firestore,n,e._key,t._document,new Hl(!1,!1),e.converter))}}function _d(e,n){return function(e,n){const r=new Dr;return e.asyncQueue.enqueueAndForget(async()=>{var t=await Iu(e).then(t=>t.datastore);new vu(e.asyncQueue,t,n,r).run()}),r.promise}(il(e=qu(e,sl)),t=>n(new Id(e,t)))}el=Xd.SDK_VERSION,yr=el,Xd._registerComponent(new i("firestore",(t,{options:e})=>{const n=t.getProvider("app").getImmediate(),r=new sl(n,new Rr(t.getProvider("auth-internal")));return e=Object.assign({useFetchStreams:!0},e),r._setSettings(e),r},"PUBLIC")),Xd.registerVersion(mr,"3.2.0",void 0),Xd.registerVersion(mr,"3.2.0","esm2017");function Sd(t,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new Ar("invalid-argument",`Invalid options passed to function ${t}(): You cannot `+'specify both "merge" and "mergeFields".');return e}function Nd(){if("undefined"==typeof Uint8Array)throw new Ar("unimplemented","Uint8Arrays are not available in this environment.")}function Ad(){if("undefined"==typeof atob)throw new Ar("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Dd{constructor(t){this._delegate=t}static fromBase64String(t){return Ad(),new Dd(gl.fromBase64String(t))}static fromUint8Array(t){return Nd(),new Dd(gl.fromUint8Array(t))}toBase64(){return Ad(),this._delegate.toBase64()}toUint8Array(){return Nd(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Cd(t){return function(t,e){if("object"!=typeof t||null===t)return;var n=t;for(const r of e)if(r in n&&"function"==typeof n[r])return 1;return}(t,["next","error","complete"])}class xd{enableIndexedDbPersistence(t,e){return function(t,e){dl(t=qu(t,sl));var n=il(t),r=t._freezeSettings(),s=new fu;return al(n,s,new lu(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return function(t){dl(t=qu(t,sl));var e=il(t),n=t._freezeSettings(),r=new fu;return al(e,r,new du(r,n.cacheSizeBytes))}(t._delegate)}clearIndexedDbPersistence(t){return function(t){if(t._initialized&&!t._terminated)throw new Ar(Nr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Dr;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(t){if(!ta.bt())return Promise.resolve();var e=t+"main";await ta.delete(e)}(lh(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}}),e.promise}(t._delegate)}}class kd{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof Lu||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){var e=this._delegate._getSettings();t.merge||e.host===t.host||Tr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&delete(t=Object.assign(Object.assign({},e),t)).merge,this._delegate._setSettings(t)}useEmulator(t,e,n={}){$u(this._delegate,t,e,n)}enableNetwork(){return cl(this._delegate)}disableNetwork(){return ul(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,Fu("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return hl(this._delegate)}onSnapshotsInSync(t){return bd(this._delegate,t)}get app(){if(!this._appCompat)throw new Ar("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new Gd(this,Qu(this._delegate,t))}catch(t){throw Pd(t,"collection()","Firestore.collection()")}}doc(t){try{return new Fd(this,Wu(this._delegate,t))}catch(t){throw Pd(t,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new jd(this,function(t,e){if(t=qu(t,Ku),Mu("collectionGroup","collection id",e),0<=e.indexOf("/"))throw new Ar(Nr.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Hu(t,null,(e=e,new Bs(Hr.emptyPath(),e)))}(this._delegate,t))}catch(t){throw Pd(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return _d(this._delegate,t=>e(new Ld(this,t)))}batch(){return il(this._delegate),new Od(new dd(this._delegate,t=>Ed(this._delegate,t)))}loadBundle(t){return e=this._delegate,t=t,n=il(e=qu(e,sl)),r=new tl,ku(n,e._databaseId,t,r),r;var e,n,r}namedQuery(t){return ll(this._delegate,t).then(t=>t?new jd(this,t):null)}}class Rd extends cd{constructor(t){super(),this.firestore=t}convertBytes(t){return new Dd(new gl(t))}convertReference(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return Fd.forKey(e,this.firestore,null)}}class Ld{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new Rd(t)}get(t){const e=Hd(t);return this._delegate.get(e).then(t=>new qd(this._firestore,new zl(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,e.converter)))}set(t,e,n){var r=Hd(t);return n?(Sd("Transaction.set",n),this._delegate.set(r,e,n)):this._delegate.set(r,e),this}update(t,e,n,...r){var s=Hd(t);return 2===arguments.length?this._delegate.update(s,e):this._delegate.update(s,e,n,...r),this}delete(t){var e=Hd(t);return this._delegate.delete(e),this}}class Od{constructor(t){this._delegate=t}set(t,e,n){var r=Hd(t);return n?(Sd("WriteBatch.set",n),this._delegate.set(r,e,n)):this._delegate.set(r,e),this}update(t,e,n,...r){var s=Hd(t);return 2===arguments.length?this._delegate.update(s,e):this._delegate.update(s,e,n,...r),this}delete(t){var e=Hd(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class Md{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){var n=new Ql(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new Bd(this._firestore,n),null!=e?e:{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){const n=Md.INSTANCES;let r=n.get(t);r||(r=new WeakMap,n.set(t,r));let s=r.get(e);return s||(s=new Md(t,new Rd(t),e),r.set(e,s)),s}}Md.INSTANCES=new WeakMap;class Fd{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new Rd(t)}static forPath(t,e,n){if(t.length%2!=0)throw new Ar("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${t.canonicalString()} has ${t.length}`);return new Fd(e,new Gu(e._delegate,n,new os(t)))}static forKey(t,e,n){return new Fd(e,new Gu(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new Gd(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new Gd(this.firestore,Qu(this._delegate,t))}catch(t){throw Pd(t,"collection()","DocumentReference.collection()")}}isEqual(t){return(t=m(t))instanceof Gu&&Yu(this._delegate,t)}set(t,e){e=Sd("DocumentReference.set",e);try{return e?yd(this._delegate,t,e):yd(this._delegate,t)}catch(t){throw Pd(t,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return 1===arguments.length?vd(this._delegate,t):vd(this._delegate,t,e,...n)}catch(t){throw Pd(t,"updateDoc()","DocumentReference.update()")}}delete(){return Ed(qu((t=this._delegate).firestore,sl),[new xi(t._key,vi.none())]);var t}onSnapshot(...t){var e=Vd(t),n=Ud(t,t=>new qd(this.firestore,new zl(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter)));return wd(this._delegate,e,n)}get(t){let e;return e=("cache"===(null==t?void 0:t.source)?md:"server"===(null==t?void 0:t.source)?function(e){e=qu(e,Gu);const n=qu(e.firestore,sl);return Cu(il(n),e._key,{source:"server"}).then(t=>Td(n,e,t))}:function(e){e=qu(e,Gu);const n=qu(e.firestore,sl);return Cu(il(n),e._key).then(t=>Td(n,e,t))})(this._delegate),e.then(t=>new qd(this.firestore,new zl(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter)))}withConverter(t){return new Fd(this.firestore,t?this._delegate.withConverter(Md.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function Pd(t,e,n){return t.message=t.message.replace(e,n),t}function Vd(t){for(const e of t)if("object"==typeof e&&!Cd(e))return e;return{}}function Ud(t,e){var n;let r;return r=Cd(t[0])?t[0]:Cd(t[1])?t[1]:"function"==typeof t[0]?{next:t[0],error:t[1],complete:t[2]}:{next:t[1],error:t[2],complete:t[3]},{next:t=>{r.next&&r.next(e(t))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class qd{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new Fd(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Yl(this._delegate,t._delegate)}}class Bd extends qd{data(t){var e=this._delegate.data(t);return void 0!==e||_r(),e}}class jd{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new Rd(t)}where(t,e,n){try{return new jd(this.firestore,Zl(this._delegate,(r=n,s=e,i=Gl("where",t),new td(i,s,r))))}catch(t){throw Pd(t,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(t,e){try{return new jd(this.firestore,Zl(this._delegate,([n,r="asc"]=[t,e],s=r,i=Gl("orderBy",n),new ed(i,s))))}catch(t){throw Pd(t,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(t){try{return new jd(this.firestore,Zl(this._delegate,(Bu("limit",e=t),new nd("limit",e,"F"))))}catch(t){throw Pd(t,"limit()","Query.limit()")}var e}limitToLast(t){try{return new jd(this.firestore,Zl(this._delegate,(Bu("limitToLast",e=t),new nd("limitToLast",e,"L"))))}catch(t){throw Pd(t,"limitToLast()","Query.limitToLast()")}var e}startAt(...t){try{return new jd(this.firestore,Zl(this._delegate,function(...t){return new rd("startAt",t,!0)}(...t)))}catch(t){throw Pd(t,"startAt()","Query.startAt()")}}startAfter(...t){try{return new jd(this.firestore,Zl(this._delegate,function(...t){return new rd("startAfter",t,!1)}(...t)))}catch(t){throw Pd(t,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new jd(this.firestore,Zl(this._delegate,function(...t){return new sd("endBefore",t,!0)}(...t)))}catch(t){throw Pd(t,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new jd(this.firestore,Zl(this._delegate,function(...t){return new sd("endAt",t,!1)}(...t)))}catch(t){throw Pd(t,"endAt()","Query.endAt()")}}isEqual(t){return Xu(this._delegate,t._delegate)}get(t){let e;return e=("cache"===(null==t?void 0:t.source)?pd:"server"===(null==t?void 0:t.source)?function(e){e=qu(e,Hu);const n=qu(e.firestore,sl),t=il(n),r=new gd(n);return xu(t,e._query,{source:"server"}).then(t=>new Wl(n,r,e,t))}:function(e){e=qu(e,Hu);const n=qu(e.firestore,sl),t=il(n),r=new gd(n);return Xl(e._query),xu(t,e._query).then(t=>new Wl(n,r,e,t))})(this._delegate),e.then(t=>new $d(this.firestore,new Wl(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot)))}onSnapshot(...t){var e=Vd(t),n=Ud(t,t=>new $d(this.firestore,new Wl(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot)));return wd(this._delegate,e,n)}withConverter(t){return new jd(this.firestore,t?this._delegate.withConverter(Md.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}class Kd{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new Bd(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class $d{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new jd(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new Bd(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(t=>new Kd(this._firestore,t))}forEach(e,n){this._delegate.forEach(t=>{e.call(n,new Bd(this._firestore,t))})}isEqual(t){return Yl(this._delegate,t._delegate)}}class Gd extends jd{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var t=this._delegate.parent;return t?new Fd(this.firestore,t):null}doc(t){try{return void 0===t?new Fd(this.firestore,Wu(this._delegate)):new Fd(this.firestore,Wu(this._delegate,t))}catch(t){throw Pd(t,"doc()","CollectionReference.doc()")}}add(t){return function(t,e){const n=qu(t.firestore,sl),r=Wu(t),s=ud(t.converter,e);return Ed(n,[_l(Il(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,vi.exists(!1))]).then(()=>r)}(this._delegate,t).then(t=>new Fd(this.firestore,t))}isEqual(t){return Yu(this._delegate,t._delegate)}withConverter(t){return new Gd(this.firestore,t?this._delegate.withConverter(Md.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function Hd(t){return qu(t,Gu)}const zd={Firestore:kd,GeoPoint:pl,Timestamp:qr,Blob:Dd,Transaction:Ld,WriteBatch:Od,DocumentReference:Fd,DocumentSnapshot:qd,Query:jd,QueryDocumentSnapshot:Bd,QuerySnapshot:$d,CollectionReference:Gd,FieldPath:class Qd{constructor(...t){this._delegate=new fl(...t)}static documentId(){return new Qd(Qr.keyField().canonicalString())}isEqual(t){return(t=m(t))instanceof fl&&this._delegate._internalPath.isEqual(t._internalPath)}},FieldValue:class Wd{constructor(t){this._delegate=t}static serverTimestamp(){const t=new Al("serverTimestamp");return t._methodName="FieldValue.serverTimestamp",new Wd(t)}static delete(){const t=new Sl("deleteField");return t._methodName="FieldValue.delete",new Wd(t)}static arrayUnion(...t){const e=function(...t){return new Dl("arrayUnion",t)}(...t);return e._methodName="FieldValue.arrayUnion",new Wd(e)}static arrayRemove(...t){const e=function(...t){return new Cl("arrayRemove",t)}(...t);return e._methodName="FieldValue.arrayRemove",new Wd(e)}static increment(t){const e=new xl("increment",t);return e._methodName="FieldValue.increment",new Wd(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}},setLogLevel:function(t){t=t,vr.setLogLevel(t)},CACHE_SIZE_UNLIMITED:-1};nl=e.default,rl=(t,e)=>new kd(t,e,new xd),nl.INTERNAL.registerComponent(new i("firestore-compat",t=>{var e=t.getProvider("app-compat").getImmediate(),n=t.getProvider("firestore").getImmediate();return rl(e,n)},"PUBLIC").setServiceProps(Object.assign({},zd))),nl.registerVersion("@firebase/firestore-compat","0.1.5")}).apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
